<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: The general ParameterBlock interface</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('de/df8/_dev_man_parameters.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">The general ParameterBlock interface </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This page explains the details of the two utility classes <code>ParameterBlock</code> and <code>InputParameters</code>.</p>
<h1><a class="anchor" id="DevManParametersSec1"></a>
1 The general philosophy of Static Registration</h1>
<p >First, what is <b>Static Registration</b>? When a c++ program is executed there are a number of phases that occur in order. Once such phase, before entering the <code>main</code> function, is the phase in which all static variables are initialized. We shall call this phase the static initialization phase. In the most basic sense static registration is the process whereby we create a registry of object-constructors during this phase. This registry can then used, during the dynamic phases of the program, to construct objects. A simple example is the code below: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;DoSomethingFunctions&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> a = DoSomething();</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;The value of a is: &quot;</span> &lt;&lt; a &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p> where the variable <code>int a</code> is initialized, before the <code>main</code> function starts, using a function call, which happens during the static initialization phase of the program.</p>
<h2><a class="anchor" id="DevManParametersSec1_1"></a>
Rigging static initialization for object factories or object makers</h2>
<p >We can use the rather odd dynamics of singleton objects to create a static registry of function creation calls during static initialization. In the code below we define an <code>ObjectMaker</code> class that is a singleton. A singleton is an object of which only a single instance can be created, which we do by declaring a static instance, a bunch of static members methods, a private constructor and deleted copy- and move constructors.</p>
<p >The <code>ObjectMaker</code> maintains a map of string keys to object construction calls. The construction calls always return a pointer to a base class <code>Object</code> but can construct any child object by using the shown template arguments. In order for us to achieve basic static registration we need two templated-methods, these are <code>CallObjectConstructor</code> and <code>RegisterObject</code> in the code below. The first method defines a function-address that we can put into our registry. The second method is the actual method we call to make a registry entry. When we then want to make a registered object we simply call the <code>MakeRegisteredObject</code> method.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;functional&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Object</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keywordtype">int</span> member_;</div>
<div class="line">  Object() : member_(99) {}</div>
<div class="line">  Object(<span class="keywordtype">int</span> member) : member_(member) {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ChildObject : <span class="keyword">public</span> Object</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  ChildObject() : Object(999) {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">//===============================================</span></div>
<div class="line"><span class="keyword">typedef</span> std::function&lt;Object*()&gt; CreationFunction;</div>
<div class="line"><span class="keyword">class </span>ObjectMaker <span class="comment">// Singleton</span></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  std::map&lt;std::string, CreationFunction&gt; registry_;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> ObjectMaker&amp; GetInstance() noexcept</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">static</span> ObjectMaker singleton;</div>
<div class="line">    <span class="keywordflow">return</span> singleton;</div>
<div class="line">  }</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">  <span class="keyword">static</span> Object* CallObjectConstructor() { <span class="keywordflow">return</span> <span class="keyword">new</span> T(); }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">int</span> RegisterObject(<span class="keyword">const</span> std::string&amp; register_name)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">auto</span>&amp; instance = GetInstance();</div>
<div class="line">    instance.registry_.insert(</div>
<div class="line">      std::make_pair(register_name, &amp;CallObjectConstructor&lt;T&gt;));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">static</span> Object* MakeRegisteredObject(<span class="keyword">const</span> std::string&amp; obj_name)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">auto</span>&amp; instance = GetInstance();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> instance.registry_.at(obj_name)();</div>
<div class="line">  }</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  ObjectMaker() = <span class="keywordflow">default</span>;</div>
<div class="line">  ObjectMaker(<span class="keyword">const</span> ObjectMaker&amp;) = <span class="keyword">delete</span>;</div>
<div class="line">  ObjectMaker(<span class="keyword">const</span> ObjectMaker&amp;&amp;) = <span class="keyword">delete</span>;</div>
<div class="line">  ObjectMaker&amp; operator=(<span class="keyword">const</span> ObjectMaker&amp;) = <span class="keyword">delete</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">//===============================================</span></div>
<div class="line"><span class="comment">// This is where we statically register an object</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> abc12345 = ObjectMaker::RegisterObject&lt;Object&gt;(<span class="stringliteral">&quot;Parent&quot;</span>);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> abc12346 = ObjectMaker::RegisterObject&lt;ChildObject&gt;(<span class="stringliteral">&quot;Child&quot;</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  Object objectA(98); <span class="comment">// Conventional object creation</span></div>
<div class="line">  <span class="keyword">auto</span> objectB = ObjectMaker::MakeRegisteredObject(<span class="stringliteral">&quot;Parent&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> objectC = ObjectMaker::MakeRegisteredObject(<span class="stringliteral">&quot;Child&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Object A.member_ = &quot;</span> &lt;&lt; objectA.member_ &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Object B.member_ = &quot;</span> &lt;&lt; objectB-&gt;member_ &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Object C.member_ = &quot;</span> &lt;&lt; objectC-&gt;member_ &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> Output: </p><pre class="fragment">Object A.member_ = 98
Object B.member_ = 99
Object C.member_ = 999
</pre><p >Notice that we abuse the static initialization phase right above the <code>main</code> function. We call the static singleton <code>ObjectMaker</code> and <code>RegisterObject</code> to create registry entries for a <code>Parent</code> and a <code>Child</code>. In the main function we then construct some of these statically registered objects.</p>
<h2><a class="anchor" id="DevManParametersSec1_2"></a>
Implementation in ChiTech</h2>
<p >In ChiTech we have to, of course, enhance the functionality by a lot. Firstly, we ought not to use raw pointers, therefore we use shared pointers to a base class object for which we use the base class <code>ChiObject</code> for all objects that can be statically registered. Secondly, it is very rare for an object to be created with no parameters (i.e., empty constructors). We developed a separate system to control object construction parameters (more on this later). Additionally, we do not want developers to come up with unique dummy variable names, i.e., <code>static int abc12345</code> or <code>static int abc12346</code>, to make use of the <code>ChiObjectMaker</code>.</p>
<p >In order to register an object within the <code>ChiObjectMaker</code> we created a macro called <code>RegisterChiObject(namespace_name, obj_name)</code>. The arguments to this macro, <code>namespace_name</code> and <code>obj_name</code>, then get used to construct the following </p><div class="fragment"><div class="line">RegisterChiObject(namespace_name, ObjectName);</div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">// becomes:</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> unique_var_name_object_ObjectName_0 =</div>
<div class="line">  ChiObjectMaker::AddObjectToRegistry&lt;ObjectName, ChiObject&gt;(<span class="stringliteral">&quot;namespace_name&quot;</span>,</div>
<div class="line">                                                             <span class="stringliteral">&quot;ObjectName&quot;</span>)</div>
</div><!-- fragment --><p> which allows us to abuse static initialization to register the object with text-name <code>"namespace_name::ObjectName"</code>.</p>
<p >We also implemented a number of "tricks". For example we created a behind-the-scenes connection to the lua console so that registered objects can be created from the lua input system. We also created a "RegistryDump" where each registered object can dump its input arguments specification so we can use it to build documentation (lessening the burden on the developer).</p>
<h1><a class="anchor" id="DevManParametersSec2"></a>
2 The InputParameters system</h1>
<p >All statically registered objects have a common input parameters interface implemented in the general class <code>chi_objects::InputParameters</code>. This allows us to fully support static registration if an object has the following basic structure </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ChiObject/chi_object.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>zorba</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>CoolObject : <span class="keyword">public</span> ChiObject</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> a_;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> b_;</div>
<div class="line">  <span class="comment">//Misc. members</span></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">static</span> chi_objects::InputParameters GetInputParameters();</div>
<div class="line">  CoolObject(<span class="keyword">const</span> chi_objects::InputParameters&amp; params);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Misc. methods</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><p> Here we have the static member method <code>GetInputParameters</code> which returns a <code>chi_objects::InputParameters</code> object used to assign parameters from user input, and the constructor <code>CoolObject(const chi_objects::InputParameters&amp; params);</code> which uses such an object.</p>
<p >In the definition (<code>.cc</code>) file we then have </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;CoolObject.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ChiObject/object_maker.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>zorba</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">RegisterChiObject(chi_unit_tests, CoolObject);</div>
<div class="line"> </div>
<div class="line">chi_objects::InputParameters CoolObject::GetInputParameters()</div>
<div class="line">{</div>
<div class="line">  chi_objects::InputParameters params = ChiObject::GetInputParameters();</div>
<div class="line"> </div>
<div class="line">  params.AddRequiredParameter&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;a&quot;</span>, <span class="stringliteral">&quot;Coolness factor a&quot;</span>);</div>
<div class="line">  params.AddOptionalParameter(<span class="stringliteral">&quot;b&quot;</span>, 1.0, <span class="stringliteral">&quot;Coolness factor b&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> params;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">CoolObject::CoolObject(<span class="keyword">const</span> chi_objects::InputParameters&amp; params) :</div>
<div class="line">  ChiObject(params),</div>
<div class="line">  a_(params.GetParamValue&lt;int&gt;(<span class="stringliteral">&quot;a&quot;</span>)),</div>
<div class="line">  b_(params.GetParamValue&lt;double&gt;(<span class="stringliteral">&quot;b&quot;</span>))</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}<span class="comment">//namespace zorba</span></div>
</div><!-- fragment --><p >Creating this object from lua is then as easy as </p><div class="fragment"><div class="line">params = {a = 98, b = 99.0}</div>
<div class="line">cool_obj = zorba.CoolObject.Create(params)</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Chi-Tech</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
