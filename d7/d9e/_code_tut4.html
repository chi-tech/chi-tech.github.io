<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Coding Tutorial 4 - MMS for Poisson&#39;s problem with PWLC</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d7/d9e/_code_tut4.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Coding Tutorial 4 - MMS for Poisson's problem with PWLC </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Table of contents</h2>
<ul>
<li><a class="el" href="../../d7/d9e/_code_tut4.html#CodeTut4Sec1">1 Defining a wrapper to call a lua function</a></li>
<li><a class="el" href="../../d7/d9e/_code_tut4.html#CodeTut4Sec2">2 Lua functions</a></li>
<li><a class="el" href="../../d7/d9e/_code_tut4.html#CodeTut4Sec3">3 Getting guadrature-point real world XYZ</a></li>
<li><a class="el" href="../../d7/d9e/_code_tut4.html#CodeTut4Sec4">4 Convergence study</a></li>
<li><a class="el" href="../../d7/d9e/_code_tut4.html#CodeTut4SecX">The complete program</a></li>
</ul>
<h1><a class="anchor" id="CodeTut4Sec1"></a>
1 Defining a wrapper to call a lua function</h1>
<p >To implement a manufactured solution in our PWLC solver from <a class="el" href="../../d1/d74/_code_tut3.html">Coding Tutorial 3 - Poisson's problem with PWLC</a> we are required to call a lua-function with spatial coordinates x,y,z. In order to use the lua-console, specifically the lua state, we have to include the headers </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d6d/chi__console_8h.html">ChiConsole/chi_console.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ChiLua/chi_lua.h&quot;</span></div>
<div class="ttc" id="achi__console_8h_html"><div class="ttname"><a href="../../d2/d6d/chi__console_8h.html">chi_console.h</a></div></div>
</div><!-- fragment --><p >When then have to grab the console state from the runtime environment. To do this we add the following code, in the beginning of the program, just below <code><a class="el" href="../../d4/d35/classchi.html#ad2e614f7b9733c863908ce0eeb4480f1">chi::RunBatch</a></code> </p><div class="fragment"><div class="line"><span class="keyword">auto</span> L = <a class="code hl_variable" href="../../d4/d35/classchi.html#afaf99163b7a54f59d6372e94cfc32dea">chi::console</a>.consoleState;</div>
<div class="ttc" id="aclasschi_html_afaf99163b7a54f59d6372e94cfc32dea"><div class="ttname"><a href="../../d4/d35/classchi.html#afaf99163b7a54f59d6372e94cfc32dea">chi::console</a></div><div class="ttdeci">static chi_objects::ChiConsole &amp; console</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/db2/chi__runtime_8h_source.html#l00074">chi_runtime.h:74</a></div></div>
</div><!-- fragment --><p >Next we have to tell the c++ code exactly how to call a lua-function. To this end we define a wrapper using a c++ lambda as shown below. You can define this function where ever you like as long as it can capture the lua state, <code>L</code>. For this tutorial we defined it just before the matrix assembly. </p><div class="fragment"><div class="line"><span class="keyword">auto</span> CallLuaXYZFunction = [&amp;L](<span class="keyword">const</span> std::string&amp; lua_func_name,</div>
<div class="line">                               <span class="keyword">const</span> <a class="code hl_struct" href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a>&amp; xyz)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">//============= Load lua function</span></div>
<div class="line">  lua_getglobal(L, lua_func_name.c_str());</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============= Error check lua function</span></div>
<div class="line">  <span class="keywordflow">if</span> (not lua_isfunction(L, -1))</div>
<div class="line">    <span class="keywordflow">throw</span> std::logic_error(<span class="stringliteral">&quot;CallLuaXYZFunction attempted to access lua-function, &quot;</span> +</div>
<div class="line">                           lua_func_name + <span class="stringliteral">&quot;, but it seems the function&quot;</span></div>
<div class="line">                                           <span class="stringliteral">&quot; could not be retrieved.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============= Push arguments</span></div>
<div class="line">  lua_pushnumber(L, xyz.x);</div>
<div class="line">  lua_pushnumber(L, xyz.y);</div>
<div class="line">  lua_pushnumber(L, xyz.z);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============= Call lua function</span></div>
<div class="line">  <span class="comment">//3 arguments, 1 result (double), 0=original error object</span></div>
<div class="line">  <span class="keywordtype">double</span> lua_return = 0.0;</div>
<div class="line">  <span class="keywordflow">if</span> (lua_pcall(L,3,1,0) == 0)</div>
<div class="line">  {</div>
<div class="line">    LuaCheckNumberValue(<span class="stringliteral">&quot;CallLuaXYZFunction&quot;</span>, L, -1);</div>
<div class="line">    lua_return = lua_tonumber(L,-1);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">throw</span> std::logic_error(<span class="stringliteral">&quot;CallLuaXYZFunction attempted to call lua-function, &quot;</span> +</div>
<div class="line">                           lua_func_name + <span class="stringliteral">&quot;, but the call failed.&quot;</span> +</div>
<div class="line">                           xyz.PrintStr());</div>
<div class="line"> </div>
<div class="line">  lua_pop(L,1); <span class="comment">//pop the double, or error code</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> lua_return;</div>
<div class="line">};</div>
<div class="ttc" id="astructchi__mesh_1_1_vector3_html"><div class="ttname"><a href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7f/chi__meshvector_8h_source.html#l00018">chi_meshvector.h:19</a></div></div>
</div><!-- fragment --><p> Notice this function takes 2 arguments: a string value representing the lua function's name, and a <code><a class="el" href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a></code> indicating the real-word XYZ coordinates at which to evaluate the function.</p>
<p >In order to implement a manufactures solution we need a right-hand-side (RHS) function and an actual manufactured solution (MS) function. The RHS function will essentially steer the entire solution towards the manufactured solution. The evaluation of the actual manufactured solution is required in two places, i.e., in the implementation of Dirichlet boundary conditions, and when we compute the L2-norm of the error between our FEM-solution and the manufactured one.</p>
<h1><a class="anchor" id="CodeTut4Sec2"></a>
2 Lua functions</h1>
<p >The RHS function and the MS function both need to exist within the lua state. We therefore ad the following to the <code>mesh.lua</code> input file. </p><div class="fragment"><div class="line">function MMS_phi(x,y,z)</div>
<div class="line">    <span class="keywordflow">return</span> math.cos(math.pi*x) + math.cos(math.pi*y)</div>
<div class="line">end</div>
<div class="line">function MMS_q(x,y,z)</div>
<div class="line">    <span class="keywordflow">return</span> math.pi*math.pi * (math.cos(math.pi*x)+math.cos(math.pi*y))</div>
<div class="line">end</div>
</div><!-- fragment --><p> The function <code>MMS_phi</code> is the MS function and the function <code>MMS_q</code> is the RHS function. These functions can be defined anywhere in the input file as long as they are available in the state when solver needs them.</p>
<h1><a class="anchor" id="CodeTut4Sec3"></a>
3 Getting guadrature-point real world XYZ</h1>
<p >Quadrautre-point real-world positions are stored when the <code>qp_data</code> structure is created. They are accessed with the call <code><a class="el" href="../../d5/da1/classchi__math_1_1finite__element_1_1_internal_quadrature_point_data.html#ad9935574d332f19a9863886d1f2079ca">chi_math::finite_element::InternalQuadraturePointData::QPointXYZ</a></code>, taking the quadrature point index as a parameter. </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> qp : qp_data.QuadraturePointIndices())</div>
<div class="line">  cell_rhs[i] += CallLuaXYZFunction(qp_data.QPointXYZ(qp),<span class="stringliteral">&quot;MMS_q&quot;</span>, L) *</div>
<div class="line">                 qp_data.ShapeValue(i, qp) * qp_data.JxW(qp);</div>
</div><!-- fragment --><h1><a class="anchor" id="CodeTut4Sec4"></a>
4 Convergence study</h1>
<p >The Method of Manufactured Solution (MMS) is often used to verify the rate of convergence of computational methods. In order to determine magnitude of the error of the FEM solution, \( \phi_{FEM} \), compared to the MS, \( \phi_{MMS} \), we need to evaluate the following norm </p><p class="formulaDsp">
\[ ||e||_2 = \sqrt{\int_V \biggr( \phi_{MMS}(\mathbf{x}) - \phi_{FEM}(\mathbf{x})\biggr)^2 dV} \]
</p>
<p> We again here use the quadrature rules to obtain this integral as </p><p class="formulaDsp">
\[ \int_V \biggr( \phi_{MMS}(\mathbf{x}) - \phi_{FEM}(\mathbf{x})\biggr)^2 dV = \sum_c \sum_n^{N_V} w_n \biggr( \phi_{MMS}(\mathbf{x}_n) - \phi_{FEM}(\tilde{\mathbf{x}}_n)\biggr)^2 \ | J(\tilde{\mathbf{x}}_n | \]
</p>
<p> for which we use the code </p><div class="fragment"><div class="line"><span class="comment">//============================================= Compute error</span></div>
<div class="line"><span class="comment">//First get ghosted values</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> field_wg = ff-&gt;GetGhostedFieldVector();</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> local_error = 0.0;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> qp_data = cell_mapping.MakeVolumeQuadraturePointData();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//======================= Grab nodal phi values</span></div>
<div class="line">  std::vector&lt;double&gt; nodal_phi(num_nodes,0.0);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j &lt; num_nodes; ++j)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> int64_t imap = sdm.MapDOFLocal(cell, j);</div>
<div class="line">    nodal_phi[j] = field_wg[imap];</div>
<div class="line">  }<span class="comment">//for j</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">//======================= Quadrature loop</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> qp : qp_data.QuadraturePointIndices())</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">double</span> phi_fem = 0.0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j &lt; num_nodes; ++j)</div>
<div class="line">      phi_fem += nodal_phi[j] * qp_data.ShapeValue(j, qp);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> phi_true = CallLuaXYZFunction(<span class="stringliteral">&quot;MMS_phi&quot;</span>,qp_data.QPointXYZ(qp));</div>
<div class="line"> </div>
<div class="line">    local_error += std::pow(phi_true - phi_fem,2.0) * qp_data.JxW(qp);</div>
<div class="line">  }</div>
<div class="line">}<span class="comment">//for cell</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> global_error = 0.0;</div>
<div class="line">MPI_Allreduce(&amp;local_error,     <span class="comment">//sendbuf</span></div>
<div class="line">              &amp;global_error,    <span class="comment">//recvbuf</span></div>
<div class="line">              1, MPI_DOUBLE,    <span class="comment">//count+datatype</span></div>
<div class="line">              MPI_SUM,          <span class="comment">//operation</span></div>
<div class="line">              MPI_COMM_WORLD);  <span class="comment">//communicator</span></div>
<div class="line"> </div>
<div class="line">global_error = std::sqrt(global_error);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Error: &quot;</span> &lt;&lt; std::scientific &lt;&lt; global_error</div>
<div class="line">               &lt;&lt; <span class="stringliteral">&quot; Num-cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="ttc" id="aclasschi__objects_1_1_chi_log_html_abed9782beaeca9b7e5f08c1faa8f28a1"><div class="ttname"><a href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">chi_objects::ChiLog::Log</a></div><div class="ttdeci">LogStream Log(LOG_LVL level=LOG_0)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d1c/chi__log_8cc_source.html#l00036">chi_log.cc:36</a></div></div>
<div class="ttc" id="aclasschi_html_a2dedda8a44a89f39b4038becaa9f304a"><div class="ttname"><a href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a></div><div class="ttdeci">static chi_objects::ChiLog &amp; log</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/db2/chi__runtime_8h_source.html#l00075">chi_runtime.h:75</a></div></div>
</div><!-- fragment --><p> Notice that we grab the nodal values of \( \phi_{FEM} \) before we loop over quadrature points. We then use these nodal values within the quadrature-point loop to construct \( \phi_{FEM}(\tilde{\mathbf{x}}_n) \) as </p><p class="formulaDsp">
\[ \phi_{FEM}(\tilde{\mathbf{x}}_n) = \sum_j \phi_j b_j(\tilde{\mathbf{x}}_n) \]
</p>
<p> with the code </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j &lt; num_nodes; ++j)</div>
<div class="line">  phi_fem += nodal_phi[j] * qp_data.ShapeValue(j, qp);</div>
</div><!-- fragment --><p >Notice also that we first have to compute a local error, from the cells that are on the local partition. This is then followed by an <code>MPI_Allreduce</code>, with the <code>MPI_SUM</code> operation, to gather all the local error values into a single global error value. This is done via the code </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> global_error = 0.0;</div>
<div class="line">MPI_Allreduce(&amp;local_error,     <span class="comment">//sendbuf</span></div>
<div class="line">              &amp;global_error,    <span class="comment">//recvbuf</span></div>
<div class="line">              1, MPI_DOUBLE,    <span class="comment">//count+datatype</span></div>
<div class="line">              MPI_SUM,          <span class="comment">//operation</span></div>
<div class="line">              MPI_COMM_WORLD);  <span class="comment">//communicator</span></div>
<div class="line"> </div>
<div class="line">global_error = std::sqrt(global_error);</div>
</div><!-- fragment --><p >With this code in-place we can run the program several times with a different amount of cells, which provides us with the data below:</p>
<div class="image">
<img src="../../Tut4_OrderOfConv.png" alt="" width="700px"/>
</div>
<h1><a class="anchor" id="CodeTut4SecX"></a>
The complete program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d98/chi__meshhandler_8h.html">ChiMesh/MeshHandler/chi_meshhandler.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/dfa/pwlc_8h.html">ChiMath/SpatialDiscretization/FiniteElement/PiecewiseLinear/pwlc.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../da/d0e/petsc__utils_8h.html">ChiMath/PETScUtils/petsc_utils.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ChiPhysics/FieldFunction/fieldfunction2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d6d/chi__console_8h.html">ChiConsole/chi_console.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ChiLua/chi_lua.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_function" href="../../d4/d35/classchi.html#a4e6b239c3512a82a18bb114f84bf22e8">chi::Initialize</a>(argc,argv);</div>
<div class="line">  <a class="code hl_function" href="../../d4/d35/classchi.html#ad2e614f7b9733c863908ce0eeb4480f1">chi::RunBatch</a>(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Coding Tutorial 4&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Get grid</span></div>
<div class="line">  <span class="keyword">auto</span> grid_ptr = <a class="code hl_function" href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a>().<a class="code hl_function" href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">GetGrid</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; grid = *grid_ptr;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Global num cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make SDM</span></div>
<div class="line">  <span class="keyword">typedef</span> std::shared_ptr&lt;chi_math::SpatialDiscretization&gt; <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a>;</div>
<div class="line">  <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a> sdm_ptr = <a class="code hl_function" href="../../d4/da5/classchi__math_1_1_spatial_discretization___p_w_l_c.html#ac5c32d8c870a1b456c9b7486dc581276">chi_math::SpatialDiscretization_PWLC::New</a>(grid_ptr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; sdm = *sdm_ptr;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; OneDofPerNode = sdm.UNITARY_UNKNOWN_MANAGER;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_dofs = sdm.GetNumLocalDOFs(OneDofPerNode);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_globl_dofs = sdm.GetNumGlobalDOFs(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Num local DOFs: &quot;</span> &lt;&lt; num_local_dofs;</div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Num globl DOFs: &quot;</span> &lt;&lt; num_globl_dofs;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Initializes Mats and Vecs</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> n = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_local_dofs);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> N = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_globl_dofs);</div>
<div class="line">  Mat A;</div>
<div class="line">  Vec x,b;</div>
<div class="line"> </div>
<div class="line">  A = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a>(n,N);</div>
<div class="line">  x = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line">  b = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;int64_t&gt; nodal_nnz_in_diag;</div>
<div class="line">  std::vector&lt;int64_t&gt; nodal_nnz_off_diag;</div>
<div class="line">  sdm.BuildSparsityPattern(nodal_nnz_in_diag,nodal_nnz_off_diag, OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a>(A,</div>
<div class="line">                                           nodal_nnz_in_diag,</div>
<div class="line">                                           nodal_nnz_off_diag);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Source lambda</span></div>
<div class="line">  <span class="keyword">auto</span> CallLuaXYZFunction = [&amp;L](<span class="keyword">const</span> std::string&amp; lua_func_name,</div>
<div class="line">                                 <span class="keyword">const</span> <a class="code hl_struct" href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a>&amp; xyz)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">//============= Load lua function</span></div>
<div class="line">    lua_getglobal(L, lua_func_name.c_str());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//============= Error check lua function</span></div>
<div class="line">    <span class="keywordflow">if</span> (not lua_isfunction(L, -1))</div>
<div class="line">      <span class="keywordflow">throw</span> std::logic_error(<span class="stringliteral">&quot;CallLuaXYZFunction attempted to access lua-function, &quot;</span> +</div>
<div class="line">                             lua_func_name + <span class="stringliteral">&quot;, but it seems the function&quot;</span></div>
<div class="line">                                             <span class="stringliteral">&quot; could not be retrieved.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//============= Push arguments</span></div>
<div class="line">    lua_pushnumber(L, xyz.x);</div>
<div class="line">    lua_pushnumber(L, xyz.y);</div>
<div class="line">    lua_pushnumber(L, xyz.z);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//============= Call lua function</span></div>
<div class="line">    <span class="comment">//3 arguments, 1 result (double), 0=original error object</span></div>
<div class="line">    <span class="keywordtype">double</span> lua_return = 0.0;</div>
<div class="line">    <span class="keywordflow">if</span> (lua_pcall(L,3,1,0) == 0)</div>
<div class="line">    {</div>
<div class="line">      LuaCheckNumberValue(<span class="stringliteral">&quot;CallLuaXYZFunction&quot;</span>, L, -1);</div>
<div class="line">      lua_return = lua_tonumber(L,-1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">throw</span> std::logic_error(<span class="stringliteral">&quot;CallLuaXYZFunction attempted to call lua-function, &quot;</span> +</div>
<div class="line">                             lua_func_name + <span class="stringliteral">&quot;, but the call failed.&quot;</span> +</div>
<div class="line">                             xyz.PrintStr());</div>
<div class="line"> </div>
<div class="line">    lua_pop(L,1); <span class="comment">//pop the double, or error code</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> lua_return;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Assemble the system</span></div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Assembling system: &quot;</span>;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>  qp_data      = cell_mapping.MakeVolumeQuadraturePointData();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>  cell_node_xyzs = cell_mapping.GetNodeLocations();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line">    <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a> Acell(num_nodes, <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a>(num_nodes, 0.0));</div>
<div class="line">    <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a> cell_rhs(num_nodes, 0.0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j&lt;num_nodes; ++j)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> entry_aij = 0.0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> qp : qp_data.QuadraturePointIndices())</div>
<div class="line">        {</div>
<div class="line">          entry_aij +=</div>
<div class="line">            qp_data.ShapeGrad(i, qp).Dot(qp_data.ShapeGrad(j, qp)) *</div>
<div class="line">            qp_data.JxW(qp);</div>
<div class="line">        }<span class="comment">//for qp</span></div>
<div class="line">        Acell[i][j] = entry_aij;</div>
<div class="line">      }<span class="comment">//for j</span></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> qp : qp_data.QuadraturePointIndices())</div>
<div class="line">        cell_rhs[i] += CallLuaXYZFunction(<span class="stringliteral">&quot;MMS_q&quot;</span>,qp_data.QPointXYZ(qp)) *</div>
<div class="line">                       qp_data.ShapeValue(i, qp) * qp_data.JxW(qp);</div>
<div class="line">    }<span class="comment">//for i</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//======================= Flag nodes for being on dirichlet boundary</span></div>
<div class="line">    std::vector&lt;bool&gt; node_boundary_flag(num_nodes, <span class="keyword">false</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_faces = cell.faces.size();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> f=0; f&lt;num_faces; ++f)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; face = cell.faces[f];</div>
<div class="line">      <span class="keywordflow">if</span> (face.has_neighbor) <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_face_nodes = face.vertex_ids.size();</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> fi=0; fi&lt;num_face_nodes; ++fi)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> uint i = cell_mapping.MapFaceNode(f,fi);</div>
<div class="line">        node_boundary_flag[i] = <span class="keyword">true</span>;</div>
<div class="line">      }<span class="comment">//for fi</span></div>
<div class="line">    }<span class="comment">//for face f</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//======================= Develop node mapping</span></div>
<div class="line">    std::vector&lt;int64_t&gt; imap(num_nodes, 0); <span class="comment">//node-mapping</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">      imap[i] = sdm.MapDOF(cell, i);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//======================= Assembly into system</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (node_boundary_flag[i]) <span class="comment">//if dirichlet node</span></div>
<div class="line">      {</div>
<div class="line">        MatSetValue(A, imap[i], imap[i], 1.0, ADD_VALUES);</div>
<div class="line">        <span class="keywordtype">double</span> bval = CallLuaXYZFunction(<span class="stringliteral">&quot;MMS_phi&quot;</span>,cell_node_xyzs[i]);</div>
<div class="line">        VecSetValue(b, imap[i], bval, ADD_VALUES);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j&lt;num_nodes; ++j)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (not node_boundary_flag[j])</div>
<div class="line">            MatSetValue(A, imap[i], imap[j], Acell[i][j], ADD_VALUES);</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            <span class="keywordtype">double</span> bval = CallLuaXYZFunction(<span class="stringliteral">&quot;MMS_phi&quot;</span>,cell_node_xyzs[j]);</div>
<div class="line">            VecSetValue(b, imap[i], -Acell[i][j]*bval, ADD_VALUES);</div>
<div class="line">          }</div>
<div class="line">        }<span class="comment">//for j</span></div>
<div class="line">        VecSetValue(b, imap[i], cell_rhs[i], ADD_VALUES);</div>
<div class="line">      }</div>
<div class="line">    }<span class="comment">//for i</span></div>
<div class="line">  }<span class="comment">//for cell</span></div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  MatAssemblyBegin(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">  MatAssemblyEnd(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">  VecAssemblyBegin(b);</div>
<div class="line">  VecAssemblyEnd(b);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Done global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Krylov Solver</span></div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Solving: &quot;</span>;</div>
<div class="line">  <span class="keyword">auto</span> petsc_solver =</div>
<div class="line">    <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a>(</div>
<div class="line">      A,               <span class="comment">//Matrix</span></div>
<div class="line">      <span class="stringliteral">&quot;PWLCDiffSolver&quot;</span>,  <span class="comment">//Solver name</span></div>
<div class="line">      KSPCG,           <span class="comment">//Solver type</span></div>
<div class="line">      PCGAMG,          <span class="comment">//Preconditioner type</span></div>
<div class="line">      1.0e-6,          <span class="comment">//Relative residual tolerance</span></div>
<div class="line">      1000);            <span class="comment">//Max iterations</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Solve</span></div>
<div class="line">  KSPSolve(petsc_solver.ksp,b,x);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Done solving&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Extract PETSc vector</span></div>
<div class="line">  std::vector&lt;double&gt; field;</div>
<div class="line">  sdm.LocalizePETScVector(x,field,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Clean up</span></div>
<div class="line">  KSPDestroy(&amp;petsc_solver.ksp);</div>
<div class="line"> </div>
<div class="line">  VecDestroy(&amp;x);</div>
<div class="line">  VecDestroy(&amp;b);</div>
<div class="line">  MatDestroy(&amp;A);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Done cleanup&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Field Function</span></div>
<div class="line">  <span class="keyword">auto</span> ff = std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;Phi&quot;</span>,                                           <span class="comment">//Text name</span></div>
<div class="line">    sdm_ptr,                                         <span class="comment">//Spatial Discr.</span></div>
<div class="line">    <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a>) <span class="comment">//Unknown</span></div>
<div class="line">  );</div>
<div class="line"> </div>
<div class="line">  ff-&gt;UpdateFieldVector(field);</div>
<div class="line"> </div>
<div class="line">  ff-&gt;ExportToVTK(<span class="stringliteral">&quot;CodeTut4_PWLC&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Compute error</span></div>
<div class="line">  <span class="comment">//First get ghosted values</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> field_wg = ff-&gt;GetGhostedFieldVector();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> local_error = 0.0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> qp_data = cell_mapping.MakeVolumeQuadraturePointData();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//======================= Grab nodal phi values</span></div>
<div class="line">    std::vector&lt;double&gt; nodal_phi(num_nodes,0.0);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j &lt; num_nodes; ++j)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> int64_t jmap = sdm.MapDOFLocal(cell, j);</div>
<div class="line">      nodal_phi[j] = field_wg[jmap];</div>
<div class="line">    }<span class="comment">//for j</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//======================= Quadrature loop</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> qp : qp_data.QuadraturePointIndices())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> phi_fem = 0.0;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j &lt; num_nodes; ++j)</div>
<div class="line">        phi_fem += nodal_phi[j] * qp_data.ShapeValue(j, qp);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> phi_true = CallLuaXYZFunction(<span class="stringliteral">&quot;MMS_phi&quot;</span>,qp_data.QPointXYZ(qp));</div>
<div class="line"> </div>
<div class="line">      local_error += std::pow(phi_true - phi_fem,2.0) * qp_data.JxW(qp);</div>
<div class="line">    }</div>
<div class="line">  }<span class="comment">//for cell</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> global_error = 0.0;</div>
<div class="line">  MPI_Allreduce(&amp;local_error,     <span class="comment">//sendbuf</span></div>
<div class="line">                &amp;global_error,    <span class="comment">//recvbuf</span></div>
<div class="line">                1, MPI_DOUBLE,    <span class="comment">//count+datatype</span></div>
<div class="line">                MPI_SUM,          <span class="comment">//operation</span></div>
<div class="line">                MPI_COMM_WORLD);  <span class="comment">//communicator</span></div>
<div class="line"> </div>
<div class="line">  global_error = std::sqrt(global_error);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Error: &quot;</span> &lt;&lt; std::scientific &lt;&lt; global_error</div>
<div class="line">                 &lt;&lt; <span class="stringliteral">&quot; Num-cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="../../d4/d35/classchi.html#a88720f743f80818b08e68716233d9051">chi::Finalize</a>();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="achi__log_8h_html"><div class="ttname"><a href="../../dc/d75/chi__log_8h.html">chi_log.h</a></div></div>
<div class="ttc" id="achi__math_8h_html_a80801c4491f8f4ff54ed012d63d0d48b"><div class="ttname"><a href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a></div><div class="ttdeci">std::vector&lt; VecDbl &gt; MatDbl</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d08/chi__math_8h_source.html#l00013">chi_math.h:13</a></div></div>
<div class="ttc" id="achi__math_8h_html_acbe69520b2db91355c5ed8d97a218b94"><div class="ttname"><a href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a></div><div class="ttdeci">std::vector&lt; double &gt; VecDbl</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d08/chi__math_8h_source.html#l00012">chi_math.h:12</a></div></div>
<div class="ttc" id="achi__meshhandler_8h_html"><div class="ttname"><a href="../../df/d98/chi__meshhandler_8h.html">chi_meshhandler.h</a></div></div>
<div class="ttc" id="achi__runtime_8h_html"><div class="ttname"><a href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a></div></div>
<div class="ttc" id="achi__tech__main_8cc_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dca/chi__tech__main_8cc_source.html#l00010">chi_tech_main.cc:10</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_spatial_discretization___p_w_l_c_html_ac5c32d8c870a1b456c9b7486dc581276"><div class="ttname"><a href="../../d4/da5/classchi__math_1_1_spatial_discretization___p_w_l_c.html#ac5c32d8c870a1b456c9b7486dc581276">chi_math::SpatialDiscretization_PWLC::New</a></div><div class="ttdeci">static std::shared_ptr&lt; SpatialDiscretization_PWLC &gt; New(const chi_mesh::MeshContinuum &amp;in_grid, finite_element::SetupFlags setup_flags=finite_element::NO_FLAGS_SET, QuadratureOrder qorder=QuadratureOrder::SECOND, CoordinateSystemType in_cs_type=CoordinateSystemType::CARTESIAN)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/da8/pwlc__00__constrdestr_8cc_source.html#l00085">pwlc_00_constrdestr.cc:85</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_unknown_html"><div class="ttname"><a href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3b/unknown__manager_8h_source.html#l00031">unknown_manager.h:32</a></div></div>
<div class="ttc" id="aclasschi__mesh_1_1_mesh_handler_html_aa87887c1a76634cb07134b5faa1e3587"><div class="ttname"><a href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">chi_mesh::MeshHandler::GetGrid</a></div><div class="ttdeci">chi_mesh::MeshContinuumPtr &amp; GetGrid() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d65/chi__meshhandler_8cc_source.html#l00012">chi_meshhandler.cc:12</a></div></div>
<div class="ttc" id="aclasschi_html_a4e6b239c3512a82a18bb114f84bf22e8"><div class="ttname"><a href="../../d4/d35/classchi.html#a4e6b239c3512a82a18bb114f84bf22e8">chi::Initialize</a></div><div class="ttdeci">static int Initialize(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd3/chi__runtime_8cc_source.html#l00168">chi_runtime.cc:168</a></div></div>
<div class="ttc" id="aclasschi_html_a88720f743f80818b08e68716233d9051"><div class="ttname"><a href="../../d4/d35/classchi.html#a88720f743f80818b08e68716233d9051">chi::Finalize</a></div><div class="ttdeci">static void Finalize()</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd3/chi__runtime_8cc_source.html#l00211">chi_runtime.cc:211</a></div></div>
<div class="ttc" id="aclasschi_html_ad2e614f7b9733c863908ce0eeb4480f1"><div class="ttname"><a href="../../d4/d35/classchi.html#ad2e614f7b9733c863908ce0eeb4480f1">chi::RunBatch</a></div><div class="ttdeci">static int RunBatch(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd3/chi__runtime_8cc_source.html#l00276">chi_runtime.cc:276</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_a1baca8287da5a48e6d56ba3da4c39bab"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a></div><div class="ttdeci">void InitMatrixSparsity(Mat &amp;A, const std::vector&lt; int64_t &gt; &amp;nodal_nnz_in_diag, const std::vector&lt; int64_t &gt; &amp;nodal_nnz_off_diag)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d70/petsc__utils__02__create_mat_8cc_source.html#l00084">petsc_utils_02_createMat.cc:84</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ab59d60d5f5daa3929e3669acdcce1b39"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a></div><div class="ttdeci">PETScSolverSetup CreateCommonKrylovSolverSetup(Mat ref_matrix, const std::string &amp;in_solver_name=&quot;KSPSolver&quot;, const std::string &amp;in_solver_type=KSPGMRES, const std::string &amp;in_preconditioner_type=PCNONE, double in_relative_residual_tolerance=1.0e-6, int64_t in_maximum_iterations=100)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/da1/petsc__utils__03__create_k_s_p_8cc_source.html#l00035">petsc_utils_03_createKSP.cc:35</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ad3c389879eeafb68d9b7540887b883cd"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a></div><div class="ttdeci">Mat CreateSquareMatrix(int64_t local_size, int64_t global_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d70/petsc__utils__02__create_mat_8cc_source.html#l00025">petsc_utils_02_createMat.cc:25</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ae2ebedf1cd0712f3d6e0b2047c389949"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a></div><div class="ttdeci">Vec CreateVector(int64_t local_size, int64_t global_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/petsc__utils__01__create_vec_8cc_source.html#l00018">petsc_utils_01_createVec.cc:19</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ab6754b3179f7dbf965932210273fead7"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">chi_math::SDMPtr</a></div><div class="ttdeci">std::shared_ptr&lt; SpatialDiscretization &gt; SDMPtr</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/df1/cfem__diffusion__solver_8h_source.html#l00025">cfem_diffusion_solver.h:24</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a></div><div class="ttdeci">@ SCALAR</div></div>
<div class="ttc" id="anamespacechi__mesh_html_addcd6899961d4c527b02c33708a7941f"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a></div><div class="ttdeci">MeshHandler &amp; GetCurrentHandler()</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d4b/chi__mesh__meshhandler__utils_8cc_source.html#l00013">chi_mesh_meshhandler_utils.cc:13</a></div></div>
<div class="ttc" id="apetsc__utils_8h_html"><div class="ttname"><a href="../../da/d0e/petsc__utils_8h.html">petsc_utils.h</a></div></div>
<div class="ttc" id="apwlc_8h_html"><div class="ttname"><a href="../../d3/dfa/pwlc_8h.html">pwlc.h</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Chi-Tech</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
