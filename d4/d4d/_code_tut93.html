<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Coding Tutorial 93 - Ray-tracing for uncollided flux using random rays.</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d4/d4d/_code_tut93.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Coding Tutorial 93 - Ray-tracing for uncollided flux using random rays. </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Table of Contents</h2>
<ul>
<li><a class="el" href="../../d4/d4d/_code_tut93.html#CodeTut93Sec1">1 Introduction</a></li>
</ul>
<h1><a class="anchor" id="CodeTut93Sec1"></a>
1 Introduction</h1>
<p >Monte Carlo based flux estimators traditionally use a number of tracks, traced within a volume, to estimate the scalar flux. For <img class="formulaInl" alt="$ N_t $" src="../../form_363.png" width="17" height="15"/> amount of tracks traced inside a volume, <img class="formulaInl" alt="$ V $" src="../../form_364.png" width="12" height="12"/>, originating from a sample of <img class="formulaInl" alt="$ N_p $" src="../../form_365.png" width="18" height="17"/> number of particles/rays, the scalar flux, <img class="formulaInl" alt="$ \phi $" src="../../form_19.png" width="9" height="15"/>, can be estimated with </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \phi \approx \frac{1}{N_p V} \sum_t^{N_t} \ell_t, \]" src="../../form_369.png" width="107" height="45"/>
</p>
<p> where <img class="formulaInl" alt="$ \ell_t $" src="../../form_370.png" width="12" height="15"/> is the <img class="formulaInl" alt="$ t $" src="../../form_371.png" width="6" height="11"/>-th track length. This simply means that the scalar flux is the "average track length per unit volume".</p>
<p >The individual tracks of these particles can be assigned a weight, <img class="formulaInl" alt="$ w_t $" src="../../form_372.png" width="17" height="11"/>, enabling a multitude of features. </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \phi \approx \frac{1}{N_p V} \sum_t^{N_t} \ell_t w_t, \]" src="../../form_373.png" width="122" height="45"/>
</p>
<p> For our purposes we are interested in three possible weightings, i) weighting by a spherical harmonic, which can be used to compute flux moments, ii) weighting by average FE shape function values, allowing the projection of flux onto a FE space, and finally iii) weighting with an exponential attenuation, allowing the computation of uncollided flux.</p>
<h2><a class="anchor" id="CodeTut93Sec1_1"></a>
1.1 Weighting with a spherical harmonic</h2>
<p >Applying a weight with a spherical harmonic is conceptually simple. For the <img class="formulaInl" alt="$ t $" src="../../form_371.png" width="6" height="11"/>-th track we simply set the weight to the spherical harmonic evaluated with the direction, <img class="formulaInl" alt="$ \boldsymbol{\Omega}_t $" src="../../form_374.png" width="17" height="15"/>, of the track, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \phi_{\ell m} \approx \frac{1}{N_p V} \sum_t^{N_t} \ell_t Y_{\ell m}( \boldsymbol{\Omega}_t), \]" src="../../form_376.png" width="176" height="45"/>
</p>
<h2><a class="anchor" id="CodeTut93Sec1_2"></a>
1.2 Weighting by average FE shape function values</h2>
<p >For a DFEM projection of the fluxes we require nodal values, on each cell, for a given flux quantity, <img class="formulaInl" alt="$ \phi $" src="../../form_19.png" width="9" height="15"/>. Therefore we seek <img class="formulaInl" alt="$ \phi_h $" src="../../form_377.png" width="15" height="15"/> such that </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \int_V b_i \phi_h dV = \int_V b_i \phi dV \end{eqnarray*}" src="../../form_378.png" width="150" height="36"/>
</p>
<p> and since <img class="formulaInl" alt="$ \phi_h = \sum_j b_j \phi_j $" src="../../form_379.png" width="87" height="20"/> we need to solve the cell-by-cell system defined by </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \sum_j \phi_j \int_V b_i b_j dV = \int_V b_i \phi dV. \end{eqnarray*}" src="../../form_381.png" width="189" height="42"/>
</p>
<p> In this system the entries <img class="formulaInl" alt="$ \int_V b_i b_j dV $" src="../../form_382.png" width="63" height="20"/> are simply the entries of the mass matrix, <img class="formulaInl" alt="$ M_{ij} = \int_V b_i b_j dV $" src="../../form_383.png" width="108" height="20"/>, and we still need to find the rhs-entries <img class="formulaInl" alt="$ \int_V b_i \phi dV $" src="../../form_384.png" width="60" height="20"/>. This is where we will use the track length estimators by weighting with the shape functions b_i.</p>
<p >In this formulation we have </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \int_V b_i \phi dV \approx \frac{1}{N_p} \sum_t \ell_t w_t^{i,avg} \end{eqnarray*}" src="../../form_400.png" width="179" height="39"/>
</p>
<p> where </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_t^{i,avg} = \frac{ \int_{s_a}^{s_b} b_i(s\mapsto \mathbf{x}) ds } {\int_{s_a}^{s_b} ds} = \frac{ \int_{s_a}^{s_b} b_i(s\mapsto \mathbf{x}) ds } {\ell_t}, \]" src="../../form_411.png" width="293" height="45"/>
</p>
<p> the average basis function value along the track. For ordinary Lagrange FE shape functions, which are not defined piecewise, the integral in the numerator can be obtained exactly using a numerical quadrature. For our applications, where we use the PWLD FE shape functions we need to split this integral per segment of the basic cell crossed.</p>
<p >For example, consider the polygon below, where a ray is traced from position <img class="formulaInl" alt="$ s_a $" src="../../form_419.png" width="14" height="11"/> to <img class="formulaInl" alt="$ s_b $" src="../../form_420.png" width="12" height="11"/>. </p><div class="image">
<img src="../../Tut93_segments.png" alt="" width="350px"/>
</div>
<p >The track traced across the cell needs to split into the segments defined by the sub-triangles of the polygon it crossed. Therefore the track <img class="formulaInl" alt="$ s_a \to s_b $" src="../../form_412.png" width="50" height="12"/> needs to be split into tracks <img class="formulaInl" alt="$ s_0 \to s_1 $" src="../../form_391.png" width="50" height="12"/>, <img class="formulaInl" alt="$ s_1 \to s_2 $" src="../../form_392.png" width="50" height="12"/> and <img class="formulaInl" alt="$ s_2 \to s_3 $" src="../../form_393.png" width="50" height="12"/> as per the figure. Therefore the integral becomes</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \int_{s_a}^{s_b} b_i(s\mapsto \mathbf{x}) ds = \int_{s_0}^{s_1} b_i(s\mapsto \mathbf{x}) ds + \int_{s_1}^{s_2} b_i(s\mapsto \mathbf{x}) ds + \int_{s_2}^{s_3} b_i(s\mapsto \mathbf{x}) ds \]" src="../../form_413.png" width="483" height="39"/>
</p>
<p> which we can evaluate analytically since it is linear on each segment.</p>
<p >Note:** The mapping of <img class="formulaInl" alt="$ s\mapsto \mathbf{x} $" src="../../form_395.png" width="39" height="9"/> can be quite expensive so in this particular case it would be better to evaluate the shape function at the half-way point of each segment, after which the integral becomes </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \int_{s_a}^{s_b} b_i(s\mapsto \mathbf{x}) ds = b_i(\frac{s_0 + s_1}{2}\mapsto \mathbf{x}) (s_1 - s_0) + b_i(\frac{s_1 + s_2}{2}\mapsto \mathbf{x}) (s_2 - s_1) + b_i(\frac{s_2 + s_3}{2}\mapsto \mathbf{x}) (s_3 - s_2) + \]" src="../../form_414.png" width="627" height="38"/>
</p>
<h2><a class="anchor" id="CodeTut93Sec1_3"></a>
1.3 Weighting with an exponential attenuation</h2>
<p >Weighting with an exponential attenuation adds the final piece of weighting necessary to efficiently compute the uncollided flux.</p>
<p >The exponential attenuation of the uncollided flux, <img class="formulaInl" alt="$ \psi $" src="../../form_336.png" width="12" height="15"/>, along the path of a ray with direction <img class="formulaInl" alt="$ \boldsymbol{\Omega} $" src="../../form_359.png" width="12" height="12"/> is expressed as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{d\psi}{ds} = -\sigma_t(s) \psi(s) \]" src="../../form_367.png" width="113" height="33"/>
</p>
<p> where <img class="formulaInl" alt="$ s $" src="../../form_357.png" width="6" height="8"/> is the distance traveled and <img class="formulaInl" alt="$ \sigma_t $" src="../../form_361.png" width="12" height="11"/> is the total cross section. From this model we can compute the attenuation across a cell, with constant <img class="formulaInl" alt="$ \sigma_t $" src="../../form_361.png" width="12" height="11"/>, as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \psi(s) = \psi(s=0) e^{-\sigma_t s} \]" src="../../form_415.png" width="140" height="17"/>
</p>
<p> where <img class="formulaInl" alt="$ \psi(s=0) $" src="../../form_416.png" width="57" height="17"/> is the value of <img class="formulaInl" alt="$ \psi $" src="../../form_336.png" width="12" height="15"/> when it entered the cell.</p>
<p >To assimilate all of this into a raytracing algorithm we start a source particle with a weight, <img class="formulaInl" alt="$ w^p = 1 $" src="../../form_402.png" width="47" height="11"/>, which acts as the proxy for <img class="formulaInl" alt="$ \psi $" src="../../form_336.png" width="12" height="15"/> (i.e., <img class="formulaInl" alt="$ w^p \equiv \psi $" src="../../form_407.png" width="50" height="15"/>). From this we can determine the nodal uncollided flux, <img class="formulaInl" alt="$ \phi^{uc} $" src="../../form_403.png" width="21" height="15"/>, in a similar fashion as we would determine the regular flux, i.e., </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_j \phi_j^{uc} \int_V b_i b_j dV = \int_V b_i \phi^{uc} dV, \]" src="../../form_425.png" width="209" height="42"/>
</p>
<p> however, now we need additional treatment for the integral containing <img class="formulaInl" alt="$ \phi^{uc} $" src="../../form_403.png" width="21" height="15"/>, for which we have </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \int_V b_i \phi^{uc} dV \approx \frac{1}{N_p} \sum_t \ell_t w_t^{i,avg}, \]" src="../../form_426.png" width="197" height="39"/>
</p>
<p> where, this time, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_t^{i,avg} = \frac{ \int_{s_a}^{s_b} w^p(s) b_i(s\mapsto \mathbf{x}) ds } {\ell_t}. \]" src="../../form_417.png" width="204" height="41"/>
</p>
<p> Note here that <img class="formulaInl" alt="$ w^p $" src="../../form_409.png" width="18" height="11"/> is a function of position, specifically </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w^p(s) = w^p(s=s_a) e^{-\sigma_t s} \]" src="../../form_421.png" width="162" height="17"/>
</p>
<p> and so is the basis function <img class="formulaInl" alt="$ b_i $" src="../../form_427.png" width="11" height="15"/>.</p>
<p >The form of this integral needs to split into segments in the same way we did in the previous subsection. Therefore, given K amount of segments, we now have </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \ell_t w_t^{i,avg} = \sum_{k=0}^{K-1} \ell_{tk} w_{tk}^{i,avg} \]" src="../../form_429.png" width="156" height="47"/>
</p>
<p> where <img class="formulaInl" alt="$ \ell_{tk} $" src="../../form_431.png" width="18" height="15"/> is the track length of the <img class="formulaInl" alt="$ k $" src="../../form_432.png" width="8" height="12"/>-th segment and <img class="formulaInl" alt="$ w_{tk}^{i,avg} $" src="../../form_433.png" width="39" height="20"/> is the average weight of this segment. The weight is computed with </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_{tk}^{i,avg} = \frac{ \int_{s_k}^{s_{k+1}} w^p(s) b_i(s\mapsto \mathbf{x}) ds } {\ell_{tk}}. \]" src="../../form_442.png" width="218" height="41"/>
</p>
<p> where <img class="formulaInl" alt="$ s_k $" src="../../form_434.png" width="14" height="11"/> and <img class="formulaInl" alt="$ s_{k+1} $" src="../../form_435.png" width="29" height="12"/> are the beginning and ending positions of segment <img class="formulaInl" alt="$ k $" src="../../form_432.png" width="8" height="12"/> respectively.</p>
<p >Note here that, since we have an expression for <img class="formulaInl" alt="$ w^p $" src="../../form_409.png" width="18" height="11"/>, we can compute <img class="formulaInl" alt="$ w^p $" src="../../form_409.png" width="18" height="11"/> at any point along track <img class="formulaInl" alt="$ t $" src="../../form_371.png" width="6" height="11"/> including at the start of any segment. Therefore we define <img class="formulaInl" alt="$ w_k^p = w^p(s=s_k) $" src="../../form_436.png" width="110" height="18"/> which allows us to express <img class="formulaInl" alt="$ w^p $" src="../../form_409.png" width="18" height="11"/> as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w^p(s) = w_k^p e^{-\sigma_t(s-s_k)}, \quad \quad \quad s\in[s_k,s_{k+1}] \]" src="../../form_440.png" width="276" height="20"/>
</p>
<p >Additionally we express the basis functions on a segment, since we know the shape function is linear on the segment, as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ b_i(s) = b_{i,k} \frac{s_{k+1}-s}{s_{k+1}-s_k} + b_{i,k+1} \frac{s-s_k}{s_{k+1}-s_k} \]" src="../../form_437.png" width="257" height="32"/>
</p>
<p> where <img class="formulaInl" alt="$ b_{i,k} $" src="../../form_438.png" width="21" height="17"/> and <img class="formulaInl" alt="$ b_{i,k+1} $" src="../../form_439.png" width="35" height="17"/> are the basis function values at the beginning and end of the segment, respectively. These two expressions allow us to evaluate the segment average weight as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_{tk}^{i,avg} = \frac{1}{\ell_{tk}} \int_{s_k}^{s_{k+1}} w_k^p e^{-\sigma_t(s-s_k)} \biggr[ b_{i,k} \frac{s_{k+1}-s}{s_{k+1}-s_k} + b_{i,k+1} \frac{s-s_k}{s_{k+1}-s_k} \biggr] ds \]" src="../../form_443.png" width="449" height="39"/>
</p>
<p> and since <img class="formulaInl" alt="$ s_{k+1}-s_k = \ell_{tk} $" src="../../form_444.png" width="99" height="17"/> we can simplify this expression as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_{tk}^{i,avg} = \frac{w_k^p}{\ell_{tk}^2} \int_{s_k}^{s_{k+1}} e^{-\sigma_t(s-s_k)} \biggr[ C_0 + C_1 s \biggr] ds \]" src="../../form_445.png" width="284" height="39"/>
</p>
<p> where </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ C_0 = b_{i,k} s_{k+1} - b_{i,k+1} s_k \]" src="../../form_446.png" width="158" height="17"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ C_1 = b_{i,k+1} - b_{i,k}. \]" src="../../form_448.png"/>
</p>
<p >With these constants defined the expression can be evaluated analytically </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ w_{tk}^{i,avg} = \frac{w_k^p}{\ell_{tk}^2} \]" src="../../form_449.png"/>
</p>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Chi-Tech</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
