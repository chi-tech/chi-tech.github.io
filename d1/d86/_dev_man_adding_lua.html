<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Adding Lua-input to the system</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d1/d86/_dev_man_adding_lua.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Adding Lua-input to the system </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Lua is the main scripting system used by <a class="el" href="../../d5/d49/class_chi_tech.html">ChiTech</a>.</p>
<h1><a class="anchor" id="devman03_sec0"></a>
Adding Lua-input</h1>
<h2>Step 1: Create a source file</h2>
<p>First create a <code>.cc</code> file in the location where you want the lua-input to reside. Example: <code>CHI_TECH/LuaTest/lua_test.cc</code> <br />
<br />
If the folder where the file resides is not covered by a <code>CMakeLists.txt</code> recursion then follow the instructions for <a class="el" href="../../dc/d4c/_dev_man_adding_code.html">adding a code to the system</a>. <br />
<br />
<b>Restrictions:</b> The lua-wrapper <code>.cc</code> file must be in a folder that is not shared with <code>.cc</code> files that contain regular non-lua code. In the example above it means we cannot add the wrapper <code>.cc</code> to the general <code>CHI_TECH</code> folder. <em>This is because we use a script to convert the doxygen comments to text used in the input manual.</em></p>
<h2>Step 2: Define a standard lua template with your input function name</h2>
<p>In our case the test function will be <code>LuaTest</code>. We add <code>chi</code> to the front of all input language to distinguish it from other lua functions. <br />
<br />
Lua-wrapper functions have no real arguments other than the lua-state and always return an integer representing the number of items returned. For more information on how to handle parameters in lua C-api consult the <a href="https://www.lua.org/pil/24.html">lua-documentation</a>. <br />
<br />
<b>General Requirements:</b></p><ul>
<li>The doxygen comments must start with a forward dash and two asterisks. Like / * * but without spaces which was necessary to show it in this document.</li>
<li>If you use the <code>param</code> tag then it must be on its own line. The variable name is followed by an indication of the type of the variable and then by the description of the parameter. <em>This gets used in the documentation script to generate the input reference</em>.</li>
<li>The closing comment must be an asterisk forward slash. Like * / but without the space which was necessary to show it in this document. And must be on its own line.</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ChiLua/chi_lua.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/dcb/chi__mesh_8h.html">ChiMesh/chi_mesh.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d98/chi__meshhandler_8h.html">ChiMesh/MeshHandler/chi_meshhandler.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d0/db3/chi__meshcontinuum_8h.html">ChiMesh/MeshContinuum/chi_meshcontinuum.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../da/d0e/petsc__utils_8h.html">ChiMath/PETScUtils/petsc_utils.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d6/d57/chi__mpi_8h.html">chi_mpi.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">extern</span> <a class="code" href="../../d8/d1a/class_chi_log.html">ChiLog</a>&amp; <a class="code" href="../../d3/dd3/chi__runtime_8cc.html#a5307d1d2e96bfccf9876352dfa7d0869">chi_log</a>;</div><div class="line"><span class="keyword">extern</span> <a class="code" href="../../dc/d52/class_chi_m_p_i.html">ChiMPI</a>&amp; <a class="code" href="../../d3/dd3/chi__runtime_8cc.html#aff18523449a2997a122381af7ab97f4d">chi_mpi</a>;</div><div class="line"></div><div class="line"><span class="comment">//###################################################################</span><span class="comment"></span></div><div class="line"><span class="comment">/**This is a lua test function.</span></div><div class="line"><span class="comment">\param argument1 Any Argument of any type.</span></div><div class="line"><span class="comment">\ingroup LuaGeneralUtilities</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d1/d85/group___lua_general_utilities.html#ga09eae924251d1d159fdc16b378cdfecc">chiLuaTest</a>(lua_State* L)</div><div class="line">{</div><div class="line">  <a class="code" href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a> a(1.0,1.0,1.0);</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  a = a + 2.0;</span></div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h2>Step 3: Add it to the lua-register</h2>
<p>In the project directory go to the file <code>CHI_TECH/ChiLua/chi_lua_register.h</code> and add a <code>RegisterFunction</code> call to the register, registering the lua function call to be connected with the lua console. <em>Without out this call the wrapper will not be callable from lua.</em> <br />
<br />
If you would like for the function call to be listed under a category then proceed the <code>RegisterFunction</code> call with a comment starting exactly with <code>//module:</code> which will create a module with text matching the text following this piece. <br />
<br />
The module tabulation in the manual and the documentation for the parameters will be processed with a script therefore it is important to comment parameters and return values. Some specific notes in the lua-register file</p>
<ul>
<li><code>//module:</code> provides a categorization of the function on the documenation main page.</li>
<li><code>//\ref</code> will provide a link anchor on the documenation main page.</li>
</ul>
<div class="fragment"><div class="line"> .</div><div class="line"> .</div><div class="line"> .</div><div class="line">RegisterFunction(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#ga165566f609ac8098f3ebb356cf71cf1e">chiLBSGroupsetSetGroupSubsets</a>)</div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#ga2a564e9bf5d242298862b84b4202aa4a">chiLBSGroupsetSetIterativeMethod</a>)</div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#gaee8fa9ea897058b7c22fb64d2e2a53c4">chiLBSGroupsetSetResidualTolerance</a>)</div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#gaab6c348508a33b17a779862605afa6c0">chiLBSGroupsetSetMaxIterations</a>)</div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#gaec6b3fcece2e9ff00cd4d216fb3cbe66">chiLBSGroupsetSetGMRESRestartIntvl</a>)</div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#ga92e2e2734da988f93638c53d253ece30">chiLBSGroupsetSetWGDSA</a>)</div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d5/d03/group___lua_l_b_s_groupsets.html#gadd3fce4dc1756565f2490882c3e67e36">chiLBSGroupsetSetTGDSA</a>)</div><div class="line"></div><div class="line"><span class="comment">//module:Test scripts</span></div><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(<a class="code" href="../../d1/d85/group___lua_general_utilities.html#ga09eae924251d1d159fdc16b378cdfecc">chiLuaTest</a>)</div></div><!-- fragment --><h2>Step 4: Include it in the documentation script</h2>
<p>The module inclusion script is at <code>CHI_TECH/ChiLua/module_lua_inclusion</code>. Add the folder where your lua-wrapper resides to this script:</p>
<div class="fragment"><div class="line"> .</div><div class="line"> .</div><div class="line"> .</div><div class="line">Add_Folder(<span class="stringliteral">&quot;../../Modules/MonteCarlon/lua&quot;</span>)</div><div class="line">Add_Folder(<span class="stringliteral">&quot;../../Modules/DiffusionSolver/lua&quot;</span>)</div><div class="line">Add_Folder(&quot;../../Modules/LinearBoltzmanSolver/lua&quot;)</div><div class="line"></div><div class="line">Add_Folder(&quot;../LuaTest&quot;)</div></div><!-- fragment --><h2>Final step: Test it!!</h2>
<p>Create a script input file and call your function. If it is linked incorrectly the lua scripting system will throw an error like</p>
<p>&lsquo;Test.lua:2: attempt to call a nil value (global 'chiLuaTest&rsquo;)` </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">index</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li><li class="navelem"><a class="el" href="../../de/d0d/_dev_man_must_reads.html">Must read (or browse)</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
