<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Using Chi-Tech as a library</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d8/d99/_dev_man_using_lib.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using Chi-Tech as a library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="devman01_02"></a>
So you want to use Chi-Tech as a library</h1>
<h2><a class="anchor" id="devman01_02_01"></a>
Step 1 - Make a application directory and empty source file</h2>
<p>Wherever you like, create a folder that will contain your application.</p>
<div class="fragment"><div class="line">mkdir TestApp</div><div class="line">cd TestApp</div></div><!-- fragment --><p>Now create an empty source file</p>
<div class="fragment"><div class="line">&gt;test.cc</div></div><!-- fragment --><h2>_</h2>
<h2><a class="anchor" id="devman01_02_02"></a>
Step 2 - Create CMakeLists.txt file</h2>
<p>In the folder you just created create a text file called <code>CMakeLists.txt</code></p>
<div class="fragment"><div class="line">&gt;CMakeLists.txt</div></div><!-- fragment --><h2>_</h2>
<h2><a class="anchor" id="devman01_02_03"></a>
Step 3 - Edit the cmake file to connect to Chi-Tech</h2>
<p>There are 3 custom values to be included in the <code>CMakeLists.txt</code> file.</p><ul>
<li>The desired application/executable name, for now we will call that <b>test</b>.</li>
<li>The Chi-Tech "downstream" cmake include, <code>Downstream.cmake</code>.</li>
<li>The source file names. For now we will only have <code>test.cc</code></li>
</ul>
<div class="fragment"><div class="line">cmake_minimum_required(VERSION 3.2)</div><div class="line"></div><div class="line"><span class="keyword">set</span>(TARGET test)</div><div class="line">project(${TARGET} C CXX)</div><div class="line"><span class="keyword">set</span>(CHI_TECH_DIR <span class="stringliteral">&quot;~/Desktop/ChiTech/chi-tech&quot;</span>)</div><div class="line">include(<span class="stringliteral">&quot;${CHI_TECH_DIR}/CHI_RESOURCES/Macros/Downstream.cmake&quot;</span>)</div><div class="line"></div><div class="line"><a class="code" href="../../d8/d65/namespace_z_compile_and_run.html#a3f5f620160c2772d4cf69ca3cbb34eb4">file</a> (GLOB_RECURSE SOURCES &quot;*.cc&quot;)</div><div class="line">add_executable(${TARGET} <span class="stringliteral">&quot;${SOURCES}&quot;</span>)</div><div class="line">target_link_libraries(${TARGET} ${CHI_LIBS})</div></div><!-- fragment --><p>The <code>set(TARGET test)</code> line sets the name of the eventual executable to be used. You can use any name other than <code>test</code>. The <code>set(CHI_TECH_DIR "~/Desktop/ChiTech/chi-tech")</code> line sets the directory of an installed chi-tech. Change this line to point to the appropriate directory. The <code>include</code> statement allows you to connect to all the resources connected to Chi-Tech, including lua, PETSc, etc. You will have to find the location where you compiled Chi-Tech in order to properly specify the location of <code>Downstream.cmake</code>. Once this is properly specified, the cmake-variable <code>CHI_LIBS</code> will be defined and the necessary include-files will be usable. The line <code>file (GLOB_RECURSE SOURCES "*.cc")</code> adds all <code>.cc</code> files, in the current directory, to the list of sources to compile. To specify specific source-file names use <code>set(SOURCES "test.cc")</code>. Alternatively cmake functionality can be googled to determine how to add sub-directories.</p>
<h2>_</h2>
<h2><a class="anchor" id="devman01_02_04"></a>
Step 4 - Add the basic code to `test.cc`</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">    <a class="code" href="../../d5/d49/class_chi_tech.html#a3c2fb8f53da8e920fbdbc415d299f328">ChiTech::Initialize</a>(argc,argv);</div><div class="line"></div><div class="line">    <span class="comment">//We will add code here</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d49/class_chi_tech.html#a79c2e4d177303e57e3813a87172421c5">ChiTech::Finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This code is the minimum needed to have everything available in Chi-Tech. The basic namespace access is provided via <code>#include "chi_runtime.h"</code></p>
<p>MPI initialization and PETSc initialization is handled via the call to <code><a class="el" href="../../d5/d49/class_chi_tech.html#a3c2fb8f53da8e920fbdbc415d299f328">ChiTech::Initialize()</a></code>.</p>
<p>Finally all MPI and PETSc related items are destroyed via the call to <code><a class="el" href="../../d5/d49/class_chi_tech.html#a79c2e4d177303e57e3813a87172421c5">ChiTech::Finalize()</a></code>.</p>
<h2>_</h2>
<h2><a class="anchor" id="devman01_02_05"></a>
Step 5 - Compile the code</h2>
<p>Well, we should probably state here that you should make sure <a class="el" href="../../d5/d49/class_chi_tech.html">ChiTech</a> compiled. This can be done by running the test cases. If all is well then proceed to make build directory (<code>TestApp/build</code>) for this app.</p>
<div class="fragment"><div class="line">mkdir build</div><div class="line">cd build</div></div><!-- fragment --><p>Next execute cmake from this directory, giving it the directory-location of the CMakeLists.txt created in <a class="el" href="../../d8/d99/_dev_man_using_lib.html#devman01_02_02">step 2</a>.</p>
<div class="fragment"><div class="line">cmake ../</div></div><!-- fragment --><p>If all is well here then simply run make:</p>
<div class="fragment"><div class="line">make -j4</div></div><!-- fragment --><h2>_</h2>
<h1><a class="anchor" id="devman01_03"></a>
Adding lua-input to library-using apps</h1>
<p>For this section we refer to <a class="el" href="../../d8/d99/_dev_man_using_lib.html#devman01_02">the section above</a> where we created a test application.</p>
<h2><a class="anchor" id="devman01_03_01"></a>
Step 1 - Create folder to contain lua sources.</h2>
<p>Purely for categorization, create a <code>lua</code> folder in the <code>TestApp</code> folder</p>
<div class="fragment"><div class="line">cd ../TestApp</div><div class="line">mkdir lua</div><div class="line">cd lua</div></div><!-- fragment --><h2><a class="anchor" id="devman01_03_02"></a>
Step 2 - Create a source file</h2>
<p>Let us pretend that we will have a status update message that we want to be printed from a lua call. Create a file called <code>testapp_statusmess.cc</code> with the following contents:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include&quot;ChiLua/chi_lua.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> chiPrintStatus(lua_State *L)</div><div class="line">{</div><div class="line">    <a class="code" href="../../d8/d1a/class_chi_log.html">ChiLog</a>&amp; log = <a class="code" href="../../d8/d1a/class_chi_log.html#af5c2dcd4bf197d44b12c70e8359b0bd0">ChiLog::GetInstance</a>();</div><div class="line"></div><div class="line">    log.<a class="code" href="../../d8/d1a/class_chi_log.html#a5f227385fe906aad93de74eb1e756d64">Log</a>(<a class="code" href="../../dc/d75/chi__log_8h.html#a69d6fb9ad6b29cf2ce8503e92e240405a46105a8c5c382e71fc6b3bdcf19a2ad8">LOG_0</a>) &lt;&lt; <span class="stringliteral">&quot;Hello from here&quot;</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h2>_</h2>
<h2><a class="anchor" id="devman01_03_03a"></a>
Step 3 - Modify the CMakeLists.txt file to compile this code</h2>
<p>In preparation for adding many more sources to the <code>lua</code> folder, edit the CMakeLists.txt file as follows:</p>
<div class="fragment"><div class="line">cmake_minimum_required(VERSION 3.2)</div><div class="line"></div><div class="line">SET(TARGET test)</div><div class="line">project(${TARGET} C CXX)</div><div class="line"></div><div class="line">include(~/Desktop/<a class="code" href="../../d5/d49/class_chi_tech.html">ChiTech</a>/chi-tech/CHI_RESOURCES/Macros/Downstream.cmake)</div><div class="line">include(~/Desktop/<a class="code" href="../../d5/d49/class_chi_tech.html">ChiTech</a>/chi-tech/CHI_RESOURCES/Macros/Filter.cmake)</div><div class="line"></div><div class="line">set(SOURCES &quot;test.cc&quot; )</div><div class="line"><a class="code" href="../../d8/d65/namespace_z_compile_and_run.html#a3f5f620160c2772d4cf69ca3cbb34eb4">file</a> (GLOB_RECURSE MORE_SOURCES &quot;${CMAKE_CURRENT_SOURCE_DIR}/lua<span class="comment">/*.cc&quot;)</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">set(SOURCES ${SOURCES} ${MORE_SOURCES})</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">add_executable(${TARGET} &quot;${SOURCES}&quot;)</span></div><div class="line"><span class="comment">target_link_libraries(${TARGET} ${CHI_LIBS})</span></div></div><!-- fragment --><p>This will allow any <code>.cc</code> file in the <code>lua</code> folder to be compiled with the project. The line</p>
<div class="fragment"><div class="line"><a class="code" href="../../d8/d65/namespace_z_compile_and_run.html#a3f5f620160c2772d4cf69ca3cbb34eb4">file</a> (GLOB_RECURSE MORE_SOURCES <span class="stringliteral">&quot;${CMAKE_CURRENT_SOURCE_DIR}/lua/*.cc&quot;</span>)</div></div><!-- fragment --><p>recursively searches through the specified folder and pumps any filenames ending with .cc into the variable <code>MORE_SOURCES</code>. This variable gets added to the manually specified <code>SOURCES</code> variable using the line</p>
<div class="fragment"><div class="line"><span class="keyword">set</span>(SOURCES ${SOURCES} ${MORE_SOURCES})</div></div><!-- fragment --><h2>_</h2>
<h2><a class="anchor" id="devman01_03_04a"></a>
Step 4 - Modify test.cc to register the lua function</h2>
<p>Modify your <code>test.cc</code> source file to be </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d6d/chi__console_8h.html">ChiConsole/chi_console.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">    <a class="code" href="../../d5/d49/class_chi_tech.html#a3c2fb8f53da8e920fbdbc415d299f328">ChiTech::Initialize</a>(argc,argv);</div><div class="line"></div><div class="line">    <a class="code" href="../../dd/d62/class_chi_console.html">ChiConsole</a>&amp; console = <a class="code" href="../../dd/d62/class_chi_console.html#aa86fe2fd17d4a190ae2a689d20285fdb">ChiConsole::GetInstance</a>();</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> L = console.<a class="code" href="../../dd/d62/class_chi_console.html#a6b03e4088cb1d5840f05c34382e72dbc">consoleState</a>;</div><div class="line"><span class="preprocessor">    #include &quot;ChiMacros/lua_register_macro.h&quot;</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(chiPrintStatus);</div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d49/class_chi_tech.html#a79c2e4d177303e57e3813a87172421c5">ChiTech::Finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Notice here that we firstly included the header file for the <code><a class="el" href="../../dd/d62/class_chi_console.html">ChiConsole</a></code> object. This is the object that allows us to connect to the lua state. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d6d/chi__console_8h.html">ChiConsole/chi_console.h</a>&quot;</span></div></div><!-- fragment --><p>Next we obtained a reference to the console through</p>
<div class="fragment"><div class="line"><a class="code" href="../../dd/d62/class_chi_console.html">ChiConsole</a>&amp; console = <a class="code" href="../../dd/d62/class_chi_console.html#aa86fe2fd17d4a190ae2a689d20285fdb">ChiConsole::GetInstance</a>();</div></div><!-- fragment --><p>We then setup the variable <code>L</code>, which is needed by the macro file <code>ChiMacros/lua_register_macro.h</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> L = console.<a class="code" href="../../dd/d62/class_chi_console.html#a6b03e4088cb1d5840f05c34382e72dbc">consoleState</a>;</div><div class="line"><span class="preprocessor">#include &quot;ChiMacros/lua_register_macro.h&quot;</span></div></div><!-- fragment --><p>This macro file exposes numerous lua macros, one of which is the <code><a class="el" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction(x)</a></code> macro where we will supply the <code>x</code> as the function call we defined earlier:</p>
<div class="fragment"><div class="line"><a class="code" href="../../d6/d07/chi__console__constrdestr_8cpp.html">RegisterFunction</a>(chiPrintStatus);</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">index</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li><li class="navelem"><a class="el" href="../../de/d0d/_dev_man_must_reads.html">Must read (or browse)</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
