\documentclass[11pt,letterpaper,titlepage]{article}
\usepackage{fancyhdr}
\usepackage[left=0.75in, right=0.75in, bottom=1.0in]{geometry}
\usepackage{lastpage}
\usepackage{titleref}
\usepackage{booktabs}
\usepackage{appendix}
\appendixtitleon
\appendixtitletocon

\makeatletter

%================== List of figures and tables mods
\usepackage{tocloft}
\usepackage[labelfont=bf]{caption}

\renewcommand{\cftfigpresnum}{Figure\ }
\renewcommand{\cfttabpresnum}{Table\ }

\newlength{\mylenf}
\settowidth{\mylenf}{\cftfigpresnum}
\setlength{\cftfignumwidth}{\dimexpr\mylenf+1.5em}
\setlength{\cfttabnumwidth}{\dimexpr\mylenf+1.5em}


\newcommand{\half}{\frac{1}{2}}


%=================== Graphics
\usepackage{graphicx}
\usepackage[breakwords]{truncate}
\usepackage{float}
\usepackage{array}
\usepackage{amsmath}
\usepackage{mdframed}
\usepackage{fancyvrb}
\usepackage{float}
\usepackage{cancel}
\usepackage{amssymb}
\graphicspath{ {images/} }
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage[defaultlines=2,all]{nowidow}
\usepackage{listings}
\usepackage{color}
\definecolor{Brown}{cmyk}{0,0.81,1,0.60}
\definecolor{OliveGreen}{cmyk}{0.64,0,0.95,0.40}
\definecolor{CadetBlue}{cmyk}{0.62,0.57,0.23,0}
\usepackage{pdflscape}
\usepackage{relsize}
\usepackage{verbatim}
\usepackage{tabto}


%=================== Settings
\renewcommand{\baselinestretch}{1.2}
\definecolor{gray}{rgb}{0.4 0.4 0.4}
\newcommand{\stimes}{{\times}}

\begin{document}
\newcommand{\NSCDOCNUMBR}{NSC-REP-15-X}         %Put document number here
\newcommand{\NSCDOCSUBJT}{TECHNICAL REPORT: }   %Put document subject here
\newcommand{\NSCDOCTITLE}{$THERMOFLOW$ - System level Thermal-Hydraulics in $ChiTech$}       %Put document title here
\newcommand{\NSCDOCDATE} {August, 2016}    %Put document date here
\newcommand{\NSCDOCREV}  {Rev 1.2} %Put revision number here

\lstset{language=C++,frame=ltrb,framesep=4pt,basicstyle=\linespread{0.8} \small,
	keywordstyle=\ttfamily\color{OliveGreen},
	identifierstyle=\ttfamily\color{CadetBlue}\bfseries,
	commentstyle=\color{Brown},
	stringstyle=\ttfamily,
	showstringspaces=ture }


%################################# TITLE PAGE ########################
\begin{titlepage}
	\pagestyle{fancy}
	\vspace*{1.0cm}
	\centering
	%\includegraphics{NSC_Logo} \par
	\vspace{1cm}
	%\centering
	%{\Large\bfseries  \NSCDOCNUMBR   \par}
	\vspace{.25cm}
	%\centering
	{\Large\bfseries  \NSCDOCSUBJT \par} 
	{\Large\bfseries \NSCDOCTITLE  \par}
	\vspace{1cm}
	{\Large \NSCDOCDATE \par}
	\vspace{1.0cm}
	{\Large Jan Vermaak \par}
	{\Large \NSCDOCREV \par}
		
	\begin{comment}
	\renewcommand{\arraystretch}{2.0}
	\begin{tabular}{| m{2.5cm} | m{4.5cm} | m{4.5cm} |}
		\cline{2-3}
		\multicolumn{1}{c|}{} & \bfseries{Name} & \bfseries{Signature \& Date} \\ \hline
		\bfseries{Prepared} &     &     \\ \hline
		\bfseries{Reviewed} &     &     \\ \hline
		\bfseries{Reviewed} &     &     \\ \hline
	    \bfseries{Approved} &     &     \\ \hline
	\end{tabular} \par
	\end{comment}
	\begin{center}
		\begin{minipage}[c]{0.45\textwidth}
			\begin{figure}[H]
			
				\includegraphics[width=3in]{Logo2_Medium.png}
			\end{figure}
		\end{minipage}
	\end{center}
	\vspace{2cm}
	%NSC-FRM-15-1 Rev.1
\end{titlepage}


\pagestyle{fancy}
\rfoot{Page \thepage \ of \pageref{LastPage}}
%\cfoot{NSC-FRM-15-1 Rev.1}
\cfoot{}
\lfoot{\truncate{14cm}{\NSCDOCTITLE}}
\rhead{}
\chead{\currentname}
\lhead{}
\renewcommand{\footrulewidth}{0.4pt}
\tableofcontents
\addtocontents{toc}{~\hfill\textbf{Page}\par}

\listoffigures
%\listoftables
\chead{Contents}


\newpage
\chead{1 Conservation equations}
\section{Conservation equations}
The overall objective is that we want to solve the following four field variables:
\begin{itemize}
\item Pressure, $P$
\item Internal energy, $u$
\item Velocity, $v$
\item Density, $\rho$
\end{itemize}

\vspace{0.25cm}
\noindent
In order to do this we apply the conservation equations to the volume shown in Figure \ref{figure:ZZZ_ControlVolume} below:
	\begin{center}
		\begin{minipage}[c]{0.7\textwidth}
	
			\begin{figure}[H]
			
				\includegraphics[width=5in]{ZZZ_ControlVolume.png}
				\caption{Simple layout of control volumes.}
				\label{figure:ZZZ_ControlVolume}
			\end{figure}
		\end{minipage}
	\end{center}
\vspace{0.5cm}

\newpage
\subsection{Conservation of Mass}
Even though we will be dealing with incompressible liquids, the liquids can exist at different temperatures and therefore different densities, $\rho$. The conservation of mass requires as a function of time, $t$:

\begin{equation*}
\frac{d\rho}{dt}=\frac{1}{V}\int_S \rho.(\vec{v}\cdot \hat{n}).dA
\end{equation*}
\newline
\noindent And by applying it to the control volume:

\begin{equation}
\frac{d\rho_i}{dt} = \frac{1}{V_i}\biggr[ (\rho.A.v)_{i-\half}-(\rho.A.v)_{i+\half} \biggr]
\end{equation}

\noindent 
Where: 
\newline \noindent $v$ \quad = velocity.
\newline \noindent $V$ \quad = Volume.
\newline \noindent $A$ \quad = Area.
\newline \noindent $\hat{n}$ \quad = Surface normal.

\subsection{Conservation of Momentum}
The change in momentum, $m_i.v_{i}$, in a control volume must balance the momentum of all the in and out flows as well as any forces applied:

\begin{equation*}
\frac{d(mv)_i}{dt}=\int_S \rho. |v|. (\vec{(v)}\cdot \hat{n}).dA + \int_S P.\hat{n}.dA+mg-F_{losses}
\end{equation*}
\newline
\noindent For a control volume as shown in Figure \ref{figure:ZZZ_ControlVolume} we have:

\begin{equation*}
\begin{aligned}
\frac{d(\rho v)_i}{dt}&=\frac{1}{V_i} \biggr[ (\rho A v^2 d)_{i-\half} +(\rho A v^2 d)_{i+\half}  \biggr] \\
&+\frac{1}{V_i} \biggr[ (PA)_{i-\half} - (PA)_{i+\half} \biggr]+\rho_ig_i-\frac{1}{V_i}\Delta P_{\tau,i}A_i
\end{aligned}
\end{equation*}
\newline
Where $d$ is the direction value (either $+1$ or $-1$), $F_{\tau}$ is the wall friction force and $g_i$ is the gravitational component (i.e. $g_i=g.sin\theta_i$, $g=-9.81 m.s^{-2}$). In later derivations of the numerical representation it is more convenient to define the conservation of momentum equation about a boundary by:

\begin{equation*}
\frac{d(\rho v)}{dt}=-\rho \frac{d(v^2)}{dx} -\frac{dP}{dx}+\rho g - \frac{\tau}{L}
\end{equation*}
\newline
Applied to the boundary junction, $i+\half$, we can write:
\begin{equation}
\begin{aligned}
\frac{d(\rho v)_{i+\half}}{dt}=&\frac{\rho_{i+\half}}{2}\cdot\frac{d_i.(v_{i})^2-d_{i+1}.(v_{i+1})^2}{\Delta x_{i+\half}} \\
&-\frac{P_{i+1}-P_i}{\Delta x_{i+\half}} + \rho_{i+\half}.g_{i+\half}-\frac{\Delta P_{\tau,i}A_i}{2V_i}-\frac{\Delta P_{\tau,i+1}A_{i+1}}{2V_{i+1}} \\
&-\frac{\Delta P_{loss,i+\half}A_{i+\half}}{V_{i+1}}
\end{aligned}
\end{equation}
\newline
Here $\Delta x_{i+\half}$ is the distance between control volumes $i$ and $i+1$, $g_{i+\half}$ is the gravitational force component (function of inclination angle between control volume centroids). The wall friction force can be calculated from the Darcy Friction Factor, $f$:

\begin{equation*}
\Delta P_{\tau}=\half f \rho \frac{L}{D_H} v^2
\end{equation*} 
\noindent Therefore:

\begin{equation*}
\begin{aligned}
\Delta P_{\tau,i}&=\frac{1}{4} f_i \rho_i \frac{L_i}{D_{H,i}} v_i^2 \\
\Delta P_{\tau,i+1}&=\frac{1}{4} f_{i+1} \rho_{i+1} \frac{L_{i+1}}{D_{H,i+1}} v_{i+1}^2 \\
\end{aligned}
\end{equation*}
\newline
\noindent
In these equations $L_i$ and $D_{H,i}$ are the length and hydraulic diameter of the $i$-th control volume. The Darcy friction factor is evaluated as shown below. The turbulent regime friction factor (i.e. Re$>$3000) is calculated from the Zigrang and Sylvester correlation.

\begin{equation*}
f=
\begin{cases}
g(Re)=\frac{64}{Re} \quad &,Re\le 2200 \\
h(Re)=\frac{1}{\sqrt{f}}=-2\textrm{log}\biggr( \frac{\epsilon}{3.7D_H}  + \frac{2.51}{Re \sqrt{f}}   \biggr)     \quad &,Re>3000 \\
g(2200)+\frac{h(3000)-g(2200)}{800}. (Re-2200)   \quad &, 2200<Re\le 3000
\end{cases}
\end{equation*}
\newline
The junction pressure loss $\Delta P_{loss,i+\half}$ is calculated from a loss coefficient $K$ as follows:

\begin{equation*}
\Delta P_{loss,i+\half} = \half K_{i+\half} \rho_{i+\half} d_{i+\half} v_{i+\half}^2
\end{equation*}
























\newpage
\subsection{Conservation of Energy}
The total energy of the system, $E$, must balance that of the in and out flow including the work performed and the heat transfer into the system:

\begin{equation*}
\frac{dE}{dt}=\int_S \rho.(\vec{v}\cdot \hat{n}).e.dA + Q - W +E_{loss}
\end{equation*}

\noindent 
Where: 
\newline \noindent $e$ \quad = Specific energy of the system.
\newline \noindent $Q$ \quad = Heat transfer into the system.
\newline \noindent $W$ \quad = Work leaving the system.
\newline \noindent $E_{loss}$ \quad = Dissipative energy losses (includes irreversible conversion of kinetic energy to internal energy).
\newline
\newline
The components of energy are internal energy, $U$, kinetic energy, $\half mv^2$, and potential energy, $mgz$:

\begin{equation*}
E= m.e = m.(u+\half v^2+gz)
\end{equation*}
\newline
For most control volume fluid flows where the control volume flow rate is small compared to its area it is often acceptable to neglect the kinetic energy term. Also, since it undergoes no change in elevation we can neglect the elevation change (but only for the control volume, not the junctions).
\newline
\newline
The heat transfer into the system is normally associated with some heat flux, $\dot{q}$, and the total heat transfer surface, $A_s$, therefore:

\begin{equation*}
Q_i=\dot{q}_i.A_{s,i}
\end{equation*}
\newline
The components of work include shaft work, $W_{shaft}$, and pressure work, $W_{pressure}$. For this case we will consider only pressure work:

\begin{equation*}
W_{pressure}=(P.A.v)_{i+\half} - (P.A.v)_{i-\half} 
\end{equation*}
\newline
\noindent
From here the energy conservation equation becomes:

\begin{equation*}
\begin{aligned}
\frac{d}{dt} \biggr( m.u \biggr)&=(\rho Av)_{i-\half}.(u+gz)_{i-\half} - (\rho Av)_{i+\half}.(u+gz)_{i+\half} \\
&+\dot{q}_i.A_{s,i} + \biggr[   (P.A.v)_{i-\half} - (P.A.v)_{i+\half}   \biggr] + E_{loss}
\end{aligned}
\end{equation*}
\newline
\noindent
Dividing by the volume we get:

\begin{equation}
\begin{aligned}
\frac{d(\rho.u)_i}{dt} &=\frac{1}{V_i}\biggr[ (\rho Av)_{i-\half}.(u+gz)_{i-\half} - (\rho Av)_{i+\half}.(u+gz)_{i+\half} \biggr] \\
&+\frac{A_{s,i}}{V_i}\dot{q}_i + \frac{1}{V_i}\biggr[   (P.A.v)_{i-\half} - (P.A.v)_{i+\half}   \biggr] + \frac{E_{loss}}{V_i}
\end{aligned}
\end{equation}



\subsection{Equation of state}
In addition to the conservation equations, there is the equation of state. ChiTech has the ability to use the IAPWS-95 steam tables which is captured within
a function with the main entry specified as pressure [bar]. Therefore the property Y, which can be any thermal property (i.e. temperature, density, 
internal energy, enthalpy, entropy, heat capacity, dynamic viscosity, Prandtl number), can be determined from the equation below given X (a known quantity in the subset listed for Y):

\begin{equation}
\begin{aligned}
Y_i=f(P_i,X_i)
\end{aligned}
\end{equation}


















\newpage
\chead{2 Numerical solution}
\section{Numerical solution}
The conservation of momentum equations conveniently couples the pressure field and velocities and therefore is used implicitly to determine the pressures at time $n+1$.

\subsection{Conservation of Mass - finite difference formulation}
The finite difference formulation is as follows:


\begin{equation}
\frac{\rho_i^{n+1} - \rho_i^{n}}{\Delta t} = \frac{1}{V_i}\biggr[ (\rho.A)_{i-\half}^{n}v_{i-\half}^{n+1}-(\rho.A)_{i+\half}^{n} v_{i+\half}^{n+1} \biggr]
\end{equation}




\subsection{Conservation of Momentum - finite difference formulation}
Because no other future time equation has pressure as a variable we opt to include pressure at time $n+1$ as an implicit variable. We manipulate the original conservation of mass equation for junction $i+\half$:
\begin{equation*}
\begin{aligned}
\frac{d(\rho v)_{i+\half}}{dt}=&-\frac{\rho_{i+\half}}{2}\cdot\frac{d_i.(v_{i})^2+d_{i+1}.(v_{i+1})^2}{\Delta x_{i+\half}} \\
&-\frac{P_{i+1}-P_i}{\Delta x_{i+\half}} + \rho_{i+\half}.g_{i+\half}-\frac{\Delta P_{\tau,i}A_i}{2V_i}-\frac{\Delta P_{\tau,i+1}A_{i+1}}{2V_{i+1}} \\
&-\frac{\Delta P_{loss,i+\half}A_{i+\half}}{V_{i+1}}
\end{aligned}
\end{equation*}

\noindent We use the following time notation:

\begin{equation}
\begin{aligned}
\frac{\rho_{i+\half}^{n}.v_{i+\half}^{n+1}-\rho_{i+\half}^n.v_{i+\half}^n}{\Delta t} &= \rho_{i+\half}^n\cdot\frac{d_i.(v_{i}^n)^2-d_{i+1}.(v_{i+1}^n)^2}{\Delta x_{i+\half}}     \\
&-\frac{P_{i+1}^{n+1}-P_i^{n+1}}{\Delta x_{i+\half}} +\rho_{i+\half}^n.g_{i+\half} \\
&-\frac{\Delta P_{\tau,i}^n }{2\Delta x_{i+\half}}- \frac{\Delta P_{\tau,i+1}^n }{2\Delta x_{i+\half}} -\frac{\Delta P_{loss,i+\half}^n}{\Delta x_{i+\half}}
\end{aligned}
\end{equation}
\newline
\noindent In the equations above we included implicit time instances to pressure in order to semi-implicitly couple the system.
\newline
\newline
We can find the same equation for junction $i-\half$:
\begin{equation}
\begin{aligned}
\frac{\rho_{i-\half}^{n}.v_{i-\half}^{n+1}-\rho_{i-\half}^n.v_{i-\half}^n}{\Delta t} &= \rho_{i-\half}^n\cdot\frac{d_{i-1}.(v_{i-1}^n)^2+d_{i}.(v_{i}^n)^2}{\Delta x_{i-\half}}     \\
&-\frac{P_{i}^{n+1}-P_{i-1}^{n+1}}{\Delta x_{i-\half}} +\rho_{i-\half}^n.g_{i-\half} \\
&-\frac{\Delta P_{\tau,i-1}^n }{2\Delta x_{i-\half}}- \frac{\Delta P_{\tau,i}^n }{2\Delta x_{i-\half}} -\frac{\Delta P_{loss,i-\half}^n}{\Delta x_{i-\half}}
\end{aligned}
\end{equation}



\vspace{1cm}
\subsection{Conservation of Energy - finite difference formulation}
We start with the original conservation of energy equation:

\begin{equation*}
\begin{aligned}
\frac{d(\rho.u)_i}{dt} &=\frac{1}{V_i}\biggr[ (\rho Av)_{i-\half}.(u+gz)_{i-\half} - (\rho Av)_{i+\half}.(u+gz)_{i+\half} \biggr] \\
&+\frac{A_{s,i}}{V_i}\dot{q}_i + \frac{1}{V_i}\biggr[   (P.A.v)_{i-\half} - (P.A.v)_{i+\half}   \biggr] - \frac{E_{loss,i}}{V_i}
\end{aligned}
\end{equation*}
\newline
\noindent We now discretize the left side and set the right side to correspond to time $n$.

\begin{equation}
\begin{aligned}
\frac{(\rho_i^{n+1}.u_i^{n+1}-  \rho_i^{n}.u_i^{n})}{\Delta t}&=\frac{1}{V_i}\biggr[ (\rho Au)_{i-\half}^n.v_{i-\half}^{n+1} -(\rho Au)_{i+\half}^n.v_{i+\half}^{n+1} \biggr] \\
&+\frac{1}{V_i}\biggr[ (\rho Agz)_{i-\half}^n.v_{i-\half}^{n+1} -(\rho Agz)_{i+\half}^n.v_{i+\half}^{n+1} \biggr] \\
&+\frac{A_{s,i}}{V_i}\dot{q}_i^n + \frac{1}{V_i}\biggr[   (P.A)_{i-\half}^n.v_{i-\half}^{n+1} - (P.A)_{i+\half}^n.v_{i+\half}^{n+1}   \biggr] \\
&+ \frac{E_{loss,i}^n}{V_i}
\end{aligned}
\end{equation}


\newpage
\subsection{Equation of state numerical implementation}
In order to implement a linear approximation to the equation of state we linearize the Equation of State by determine the derivative at the old time values. Specifically this applies to the relation of internal energy, $u$, to the density, $\rho$:

\begin{equation*}
\begin{aligned}
\frac{d(\rho_i^n u_i^{n})}{d\rho}&=\frac{\rho_{EOS}(P_i^n,T_i^n+\Delta T) u_{EOS}(P_i^n,T_i^n+\Delta T)-\rho_{EOS}(P_i^n,T_i^n-\Delta T) u_{EOS}(P_i^n,T_i^n-\Delta T)}{\rho_{EOS}(P_i^n,T_i^n+\Delta T)-\rho_{EOS}(P_i^n,T_i^n-\Delta T)} 
\end{aligned}
\end{equation*}
\newline
Where $\rho_{EOS}$ and $u_{EOS}$ are determined from interpolating the steam tables. Also, $\Delta T$ is an arbitrary but small difference in temperature sufficient to locally linearize the equation of state.
From this derivative we find the linearized equation of state:

\begin{equation}
\rho_{i}^{n+1}u_{i}^{n+1} - \rho_{i}^{n}u_{i}^{n}= \frac{d(\rho_i^n u_i^{n})}{d\rho} \cdot (\rho_i^{n+1}-\rho_i^n)
\end{equation}







\newpage
\subsection{Semi-implicit approach}
From the set of equations 5 to 9 we can develop a system of unknowns. Before we depict how this is done, let us repeat these equations all together:


\begin{alignat*}{2}
&eq.5, \quad      \frac{\rho_i^{n+1} - \rho_i^{n}}{\Delta t} &&= \frac{1}{V_i}\biggr[ (\rho.A)_{i-\half}^{n}v_{i-\half}^{n+1}-(\rho.A)_{i+\half}^{n} v_{i+\half}^{n+1} \biggr] \\
& &&\cdots\\
&eq.6, \quad      \frac{\rho_{i+\half}^{n}.v_{i+\half}^{n+1}-\rho_{i+\half}^n.v_{i+\half}^n}{\Delta t} &&= \rho_{i+\half}^n\cdot\frac{d_i.(v_{i}^n)^2-d_{i+1}.(v_{i+1}^n)^2}{\Delta x_{i+\half}}     \\
& &&-\frac{P_{i+1}^{n+1}-P_i^{n+1}}{\Delta x_{i+\half}} +\rho_{i+\half}^n.g_{i+\half} \\
& &&-\frac{\Delta P_{\tau,i}^n }{2\Delta x_{i+\half}}- \frac{\Delta P_{\tau,i+1}^n }{2\Delta x_{i+\half}} -\frac{\Delta P_{loss,i+\half}^n}{\Delta x_{i+\half}} \\
& &&\cdots\\
&eq.7, \quad      \frac{\rho_{i-\half}^{n}.v_{i-\half}^{n+1}-\rho_{i-\half}^n.v_{i-\half}^n}{\Delta t} &&= \rho_{i-\half}^n\cdot\frac{d_{i-1}.(v_{i-1}^n)^2+d_{i}.(v_{i}^n)^2}{\Delta x_{i-\half}}     \\
& &&-\frac{P_{i}^{n+1}-P_{i-1}^{n+1}}{\Delta x_{i-\half}} +\rho_{i-\half}^n.g_{i-\half} \\
& &&-\frac{\Delta P_{\tau,i-1}^n }{2\Delta x_{i-\half}}- \frac{\Delta P_{\tau,i}^n }{2\Delta x_{i-\half}} -\frac{\Delta P_{loss,i-\half}^n}{\Delta x_{i-\half}} \\
& &&\cdots\\
&eq.8, \quad      \frac{(\rho_i^{n+1}.u_i^{n+1}-  \rho_i^{n}.u_i^{n})}{\Delta t}&&=\frac{1}{V_i}\biggr[ (\rho Au)_{i-\half}^n.v_{i-\half}^{n+1} -(\rho Au)_{i+\half}^n.v_{i+\half}^{n+1} \biggr] \\
& &&+\frac{1}{V_i}\biggr[ (\rho Agz)_{i-\half}^n.v_{i-\half}^{n+1} -(\rho Agz)_{i+\half}^n.v_{i+\half}^{n+1} \biggr] \\
& &&+\frac{A_{s,i}}{V_i}\dot{q}_i^n + \frac{1}{V_i}\biggr[   (P.A)_{i-\half}^n.v_{i-\half}^{n+1} - (P.A)_{i+\half}^n.v_{i+\half}^{n+1}   \biggr] \\
& &&- \frac{E_{loss,i}^n}{V_i} \\
& &&\cdots\\
&eq.9, \quad     \rho_{i}^{n+1}u_{i}^{n+1} - \rho_{i}^{n}u_{i}^{n} &&= \frac{d(\rho_i^n u_i^{n})}{d\rho} \cdot (\rho_i^{n+1}-\rho_i^n)
\end{alignat*}
\newpage
The "new" time values that require solving are found in the following terms:

\begin{equation*}
\begin{aligned}
&\rho_i^{n+1}, v_{i+\half}^{n+1}, v_{i-\half}^{n+1}, \ from \ equation \ 5 \\
&v_{i+\half}^{n+1}, P_{i+1}^{n+1},P_{i}^{n+1}, \ from \ equation \ 6 \\
&v_{i-\half}^{n+1}, P_{i-1}^{n+1},P_{i}^{n+1}, \ from \ equation \ 7 \\
&\rho_i^{n+1}, u_{i}^{n+1}, v_{i-\half}^{n+1},v_{i+\half}^{n+1}, \ from \ equation \ 8 \\
&\rho_i^{n+1}, u_{i}^{n+1}, \ from \ equation \ 9
\end{aligned}
\end{equation*}
\newline
There are also the unknown junction quantities $\rho_{i+\half}^{n}$ and $u_{i+\half}^{n}$, however, these can be determined by a simple upwind scheme as follows:

\begin{equation*}
\frac{d \rho_{i+\half}}{dt}=-v_{i+\half} \cdot \frac{d\rho}{dx} \quad \quad and \quad \quad \frac{d u_{i+\half}}{dt}=-v_{i+\half} \cdot \frac{du}{dx} 
\end{equation*}
\begin{equation*}
\begin{aligned}
\therefore \rho_{i+\half}^n &= \rho_{i+\half}^{n-1} - v_{i+\half}^n \cdot \frac{\Delta t}{\Delta x_{i+\half}} \cdot (\rho_{i+1}^n-\rho_i^n) \\
           u_{i+\half}^n &= u_{i+\half}^{n-1} - v_{i+\half}^n \cdot \frac{\Delta t}{\Delta x_{i+\half}} \cdot (u_{i+1}^n-u_i^n) \\
\end{aligned}
\end{equation*}
\newline
By using simple mathematical manipulation we can reduce the set of equations (i.e. eq. 5 to 9) to a single equation in terms of $P_{i-1}^{n+1}$, $P_{i}^{n+1}$ and $P_{i+1}^{n+1}$, a process indicated in the solution algorithm. We can then implicitly solve for the control volume pressure by constructing the system $Ax=b$ and solving it with a suitable sparse solver. After this has been done the junction velocities, $v_{i+\half}^{n+1}$ can be determined from the advancement of the momentum equations (i.e. equation 6) and from those values one can determine $\rho_i^{n+1}$ from the conservation of mass equation and finally $u_i^{n+1}$ from the equation of state interpolation.


	\begin{center}
		\begin{minipage}[c]{0.85\textwidth}
	
			\begin{figure}[H]
			
				\includegraphics[width=6in]{ZZZ_SimpleSystem.png}
				\caption{Simple layout of multiple control volumes.}
				\label{figure:ZZZ_SimpleSystem}
			\end{figure}
		\end{minipage}
	\end{center}
\vspace{0.5cm}










\newpage
\subsection{Solution algorithm}

\textbf{Step 1 - Preliminaries}\newline
Load all control volumes. Input parameters:
\begin{itemize}
\item Area, $A$
\item Length, $L$
\item Pressure, $P$
\item Temperature, $T$
\item Elevation change, $\Delta z$
\item Wall roughness, $\epsilon$
\item Hydraulic diameter, $D_H$
\item Surface area, $A_s$
\end{itemize}

\vspace{0.5cm}
\noindent
Load all junctions. Input parameters:
\begin{itemize}
\item Junction velocity, $v$
\item Area, $A$
\item Loss factor, $K$
\end{itemize}

\vspace{0.5cm}\noindent
\textbf{Step 2}\newline
Determine control volume connectivity to junctions. This step merely requires that control volumes know what they are connected to.



\vspace{0.5cm}\noindent
\textbf{Step 3}\newline
\noindent Initialize control volume pressure, $P_i^n$, and junction velocities, $v_{i+\half}^n$.
\newline
\newline
Determine density, $\rho_i$, from:

\begin{equation*}
\rho=\rho_{EOS}(P,T)
\end{equation*}
\newline
Internal energy, $u_i$, from:
\begin{equation*}
u=u_{EOS}(P,T) 
\end{equation*}
\newline
Dynamic viscosity, $\mu_i$, from:
\begin{equation*}
\mu=\mu_{EOS}(P,T)
\end{equation*}
\newline
Initialize temperature and calculate control volume velocity, $v_i$, from:
\begin{equation*}
v_i=
\begin{cases}
v_{i+\half} \frac{A_{i+\half}}{A_i} \quad &, left \ junction  \ missing \\
v_{i-\half} \frac{A_{i-\half}}{A_i} \quad &, right \ junction  \ missing \\
v_{i-\half} \frac{A_{i-\half}}{2A_i} + v_{i+\half} \frac{A_{i+\half}}{2A_i} \quad &, both \ junctions  \ exist \\
\end{cases}
\end{equation*}


\vspace{0.5cm}\noindent
\textbf{Step 4}\newline
Determine all junction and control volume $z$ values using control volume $\Delta z$ values. Also initialize the mass error and cumulative mass error.

\vspace{0.5cm}\noindent
\textbf{************************* End of Initialization phase *************************}\newline

\newpage
\vspace{0.5cm}\noindent
\textbf{****************** Repeat the steps below for each time step *************************}\newline


\vspace{0.5cm}\noindent
\textbf{Step 5}\newline
Determine $\rho_{i+\half}^n$ as follows:
\begin{equation*}
\rho_{i+\half}^n = \rho_{i+\half}^{n-1} - v_{i+\half}^n \cdot \frac{\Delta t}{\Delta x_{i+\half}} \cdot (\rho_{i+1}^n-\rho_i^n)
\end{equation*}
And similarly for $u_{i+\half}$ from:
\begin{equation*}
u_{i+\half}^n = u_{i+\half}^{n-1} - v_{i+\half}^n \cdot \frac{\Delta t}{\Delta x_{i+\half}} \cdot (u_{i+1}^n-u_i^n)
\end{equation*}



\vspace{0.5cm}\noindent
\textbf{Step 6}\newline
Calculate control volume quantities, $v_i$, from:
Velocity, $v_i$, from:
\begin{equation*}
v_i=
\begin{cases}
v_{i+\half} \frac{A_{i+\half}}{A_i} \quad &, left \ junction  \ missing \\
v_{i-\half} \frac{A_{i-\half}}{A_i} \quad &, right \ junction  \ missing \\
v_{i-\half} \frac{A_{i-\half}}{2A_i} + v_{i+\half} \frac{A_{i+\half}}{2A_i} \quad &, both \ junctions  \ exist \\
\end{cases}
\end{equation*}
\newline
Dynamic viscosity, $\mu_i$, from:
\begin{equation*}
\mu=\mu_{EOS}(P,T)
\end{equation*}
\newline
Reynolds number, $Re_i$, from:
\begin{equation*}
Re_i=\frac{\rho_i^n v_n^n D_{H,i}}{\mu_i^n}
\end{equation*}
\newline
Friction pressure drop, $\Delta P_{\tau}$, from:
\begin{equation*}
\Delta P_{\tau,i}=\frac{1}{2} f_i \rho_i \frac{L_i}{D_{H,i}}v_i^2 
\end{equation*}
\newline
With:
\begin{equation*}
f=
\begin{cases}
6.5\times 10^6 &, Re=0.0 \\
g(Re)=\frac{64}{Re} \quad &,Re\le 2200 \\
h(Re)=\frac{1}{\sqrt{f}}=-2\textrm{log}\biggr( \frac{\epsilon}{3.7D_H}  + \frac{2.51}{Re \sqrt{f}}   \biggr)     \quad &,Re>3000 \\
g(2200)+\frac{h(3000)-g(2200)}{800}. (Re-2200)   \quad &, 2200<Re\le 3000
\end{cases}
\end{equation*}
\newline
Junction pressure drop losses, $E_{loss}$, from:

\begin{equation*}
E_{loss,i+\half}= (\Delta P.A.v)_{i+\half} = \half  K_{i+\half} (\rho A v^3)_{i+\half}     
\end{equation*}


\vspace{1.0cm}\noindent
\textbf{Step 7}\newline
Determine the elements of equation 5:
\begin{equation*}
\frac{\rho_i^{n+1} - \rho_i^{n}}{\Delta t} = \frac{1}{V_i}\biggr[ (\rho.A)_{i-\half}^{n}v_{i-\half}^{n+1}-(\rho.A)_{i+\half}^{n} v_{i+\half}^{n+1} \biggr]
\end{equation*}
\newline
Where the elements are:
\begin{equation*}
\begin{aligned}
B_5&=\frac{\Delta t (\rho.A)_{i-\half}^{n}}{V_i}\\
C_5&=\frac{\Delta t (\rho.A)_{i+\half}^{n}}{V_i}
\end{aligned}
\end{equation*}
\newline
To get:
\begin{equation}
\begin{aligned}
\rho_i^{n+1}&=\rho_i^{n}+B_5.v_{i-\half}^{n+1} - C_5.v_{i+\half}^{n+1}\\
\end{aligned}
\end{equation}




\newpage \noindent
\textbf{Step 8}\newline
Determine the elements of equation 6:
\begin{equation*}
\begin{aligned}
 \frac{\rho_{i+\half}^{n}.v_{i+\half}^{n+1}-\rho_{i+\half}^n.v_{i+\half}^n}{\Delta t} &= \rho_{i+\half}^n\cdot\frac{d_i.(v_{i}^n)^2-d_{i+1}.(v_{i+1}^n)^2}{\Delta x_{i+\half}}     \\
&-\frac{P_{i+1}^{n+1}-P_i^{n+1}}{\Delta x_{i+\half}} +\rho_{i+\half}^n.g_{i+\half} \\
&-\frac{\Delta P_{\tau,i}^n }{2\Delta x_{i+\half}}- \frac{\Delta P_{\tau,i+1}^n }{2\Delta x_{i+\half}} -\frac{\Delta P_{loss,i+\half}^n}{\Delta x_{i+\half}}
\end{aligned}
\end{equation*}
\newline
Where the elements are:
\begin{equation*}
\begin{aligned}
B_6&=\rho_{i+\half}^n.v_{i+\half}^n\\
C_6&=\Delta t\rho_{i+\half}^n\cdot\frac{d_i.(v_{i}^n)^2-d_{i+1}.(v_{i+1}^n)^2}{\Delta x_{i+\half}}\\
D_6&=\frac{\Delta t}{\Delta x_{i+\half}}, \quad E_6=\Delta t \rho_{i+\half}^n.g_{i+\half} \\
F_6&=\frac{\Delta t\Delta P_{\tau,i}^n }{2\Delta x_{i+\half}}, \quad G_6=\frac{\Delta t\Delta P_{\tau,i+1}^n }{2\Delta x_{i+\half}} +\frac{\Delta t\Delta P_{loss,i+\half}^n}{\Delta x_{i+\half}} \\
H_6&=\frac{B_6+C_6+E_6-F_6-G_6}{\rho_{i+\half}^{n}}, \quad I_6=\frac{D6}{\rho_{i+\half}^{n}}
\end{aligned}
\end{equation*}
\newline
To get:
\begin{equation*}
\begin{aligned}
\rho_{i+\half}^{n}.v_{i+\half}^{n+1}=B_6+C_6-D_6.P_{i+1}^{n+1}+D_6.P_{i}^{n+1}+E_6-F_6-G_6
\end{aligned}
\end{equation*}
And:
\begin{equation}
\begin{aligned}
v_{i+\half}^{n+1}=H_6-I_6.P_{i+1}^{n+1}+I_6.P_{i}^{n+1}
\end{aligned}
\end{equation}


\newpage \noindent
\textbf{Step 9}\newline
Determine the elements of equation 7:
\begin{equation*}
\begin{aligned}
\frac{\rho_{i-\half}^{n}.v_{i-\half}^{n+1}-\rho_{i-\half}^n.v_{i-\half}^n}{\Delta t} =& \rho_{i-\half}^n\cdot\frac{d_{i-1}.(v_{i-1}^n)^2-d_{i}.(v_{i}^n)^2}{\Delta x_{i-\half}}     \\
&-\frac{P_{i}^{n+1}-P_{i-1}^{n+1}}{\Delta x_{i-\half}} +\rho_{i-\half}^n.g_{i-\half} \\
&-\frac{\Delta P_{\tau,i-1}^n }{2\Delta x_{i-\half}}- \frac{\Delta P_{\tau,i}^n }{2\Delta x_{i-\half}} -\frac{\Delta P_{loss,i-\half}^n}{\Delta x_{i-\half}} \\
\end{aligned}
\end{equation*}
\newline
Where the elements are:
\begin{equation*}
\begin{aligned}
B_7&=\rho_{i-\half}^n.v_{i-\half}^n\\
C_7&=\Delta t\rho_{i-\half}^n\cdot\frac{d_{i-1}.(v_{i-1}^n)^2-d_{i}.(v_{i}^n)^2}{\Delta x_{i-\half}}\\
D_7&=\frac{\Delta t}{\Delta x_{i-\half}}, \quad E_7=\Delta t \rho_{i-\half}^n.g_{i-\half} \\
F_7&=\frac{\Delta t \Delta P_{\tau,i-1}^n }{2\Delta x_{i-\half}}, \quad G_7=\frac{\Delta t \Delta P_{\tau,i}^n }{2\Delta x_{i-\half}} +\frac{\Delta t \Delta P_{loss,i-\half}^n}{\Delta x_{i-\half}} \\
H_7&=\frac{B_7+C_7+E_7-F_7-G_7}{\rho_{i-\half}^{n}}, \quad I_7=\frac{D7}{\rho_{i-\half}^{n}}
\end{aligned}
\end{equation*}
\newline
To get:
\begin{equation*}
\begin{aligned}
\rho_{i-\half}^{n}.v_{i-\half}^{n+1}=B_7+C_7-D_7.P_{i}^{n+1}+D_7.P_{i-1}^{n+1}+E_7-F_7-G_7
\end{aligned}
\end{equation*}
And:
\begin{equation}
\begin{aligned}
v_{i-\half}^{n+1}=H_7-I_7.P_{i}^{n+1}+I_7.P_{i-1}^{n+1}
\end{aligned}
\end{equation}












\newpage \noindent
\textbf{Step 10}\newline
Determine the elements of equation 8:
\begin{equation*}
\begin{aligned}
 \frac{(\rho_i^{n+1}.u_i^{n+1}-  \rho_i^{n}.u_i^{n})}{\Delta t}&=\frac{1}{V_i}\biggr[ (\rho Au)_{i-\half}^n.v_{i-\half}^{n+1} -(\rho Au)_{i+\half}^n.v_{i+\half}^{n+1} \biggr] \\
&+\frac{1}{V_i}\biggr[ (\rho Agz)_{i-\half}^n.v_{i-\half}^{n+1} -(\rho Agz)_{i+\half}^n.v_{i+\half}^{n+1} \biggr] \\
&+\frac{A_{s,i}}{V_i}\dot{q}_i^n + \frac{1}{V_i}\biggr[   (P.A)_{i-\half}^n.v_{i-\half}^{n+1} - (P.A)_{i+\half}^n.v_{i+\half}^{n+1}   \biggr] \\
&- \frac{E_{loss,i}^n}{V_i} \\
\end{aligned}
\end{equation*}
\newline
Where the elements are:
\begin{equation*}
\begin{aligned}
C_8&=\frac{\Delta t (\rho Au)_{i-\half}^n}{V_i}, \quad D_8=\frac{\Delta t (\rho Au)_{i+\half}^n}{V_i} \\
E_8&=\frac{\Delta t (\rho Agz)_{i-\half}^n}{V_i}, \quad F_8=\frac{\Delta t (\rho Agz)_{i+\half}^n}{V_i}\\
G_8&=\frac{\Delta t A_{s,i}}{V_i}\dot{q}_i^n \\
H_8&=\frac{\Delta t (P.A)_{i-\half}^n}{V_i}, \quad I_8=\frac{\Delta t (P.A)_{i+\half}^n}{V_i} \\
J_8&=\frac{\Delta t E_{loss,i}^n}{V_i} \\
K_8&=G_8-J_8 \\
L_8&=C_8+E_8+H_8 \\
M_8&=D_8+F_8+I_8
\end{aligned}
\end{equation*}
\newline
To get:
\begin{equation*}
\begin{aligned}
\rho_i^{n+1}.u_i^{n+1}-\rho_i^{n}.u_i^{n}=C_8.v_{i-\half}^{n+1}-D_8.v_{i+\half}^{n+1}+E_8.v_{i-\half}^{n+1}-F_8.v_{i+\half}^{n+1}+G_8+H_8.v_{i-\half}^{n+1}-I_8.v_{i+\half}^{n+1}-J_8
\end{aligned}
\end{equation*}
And:
\begin{equation}
\begin{aligned}
\rho_i^{n+1}.u_i^{n+1}-\rho_i^{n}.u_i^{n}=K_8+L_8.v_{i-\half}^{n+1}-M_8.v_{i+\half}^{n+1}
\end{aligned}
\end{equation}








\newpage \noindent
\textbf{Step 11}\newline
Determine the elements of equation 9:
\begin{equation*}
\begin{aligned}
 \rho_{i}^{n+1}u_{i}^{n+1} - \rho_{i}^{n}u_{i}^{n} = \frac{d(\rho_i^n u_i^{n})}{d\rho} \cdot (\rho_i^{n+1}-\rho_i^n)  
\end{aligned}
\end{equation*}
\newline
Where the elements are:
\begin{equation*}
\begin{aligned}
B_9&=\frac{d(\rho_i^n u_i^{n})}{d\rho}=\frac{\rho_{EOS}(P_i^n,T_i^n+\Delta T) u_{EOS}(P_i^n,T_i^n+\Delta T)-\rho_{EOS}(P_i^n,T_i^n-\Delta T) u_{EOS}(P_i^n,T_i^n-\Delta T)}{\rho_{EOS}(P_i^n,T_i^n+\Delta T)-\rho_{EOS}(P_i^n,T_i^n-\Delta T)} \\
C_9&=B_9.\rho_i^n \\
\end{aligned}
\end{equation*}
\newline
To get:
\begin{equation}
\begin{aligned}
\rho_{i}^{n+1}u_{i}^{n+1} - \rho_{i}^{n}u_{i}^{n} = B_9.\rho_{i}^{n+1}-C_9
\end{aligned}
\end{equation}







\newpage \noindent
\textbf{Step 12}\newline
Reduce the given equations to a single equation. This is possible because we have the following set of equations:

\begin{equation*}
\begin{aligned}
&eq \ 10, \quad \rho_i^{n+1}=\rho_i^{n}+B_5.v_{i-\half}^{n+1} - C_5.v_{i+\half}^{n+1}\\
&eq \ 11, \quad v_{i+\half}^{n+1}=H_6-I_6.P_{i+1}^{n+1}+I_6.P_{i}^{n+1} \\
&eq \ 12, \quad v_{i-\half}^{n+1}=H_7-I_7.P_{i}^{n+1}+I_7.P_{i-1}^{n+1} \\
&eq \ 13, \quad \rho_i^{n+1}u_i^{n+1}-\rho_i^{n}.u_i^{n}= K_8+L_8.v_{i-\half}^{n+1}-M_8.v_{i+\half}^{n+1}\\
&eq \ 14, \quad \rho_{i}^{n+1}u_{i}^{n+1} - \rho_{i}^{n}u_{i}^{n} = B_9.\rho_{i}^{n+1}-C_9
\end{aligned}
\end{equation*}
\newline
Now the reduction goal is find the unknowns in equation 13 by locally solving the set of equations until only the pressures remain, i.e. $P_{i-1}^{n+1}$, $P_{i}^{n+1}$ and $P_{i+1}^{n+1}$.
\newline
\newline
We start by inserting equation 11 and 12 into 10:

\begin{equation*}
\begin{aligned}
\rho_i^{n+1}&=\rho_i^{n}+B_5.\biggr( H_7-I_7.P_{i}^{n+1}+I_7.P_{i-1}^{n+1} \biggr)- C_5.\biggr(H_6-I_6.P_{i+1}^{n+1}+I_6.P_{i}^{n+1} \biggr) \\
&=\rho_i^n + B_5 H_7 - B_5 I_7 . P_{i}^{n+1} + B_5 I_7 . P_{i-1}^{n+1} - C_5 H_6 + C_5 I_6.P_{i+1}^{n+1} - C_5 I_6.P_{i}^{n+1} \\
&=\rho_i^n + B_5 H_7 - C_5 H_6 + B_5 I_7 . P_{i-1}^{n+1} - B_5 I_7 . P_{i}^{n+1} - C_5 I_6.P_{i}^{n+1} + C_5 I_6.P_{i+1}^{n+1} \\
&=\biggr( \rho_i^n + B_5 H_7 - C_5 H_6  \biggr) + \biggr( B_5 I_7 \biggr) P_{i-1}^{n+1} - \biggr(B_5 I_7 + C_5 I_6    \biggr) P_{i}^{n+1}+ \biggr(  C_5 I_6  \biggr) P_{i+1}^{n+1}
\end{aligned}
\end{equation*}
\newline
More simplistically we define:

\begin{equation*}
\begin{aligned}
B_{10} &=  \rho_i^n + B_5 H_7 - C_5 H_6 \\
C_{10} &=   B_5 I_7 \\
D_{10} &=  B_5 I_7 + C_5 I_6  \\
E_{10} &=  C_5 I_6 \\
\end{aligned}
\end{equation*}
\newline
To arrive at:

\begin{equation}
\begin{aligned}
\rho_i^{n+1}=B_{10} + C_{10}. P_{i-1}^{n+1} - D_{10}. P_{i}^{n+1}+ E_{10}. P_{i+1}^{n+1}
\end{aligned}
\end{equation}
\newline




\newpage
Next we aim to eliminate the internal energy by inserting equation 14 into equation 13:
\begin{equation*}
\begin{aligned}
B_9.\rho_{i}^{n+1}-C_9= K_8+L_8.v_{i-\half}^{n+1}-M_8.v_{i+\half}^{n+1}\\
\end{aligned}
\end{equation*}
\newline
For simplicity we define:

\begin{equation*}
\begin{aligned}
B_{14} =  \frac{K_8+C_9}{B_9} \quad
C_{14} =   \frac{L_8}{B_9}  \quad
D_{14} =   \frac{M_8}{B_9}  \\
\end{aligned}
\end{equation*}
\newline
To get:

\begin{equation*}
\rho_{i}^{n+1}=B_{14}+C_{14}.v_{i-\half}^{n+1}-D_{14}.v_{i+\half}^{n+1}
\end{equation*}
\newline
We need to also insert equations 11 and 12:
\begin{equation*}
\begin{aligned}
\rho_{i}^{n+1}&=B_{14}+C_{14}.\biggr( H_7-I_7.P_{i}^{n+1}+I_7.P_{i-1}^{n+1}  \biggr)-D_{14}.\biggr( H_6-I_6.P_{i+1}^{n+1}+I_6.P_{i}^{n+1}   \biggr) \\
              &=B_{14}+C_{14} H_7 - C_{14} I_7.P_{i}^{n+1} + C_{14} I_7.P_{i-1}^{n+1} - D_{14} H_6 + D_{14} I_6.P_{i+1}^{n+1} - D_{14} I_6.P_{i}^{n+1} \\
              &=B_{14}+C_{14} H_7 - D_{14} H_6 + C_{14} I_7.P_{i-1}^{n+1} - C_{14} I_7.P_{i}^{n+1} - D_{14} I_6.P_{i}^{n+1} + D_{14} I_6.P_{i+1}^{n+1} \\
              &=\biggr( B_{14}+C_{14} H_7 - D_{14} H_6 \biggr) + \biggr( C_{14} I_7 \biggr).P_{i-1}^{n+1} - \biggr(C_{14} I_7 + D_{14} I_6 \biggr).P_{i}^{n+1} + \biggr( D_{14} I_6 \biggr).P_{i+1}^{n+1} \\
\end{aligned}
\end{equation*}


Again we define:

\begin{equation*}
\begin{aligned}
E_{14} &=  B_{14}+C_{14} H_7 - D_{14} H_6  \\
F_{14} &=  C_{14} I_7    \\
G_{14} &=  C_{14} I_7 + D_{14} I_6  \\
H_{14} &=  D_{14} I_6  \\
\end{aligned}
\end{equation*}
\newline
To get:

\begin{equation}
\rho_{i}^{n+1}=E_{14} +F_{14}.P_{i-1}^{n+1} - G_{14}.P_{i}^{n+1} + H_{14}.P_{i+1}^{n+1}
\end{equation}
\newline




\newpage
\noindent
Now all thats left is to equate equation 15 and 16:

\begin{equation*}
B_{10} + C_{10}. P_{i-1}^{n+1} - D_{10}. P_{i}^{n+1}+ E_{10}. P_{i+1}^{n+1}=E_{14} +F_{14}.P_{i-1}^{n+1} - G_{14}.P_{i}^{n+1} + H_{14}.P_{i+1}^{n+1} 
\end{equation*}
\begin{equation*}
C_{10}. P_{i-1}^{n+1} - F_{14}.P_{i-1}^{n+1} + G_{14}.P_{i}^{n+1} - D_{10}. P_{i}^{n+1}+ E_{10}. P_{i+1}^{n+1} - H_{14}.P_{i+1}^{n+1}=E_{14} - B_{10}
\end{equation*}
\newline
We now have a single equation for each control volume:
\begin{equation}
\biggr( C_{10}-F_{14} \biggr)P_{i-1}^{n+1}   + \biggr( G_{14} - D_{10} \biggr)P_{i}^{n+1}+ \biggr( E_{10} - H_{14} \biggr)P_{i+1}^{n+1} = E_{14} - B_{10}
\end{equation}









\vspace{0.5cm}\noindent
\textbf{Step 13}\newline
Using equation 17, in the form $\quad a_i.P_{i-1}^{n+1} + b_i.P_{i}^{n+1} + c_i.P_{i+1}^{n+1} = d_i \quad $ we can construct a linear system $Ax=b$ as follows:

\begin{equation*}
A=
\begin{bmatrix}
b_1    & c_1     & \cdots & \cdots & \cdots & 0      \\
a_2    & b_2     & c_2    & \cdots & \cdots & \vdots \\
\vdots &         & \ddots &        &        & \vdots \\
\vdots &         &        & \ddots &        & \vdots \\
\vdots &         &        &a_{I-1} &b_{I-1} &c_{I-1}  \\
0      & \cdots  & \cdots & \cdots & a_I    & b_I 
\end{bmatrix}
x=
\begin{bmatrix}
P_1^{n+1} \\
P_2^{n+1} \\
\vdots \\
\vdots \\
P_{I-1}^{n+1} \\
P_I^{n+1} 
\end{bmatrix}
b=
\begin{bmatrix}
d1 \\
d2 \\
\vdots \\
\vdots \\
d_{I-1}\\
d_I
\end{bmatrix}
\end{equation*}
\newline
This system can be solved using a conjugate gradient numerical solver.


\newpage
\noindent
\textbf{Step 14}\newline
Calculate junction velocities from equation 11:

\begin{equation*}
v_{i+\half}^{n+1}=H_6-I_6.P_{i+1}^{n+1}+I_6.P_{i}^{n+1}
\end{equation*}







\vspace{0.5cm}\noindent
\textbf{Step 15}\newline
Calculate control volume new densities from equation 10:

\begin{equation*}
\begin{aligned}
\rho_i^{n+1}&=\rho_i^{n}+B_5.v_{i-\half}^{n+1} - C_5.v_{i+\half}^{n+1}\\
\end{aligned}
\end{equation*}





\vspace{0.5cm}\noindent
\textbf{Step 16}\newline
Calculate control volume new internal energies from equation 14:

\begin{equation*}
\begin{aligned}
\rho_{i}^{n+1}u_{i}^{n+1} - \rho_{i}^{n}u_{i}^{n} &= B_9.\rho_{i}^{n+1}-C_9 \\
\rho_{i}^{n+1}u_{i}^{n+1} &= \rho_{i}^{n}u_{i}^{n}-C_9 + B_9.\rho_{i}^{n+1} \\
\therefore u_{i}^{n+1} &= \frac{\rho_{i}^{n}u_{i}^{n}-C_9}{\rho_{i}^{n+1}} + B_9 \\
\end{aligned}
\end{equation*}




\vspace{0.5cm}\noindent
\textbf{Step 17}\newline
Advance the time values.










\newpage
\chead{3 Test cases}
\section{Test cases}
In order to test various aspects of the thermal-hydraulic code it is necessary to construct a collection of test cases. These are:

\begin{enumerate}
\item Simple horizontal flow. No heat transfer, no junction form loss.
\item Simple horizontal flow with junction form loss.
\item Horizontal flow with heat transfer.
\item Vertical flow without heat transfer.
\item Vertical flow with heat transfer.
\end{enumerate}
\vspace{0.5cm}\noindent
For all these cases, let us use the following geometry:

	\begin{center}
		\begin{minipage}[c]{0.85\textwidth}
	
			\begin{figure}[H]
			
				\includegraphics[width=6in]{ZZZ_TestCase.png}
				\caption{Test case geometry.}
				\label{figure:ZZZ_TestCase}
			\end{figure}
		\end{minipage}
	\end{center}
\vspace{0.5cm}













\newpage
\chead{Heat block submodel}
\section{Heat block submodel}

\subsection{The heat conduction equation}
The generalized heat conduction equation takes the following form:

\begin{equation}
\frac{dT}{dt}=\alpha \nabla^2 T + \frac{1}{\rho  C_p}\dot{e}_{gen}
\end{equation}
\newline
In slab geometry this equation takes the form:

\begin{equation}
\frac{dT}{dt}=\frac{1}{\rho  C_p} \frac{d}{dx} \biggr( k \frac{dT}{dx} \biggr) + \frac{1}{\rho  C_p}\dot{e}_{gen}
\end{equation}
\newline
And in cylindrical geometry this equation takes the form:

\begin{equation}
\frac{dT}{dt}=\frac{1}{\rho  C_p}\frac{1}{r} \frac{d}{dr} \biggr( k.r.\frac{dT}{dr} \biggr) + \frac{1}{\rho  C_p}\dot{e}_{gen}
\end{equation}
\newline
Typical boundary conditions for such second order differential equations are the symmetry or insulated boundary condition:

\begin{equation*}
\frac{dT}{dx}\biggr|_{L}=0 \quad or \quad \frac{dT}{dr}\biggr|_{R}=0
\end{equation*}
\newline
The constant temperature boundary condition:

\begin{equation*}
\frac{dT}{dt}\biggr|_{L}=0 \quad or \quad \frac{dT}{dt}\biggr|_{R}=0
\end{equation*}
\newline
And the surface convection boundary condition:

\begin{equation*}
k\frac{dT}{dx}\biggr|_L^{+,-}=h(T_L - T_{\inf})
\end{equation*}
\begin{equation*}
or
\end{equation*}
\begin{equation*}
k\frac{dT}{dr}\biggr|_R^{+,-}=h(T_R - T_{\inf})
\end{equation*}
\newline



\newpage
\subsection {Numerical form of the heat conduction equation}
Consider the nodalization as shown in Figure \ref{figure:ZZZ_HeatBlock} below.

	\begin{center}
		\begin{minipage}[c]{0.85\textwidth}
	
			\begin{figure}[H]
			
				\includegraphics[width=6in]{ZZZ_HeatBlock.png}
				\caption{Heat block nodalization.}
				\label{figure:ZZZ_HeatBlock}
			\end{figure}
		\end{minipage}
	\end{center}
\vspace{0.5cm}
\noindent
\begin{comment}
We can linearize the derivatives of equation 19 as follows:

\begin{equation*}
\begin{aligned}
\frac{T_n^{t+1}-T_n^t}{\Delta t} = \frac{1}{\rho_n C_{p,n}} \frac{1}{\Delta x_n} \biggr(  k_i^t \frac{T_{n+1}^{t+1} - T_{n}^{t+1}}{\Delta x_i}  - k_{i-1}^t \frac{T_{n}^{t+1} - T_{n-1}^{t+1}}{\Delta x_{i-1}} \biggr) + \frac{1}{\rho_n C_{p,n}} \dot{e}_{gen,n}^t
\end{aligned}
\end{equation*}
\newline
Similarly, we can linearize the derivatives of equation 20 as follows:
\end{comment}
We can linearize the derivatives of equation 20 as follows:

\begin{equation}
\begin{aligned}
\frac{T_n^{t+1}-T_n^t}{\Delta t} = \frac{1}{\rho_n C_{p,n}} \frac{1}{r_n\Delta r_n} \biggr(  k_i^t.r_i. \frac{T_{n+1}^{t+1} - T_{n}^{t+1}}{\Delta r_i}  - k_{i-1}^t.r_{i-1} \frac{T_{n}^{t+1} - T_{n-1}^{t+1}}{\Delta r_{i-1}} \biggr) + \frac{1}{\rho_n C_{p,n}} \dot{e}_{gen,n}^t
\end{aligned}
\end{equation}
\newline
In this formulation the points $r_1,r_2,\dots,r_N$ are defined by the user. $\Delta r_i$ is defined only on intervals. The value of $r_i$ is the halfway point between the nodes on either side of the interval. The values of $\rho_n$ and $C_{p,n}$ are calculated from the arithmetic average of the adjoining intervals as follows:

\begin{equation*}
\begin{aligned}
\rho_n=\frac{(r_n+\half \Delta r_n)^2  -  (r_n)^2}{r_{i=n-1}^2-r_{i=n}^2} \cdot \rho_{i=n-1}
      +\frac{(r_n)^2  -  (r_n-\half \Delta r_n)^2}{r_{i=n-1}^2-r_{i=n}^2} \cdot \rho_{i=n}
\end{aligned}
\end{equation*}

\begin{equation*}
\begin{aligned}
C_{p,n}=\frac{(r_n+\half \Delta r_n)^2  -  (r_n)^2}{r_{i=n-1}^2-r_{i=n}^2} \cdot C_{p,i=n-1}
      +\frac{(r_n)^2  -  (r_n-\half \Delta r_n)^2}{r_{i=n-1}^2-r_{i=n}^2} \cdot C_{p,i=n}
\end{aligned}
\end{equation*}

\begin{equation*}
\begin{aligned}
\dot{e}_{gen,n}=\frac{(r_n+\half \Delta r_n)^2  -  (r_n)^2}{r_{i=n-1}^2-r_{i=n}^2} \cdot \dot{e}_{gen,i=n-1}
               +\frac{(r_n)^2  -  (r_n-\half \Delta r_n)^2}{r_{i=n-1}^2-r_{i=n}^2} \cdot \dot{e}_{gen,i=n}
\end{aligned}
\end{equation*}






\newpage
\subsection{Solution algorithm}
\vspace{0.5cm}\noindent
\textbf{Step 1}\newline
Load all heat block:
\begin{itemize}
\item Load mesh points, $r_n$, and initial temperatures, $T_n^t$
\item Calculate $\Delta r_n$ and $\Delta r_i$
\item Calculate intervals, $r_i$
\item Load thermal properties, $k_i$, $C_{p,i}$ and $\rho_i$
\item Load initial temperature, $T_n$
\item Set boundary conditions, $Convection$, $Symmetry$ or $Temperature$
\item Set interval heat generation, $\dot{e}_{gen,n}$
\end{itemize}

\vspace{0.5cm}\noindent
\textbf{************************* End of Initialization phase *************************}\newline

\vspace{0.5cm}\noindent
\textbf{****************** Repeat the steps below for each time step *************************}\newline


\vspace{0.5cm}\noindent
\textbf{Step 2}\newline
Set thermal conditions:
\begin{itemize}
\item Set boundary conditions, $Convection(h,T_{\inf})$, $Symmetry$ or $Temperature(T)$
\item Set interval heat generation, $\dot{e}_{gen,n}$
\end{itemize}




\vspace{0.5cm}\noindent
\textbf{Step 3a - Inner mesh points}\newline
Determine the elements of equation 21:
\begin{equation*}
\begin{aligned}
\frac{T_n^{t+1}-T_n^t}{\Delta t} = \frac{1}{\rho_n C_{p,n}} \frac{1}{r_n\Delta r_n} \biggr(  k_i^t.r_i. \frac{T_{n+1}^{t+1} - T_{n}^{t+1}}{\Delta r_i}  - k_{i-1}^t.r_{i-1} \frac{T_{n}^{t+1} - T_{n-1}^{t+1}}{\Delta r_{i-1}} \biggr) + \frac{1}{\rho_n C_{p,n}} \dot{e}_{gen,n}^t
\end{aligned}
\end{equation*}
\newline
Where the elements are:
\begin{equation*}
\begin{aligned}
B_{21}&=\frac{\Delta t}{\rho_n C_{p,n}} \cdot \frac{k_i^t.r_i        }{r_n.\Delta r_n.\Delta r_i}
 \quad and \quad
C_{21} =\frac{\Delta t}{\rho_n C_{p,n}} \cdot \frac{k_i^t.r_i        }{r_n.\Delta r_n.\Delta r_i} \\
D_{21}&=\frac{\Delta t}{\rho_n C_{p,n}} \cdot \frac{k_{i-1}^t.r_{i-1}}{r_n.\Delta r_n.\Delta r_{i-1}}
 \quad and \quad
E_{21}=\frac{\Delta t}{\rho_n C_{p,n}} \cdot \frac{k_{i-1}^t.r_{i-1}}{r_n.\Delta r_n.\Delta r_{i-1}}\\ 
F_{21}&=\frac{\Delta t}{\rho_n C_{p,n}} \dot{e}_{gen,n}^t
\end{aligned}
\end{equation*}
\newline
To get:
\begin{equation*}
\begin{aligned}
\therefore T_n^{t+1}-T_n^t&= B_{21}.T_{n+1}^{t+1} - C_{21}.T_{n}^{t+1}    
			    - D_{21}.T_{n}^{t+1} + E_{21}.T_{n-1}^{t+1}   
			    + F_{21}        
\end{aligned}
\end{equation*}
With further simplification we can write this as:

\begin{equation*}
\begin{aligned}
-E_{21}.T_{n-1}^{t+1} 
+ T_n^{t+1} + C_{21}.T_{n}^{t+1} + D_{21}.T_{n}^{t+1}
-B_{21}.T_{n+1}^{t+1}
=F_{21} + T_n^t \\
\end{aligned}
\end{equation*}
\newline
And finally:
\begin{equation}
\begin{aligned}
\biggr( -E_{21} \biggr)T_{n-1}^{t+1}
+ \biggr(1 + C_{21} + D_{21} \biggr) T_{n}^{t+1}
+ \biggr( -B_{21} \biggr)T_{n+1}^{t+1}
=\biggr( F_{21} + T_n^t \biggr) \\
\end{aligned}
\end{equation}







\vspace{0.5cm}\noindent
\textbf{Step 3b - Left convection boundary condition}\newline
This is the same as \textbf{step 3a} but with a change. For a convection boundary condition the following applies:

\begin{equation*}
k_{i-1}^t.r_{i-1} \frac{T_{n}^{t+1} - T_{n-1}^{t+1}}{\Delta r_{i-1}} \quad \to \quad h_n^t.r_n (T_{n}^{t+1}-T_{\inf,n})
\end{equation*}
\newline
Therefore, $E_{21}$ is zero and $D_{21}$ becomes:

\begin{equation*}
D_{21}=\frac{\Delta t}{\rho_n C_{p,n}} \cdot \frac{h_n^t}{\Delta r_n}
\end{equation*}
\newline 
Also $F_{21}$ now receives the known contribution from $T_{inf,n}$ and becomes:

\begin{equation*}
F_{21}=\frac{\Delta t}{\rho_n C_{p,n}} \dot{e}_{gen,n}^t + D_{21}.T_{\inf,n}
\end{equation*}




\vspace{0.5cm}\noindent
\textbf{Step 3c - Right symmetry boundary condition}\newline
This is the same as \textbf{step 3a} but with a change. For a symmetry boundary condition the following applies:

\begin{equation*}
k_i^t.r_i. \frac{T_{n+1}^{t+1} - T_{n}^{t+1}}{\Delta r_i} \quad \to \quad 0 
\end{equation*}
\newline
Therefore, $B_{21}$ and $C_{21}$ is zero with no changes to $F_{21}$.






\newpage
\vspace{0.5cm}\noindent
\textbf{Step 4}\newline
Using equation 22, in the form $\quad a_i.T_{n-1}^{t+1} + b_i.T_{n}^{t+1} + c_i.T_{n+1}^{t+1} = d_i \quad $ we can construct a linear system $Ax=b$ as follows:

\begin{equation*}
A=
\begin{bmatrix}
b_1    & c_1     & \cdots & \cdots & \cdots & 0      \\
a_2    & b_2     & c_2    & \cdots & \cdots & \vdots \\
\vdots &         & \ddots &        &        & \vdots \\
\vdots &         &        & \ddots &        & \vdots \\
\vdots &         &        &a_{I-1} &b_{I-1} &c_{I-1}  \\
0      & \cdots  & \cdots & \cdots & a_I    & b_I 
\end{bmatrix}
x=
\begin{bmatrix}
P_1^{n+1} \\
P_2^{n+1} \\
\vdots \\
\vdots \\
P_{I-1}^{n+1} \\
P_I^{n+1} 
\end{bmatrix}
b=
\begin{bmatrix}
d1 \\
d2 \\
\vdots \\
\vdots \\
d_{I-1}\\
d_I
\end{bmatrix}
\end{equation*}
\newline
This system can be solved using a conjugate gradient numerical solver.









\newpage
\chead{References}
\begin{thebibliography}{1}

	
\end{thebibliography}





\end{document}