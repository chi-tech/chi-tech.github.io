<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Coding Tutorial 2 - Using ghosted vectors</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dd/d89/_code_tut2.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Coding Tutorial 2 - Using ghosted vectors </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Table of contents</h2>
<ul>
<li><a class="el" href="../../dd/d89/_code_tut2.html#CodeTut2Sec1">1 Ghost cell's in ChiTech</a></li>
<li><a class="el" href="../../dd/d89/_code_tut2.html#CodeTut2Sec2">2 Computing the gradient of a Finite Volume Scalar</a></li>
<li><a class="el" href="../../dd/d89/_code_tut2.html#CodeTut2Sec3">3 Making a ghosted vector and communicating ghosted data</a></li>
<li><a class="el" href="../../dd/d89/_code_tut2.html#CodeTut2Sec4">4 Accessing ghosted data</a></li>
<li><a class="el" href="../../dd/d89/_code_tut2.html#CodeTut2Sec5">5 Visualizing the gradient</a></li>
<li><a class="el" href="../../dd/d89/_code_tut2.html#CodeTut2Sec6">The complete program</a></li>
</ul>
<h1><a class="anchor" id="CodeTut2Sec1"></a>
1 Ghost cell's in ChiTech</h1>
<p >For the discussions that follow refer to the schematic in the figure below. </p><div class="image">
<img src="../../GhostCells.png" alt="" width="800px"/>
</div>
<p >The concept of ghost cells is quite important in ChiTech, as is the case with any scientific computing library that runs in parallel. Ghost cells arises because it is often required to partition a mesh among different processors in order to more effectively leverage the distributed memory models of HPCs.</p>
<p ><b>Definition: In ChiTech a ghost cell is a cell that shares a face or a vertex with cells partitioned to be local to a given processor</b>. We can observe these cells in the schematic above. This definition requires us to store the first layer of cells beyond the locally owned cells, as well as their accompanying vertices. This allows us to have the complete geometrical information of those ghost cells. Because some numerical schemes often require us to map indices to ghost nodes/cells, this storage scheme, is considered very much necessary.</p>
<p >In this coding tutorial we will be looking at the basics of using the spatial discretization methods (SD methods) to gain access to ghost data, which can be very difficult.</p>
<h1><a class="anchor" id="CodeTut2Sec2"></a>
2 Computing the gradient of a Finite Volume Scalar</h1>
<p >In the finite volume SD scheme the computation of the gradient of a scalar quantity can often be required. We will use <a class="el" href="../../dc/da4/_code_tut1.html">Coding Tutorial 1 - Poisson's problem with Finite Volume</a> as a reference for this tutorial and assume that we are adding code to this tutorial.</p>
<p >Given that we want \( \boldsymbol{\nabla} \phi \), how do we do this in ChiTech for the Finite Volume SD? Well the first thing to do is to note that, from Gauss's Divergence Theorem, </p><p class="formulaDsp">
\[ \int_V \boldsymbol{\nabla} \phi dV = \int_S \mathbf{n} \phi dA \]
</p>
<p> Now, if the storage of \( \boldsymbol{\nabla} \phi \) also follows the Finite Volume SD, then \( \boldsymbol{\nabla} \phi \) will be constant on cell \( P \), therefore </p><p class="formulaDsp">
\[ \int_S \mathbf{n} \phi dA = V_P \biggr( \boldsymbol{\nabla} \phi \biggr)_P \]
</p>
<p> from which we can discretize the surface integral to get </p><p class="formulaDsp">
\[ \biggr( \boldsymbol{\nabla} \phi \biggr)_P = \frac{1}{V_P} \sum_f A_f \mathbf{n}_f \phi_f \]
</p>
<p> Now our first problem is to find \( \phi_f \), considering additionally that we might not have an equally spaced mesh. Consider the diagram below</p>
<div class="image">
<img src="../../SqueezedHexes.png" alt="" width="150px"/>
</div>
<p >we can now define \( \phi_f \) as a geometrically weighted average of \( \phi_N \) and \( \phi_P \) by using the face centroid, \( \mathbf{x}_f \). Therefore, </p><p class="formulaDsp">
\[ \phi_f = \frac{1}{|| \mathbf{x}_N - \mathbf{x}_P ||} \biggr( (|| \mathbf{x}_N - \mathbf{x}_f ||) \phi_P + (|| \mathbf{x}_f - \mathbf{x}_P ||) \phi_N \biggr) \]
</p>
<p >Here we can see that we would have a problem if \( \phi_N \) is not locally available, i.e., it is a ghost value. Therefore we need a means to obtain this value.</p>
<h1><a class="anchor" id="CodeTut2Sec3"></a>
3 Making a ghosted vector and communicating ghosted data</h1>
<p >Ghost value communication is handled via a <code><a class="el" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html">chi_math::VectorGhostCommunicator</a></code> object. These objects require quite a bit of MPI communication during initializing but thereafter can be re-used efficiently on different vectors (as long as they share the intended structure of the ghost-communicator).</p>
<p >In order to gain access to <code><a class="el" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html">chi_math::VectorGhostCommunicator</a></code> we first include the header </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d7b/vector__ghost__communicator_8h.html">ChiMath/VectorGhostCommunicator/vector_ghost_communicator.h</a>&quot;</span></div>
<div class="ttc" id="avector__ghost__communicator_8h_html"><div class="ttname"><a href="../../df/d7b/vector__ghost__communicator_8h.html">vector_ghost_communicator.h</a></div></div>
</div><!-- fragment --><p >Next we add the following code: </p><div class="fragment"><div class="line"><span class="comment">//============================================= Make ghosted vectors</span></div>
<div class="line">std::vector&lt;int64_t&gt; ghost_ids = sdm.GetGhostDOFIndices(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html">chi_math::VectorGhostCommunicator</a> vgc(num_local_dofs,</div>
<div class="line">                                      num_globl_dofs,</div>
<div class="line">                                      ghost_ids,</div>
<div class="line">                                      MPI_COMM_WORLD);</div>
<div class="line">std::vector&lt;double&gt; field_wg = vgc.MakeGhostedVector(field);</div>
<div class="line"> </div>
<div class="line">vgc.CommunicateGhostEntries(field_wg);</div>
<div class="ttc" id="aclasschi__math_1_1_vector_ghost_communicator_html"><div class="ttname"><a href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html">chi_math::VectorGhostCommunicator</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/d7b/vector__ghost__communicator_8h_source.html#l00014">vector_ghost_communicator.h:15</a></div></div>
</div><!-- fragment --><p> The first item on the agenda is "what ghost data to include in a local vector?". To obtain the relevant ghost DOF-ids we ask the SD to provide us with the necessary information with a call to <code><a class="el" href="../../dd/d1d/classchi__math_1_1_spatial_discretization.html#a0582b126ad52631de0a67e3378867dde">chi_math::SpatialDiscretization::GetGhostDOFIndices</a></code>. Note this routine requires as a parameter a structure of unknowns, which is why we supply the configuration <code>OneDofPerNode</code>.</p>
<p >Next we construct the <code><a class="el" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html">chi_math::VectorGhostCommunicator</a></code>. The constructor of this object requires the number of local DOFs, the number of global DOFs, and the global-ids of the ghosted data. Finally a communicator specification is required. The construction of this object initializes data structures that will make repeated communications very efficient.</p>
<p >Given that we now have the ghost-communicator we can now create a vector that has enough space for the local data AND the ghost data. This is done with a call to <code><a class="el" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html#a3f86fa817a46f929551fa2ab40714676">chi_math::VectorGhostCommunicator::MakeGhostedVector</a></code> which is overloaded to accept a vector containing only local data. This allows us, in this case, to make a ghosted vector, <code>field_wg</code>, with the local entries the same as <code>field</code> but with additional zeros representing the ghost values.</p>
<p >Finally we communicate ghost entries, of a given vector, with a call to <code><a class="el" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html#a010313029a9a9e458a8d0df08346bc42">chi_math::VectorGhostCommunicator::CommunicateGhostEntries</a></code>. Next we will look at how we are going to access the ghost values.</p>
<h1><a class="anchor" id="CodeTut2Sec4"></a>
4 Accessing ghosted data</h1>
<p >As a reminder, consider that a call to <code><a class="el" href="../../dd/d1d/classchi__math_1_1_spatial_discretization.html#a6b8904300ab5bb7624c0521b11828272">chi_math::SpatialDiscretization::MapDOF</a></code> provides the <b>global-id</b> of a DOF whereas <code><a class="el" href="../../dd/d1d/classchi__math_1_1_spatial_discretization.html#ab1c21223f44661906bc3223676b6cd84">chi_math::SpatialDiscretization::MapDOFLocal</a></code> provides the <b>local-id</b> of a DOF. Ghost data is, by its nature, not normally a local quantity. Therefore, one would assume that a call to <code>MapDOFLocal</code> would provide an invalid address for ghost-DOFs, however, there is a catch. The id provided by <code>MapDOFLocal</code> maps to a location aligned with the call to <code>GetGhostDOFIndices</code>. For example, consider there are 100 local-DOFs, and 15 ghost-DOFs on a given processor. A call to <code>GetGhostDOFIndices</code> would return 15 indices. Now lets say we want the local-id of the 9-th ghost-DOF. In this case a call to <code>MapDOFLocal</code> will return 100+8, because the 9-th ghost-DOF has an index of 8 in the list of ghost-ids.</p>
<p >We will now use this concept in the computation of the gradient of \( \phi \).</p>
<p >First we create a vector that can store the x, y and z components of the gradient. The size of this vector, as well as mappings into it, will be provided by the SD and therefore we need to make a <code><a class="el" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a></code> to dictate the structure of the unknowns. Therefore we do the following: </p><div class="fragment"><div class="line"><a class="code hl_class" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a> grad_uk_man(</div>
<div class="line">    {<a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da28d37be09a3d36f452147d018301ee87">chi_math::UnknownType::VECTOR_3</a>)});</div>
<div class="ttc" id="aclasschi__math_1_1_unknown_html"><div class="ttname"><a href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3b/unknown__manager_8h_source.html#l00031">unknown_manager.h:32</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_unknown_manager_html"><div class="ttname"><a href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3b/unknown__manager_8h_source.html#l00107">unknown_manager.h:108</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ad4724873fa5ae74b39c4657aa4f53d1da28d37be09a3d36f452147d018301ee87"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da28d37be09a3d36f452147d018301ee87">chi_math::UnknownType::VECTOR_3</a></div><div class="ttdeci">@ VECTOR_3</div></div>
</div><!-- fragment --><p >Next we get the size of the vector and instantiate it </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> num_grad_dofs = sdm.GetNumLocalDOFs(grad_uk_man);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;double&gt; grad_phi(num_grad_dofs, 0.0);</div>
</div><!-- fragment --><p >Since we already have ghosted data we are now ready to compute the gradient on a cell-by-cell basis. We do this with the following code: </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> int64_t imap = sdm.MapDOFLocal(cell, 0);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>  phi_P = field_wg[imap];</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xp = cell.centroid;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> grad_phi_P = <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ae9d5df571cd219e6731bcd6d74c85af4">chi_mesh::Vector3</a>(0,0,0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">size_t</span> f=0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; face : cell.faces)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xf = face.centroid;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>  Af = cell_mapping.FaceArea(f) * face.normal;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> phi_N = 0.0;</div>
<div class="line">    <span class="keyword">auto</span> xn = xp + 2*(xf-xp);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (face.has_neighbor)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line">      <span class="keyword">const</span> int64_t nmap = sdm.MapDOFLocal(adj_cell, 0);</div>
<div class="line">      phi_N = field_wg[nmap];</div>
<div class="line"> </div>
<div class="line">      xn = adj_cell.centroid;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    grad_phi_P += Af * ((xn-xf).Norm()*phi_P + (xf-xp).Norm()*phi_N)/</div>
<div class="line">                  (xn-xp).Norm();</div>
<div class="line">    ++f;</div>
<div class="line">  }<span class="comment">//for face</span></div>
<div class="line">  grad_phi_P /= cell_mapping.CellVolume();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> int64_t xmap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 0);</div>
<div class="line">  <span class="keyword">const</span> int64_t ymap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 1);</div>
<div class="line">  <span class="keyword">const</span> int64_t zmap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 2);</div>
<div class="line"> </div>
<div class="line">  grad_phi[xmap] = grad_phi_P.x;</div>
<div class="line">  grad_phi[ymap] = grad_phi_P.y;</div>
<div class="line">  grad_phi[zmap] = grad_phi_P.z;</div>
<div class="line">}<span class="comment">//for cell</span></div>
<div class="ttc" id="anamespacechi__math_html_ae9d5df571cd219e6731bcd6d74c85af4"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ae9d5df571cd219e6731bcd6d74c85af4">chi_math::Vector3</a></div><div class="ttdeci">VectorN&lt; 3 &gt; Vector3</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d77/chi__math__vector_n_x_8h_source.html#l00474">chi_math_vectorNX.h:474</a></div></div>
</div><!-- fragment --><p> As per usual we loop over the local cells. Once we have a cell reference we obtain a cell-mapping. We then immediately grab the present cell's \( \phi_P \) value by first mapping its address (reminder, the second paramater of <code>MapDOFLocal</code> is the node-number, which is zero for the Finite Volume SD), then accessing the ghosted field vector, <code>field_wg</code>.</p>
<p >We then initialize an, initially zero, three-component vector representing the gradient for cell \( P \). Next we proceed to loop over the faces of the cell where we obtain the neighboring cell's \( \phi_N \) value (provided that <code>face.has_neighbor</code>, otherwise defaulting to the boundary condition of zero) with the code </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line"><span class="keyword">const</span> int64_t nmap = sdm.MapDOFLocal(adj_cell, 0);</div>
<div class="line">phi_N = field_wg[nmap];</div>
</div><!-- fragment --><p> Notice here the use of <code>MapDOFLocal</code>. This only works because <code>field_wg</code> will have a value for the case when <code>MapDOFLocal</code> is asked to map a ghosted DOF.</p>
<p >Finally we compute the gradient from the formula </p><p class="formulaDsp">
\[ \phi_f = \frac{1}{|| \mathbf{x}_N - \mathbf{x}_P ||} \biggr( (|| \mathbf{x}_N - \mathbf{x}_f ||) \phi_P + (|| \mathbf{x}_f - \mathbf{x}_P ||) \phi_N \biggr) \]
</p>
<p> with the code </p><div class="fragment"><div class="line">grad_phi_P += Af * ((xn-xf).Norm()*phi_P + (xf-xp).Norm()*phi_N)/</div>
<div class="line">                    (xn-xp).Norm();</div>
</div><!-- fragment --><p> which is divided by the volume at the termination of the faces-loop.</p>
<p >The final step for a cell is to appropriately store this gradient, therefore we map each component of the gradient and appropriately set the <code>grad_phi</code> vector, </p><div class="fragment"><div class="line"><span class="keyword">const</span> int64_t xmap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 0);</div>
<div class="line"><span class="keyword">const</span> int64_t ymap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 1);</div>
<div class="line"><span class="keyword">const</span> int64_t zmap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 2);</div>
<div class="line"> </div>
<div class="line">grad_phi[xmap] = grad_phi_P.x;</div>
<div class="line">grad_phi[ymap] = grad_phi_P.y;</div>
<div class="line">grad_phi[zmap] = grad_phi_P.z;</div>
</div><!-- fragment --><h1><a class="anchor" id="CodeTut2Sec5"></a>
5 Visualizing the gradient</h1>
<p >Visualizing the gradient is conceptually simple. We simply create a field-function that will export all three the components of the gradient together. Then we use paraview to make arrow glyphs for visualization. </p><div class="fragment"><div class="line"><span class="comment">//============================================= Create Field Function</span></div>
<div class="line"><span class="keyword">auto</span> ff_grad = std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">  <span class="stringliteral">&quot;GradPhi&quot;</span>,</div>
<div class="line">  sdm_ptr,</div>
<div class="line">  <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da28d37be09a3d36f452147d018301ee87">chi_math::UnknownType::VECTOR_3</a>)</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line">ff_grad-&gt;UpdateFieldVector(grad_phi);</div>
<div class="line"> </div>
<div class="line">ff_grad-&gt;ExportToVTK(<span class="stringliteral">&quot;CodeTut2_FV_grad&quot;</span>);</div>
</div><!-- fragment --><p >Within paraview we can use the <code>Calculator</code> filter to construct vector quantities from the 3 components after which we can apply a <code>Glyph</code> filter to obtain a visualization as shown below</p>
<div class="image">
<img src="../../Tut2Gradient.png" alt="" width="700px"/>
</div>
<h1><a class="anchor" id="CodeTut2Sec6"></a>
The complete program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d98/chi__meshhandler_8h.html">ChiMesh/MeshHandler/chi_meshhandler.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d0/db3/chi__meshcontinuum_8h.html">ChiMesh/MeshContinuum/chi_meshcontinuum.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../de/d50/fv_8h.html">ChiMath/SpatialDiscretization/FiniteVolume/fv.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../da/d0e/petsc__utils_8h.html">ChiMath/PETScUtils/petsc_utils.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ChiPhysics/FieldFunction/fieldfunction2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d7b/vector__ghost__communicator_8h.html">ChiMath/VectorGhostCommunicator/vector_ghost_communicator.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_function" href="../../d4/d35/classchi.html#a4e6b239c3512a82a18bb114f84bf22e8">chi::Initialize</a>(argc,argv);</div>
<div class="line">  <a class="code hl_function" href="../../d4/d35/classchi.html#ad2e614f7b9733c863908ce0eeb4480f1">chi::RunBatch</a>(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Coding Tutorial 2&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Get grid</span></div>
<div class="line">  <span class="keyword">auto</span> grid_ptr = <a class="code hl_function" href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a>().<a class="code hl_function" href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">GetGrid</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; grid = *grid_ptr;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Global num cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make SDM</span></div>
<div class="line">  <span class="keyword">typedef</span> std::shared_ptr&lt;chi_math::SpatialDiscretization&gt; <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a>;</div>
<div class="line">  <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a> sdm_ptr = <a class="code hl_function" href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html#a5bbe68d748cdc52e05dfcfe37f74d622">chi_math::SpatialDiscretization_FV::New</a>(grid_ptr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; sdm = *sdm_ptr;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; OneDofPerNode = sdm.UNITARY_UNKNOWN_MANAGER;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_dofs = sdm.GetNumLocalDOFs(OneDofPerNode);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_globl_dofs = sdm.GetNumGlobalDOFs(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Num local DOFs: &quot;</span> &lt;&lt; num_local_dofs;</div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Num globl DOFs: &quot;</span> &lt;&lt; num_globl_dofs;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Initializes Mats and Vecs</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> n = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_local_dofs);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> N = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_globl_dofs);</div>
<div class="line">  Mat A;</div>
<div class="line">  Vec x,b;</div>
<div class="line"> </div>
<div class="line">  A = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a>(n,N);</div>
<div class="line">  x = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line">  b = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;int64_t&gt; nodal_nnz_in_diag;</div>
<div class="line">  std::vector&lt;int64_t&gt; nodal_nnz_off_diag;</div>
<div class="line">  sdm.BuildSparsityPattern(nodal_nnz_in_diag,nodal_nnz_off_diag,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a>(A,</div>
<div class="line">                                           nodal_nnz_in_diag,</div>
<div class="line">                                           nodal_nnz_off_diag);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Assemble the system</span></div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Assembling system: &quot;</span>;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> int64_t imap = sdm.MapDOF(cell,0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xp = cell.centroid;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> V = cell_mapping.CellVolume();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> f=0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; face : cell.faces)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> Af = face.normal * cell_mapping.FaceArea(f);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (face.has_neighbor)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line">        <span class="keyword">const</span> int64_t jnmap = sdm.MapDOF(adj_cell,0);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = adj_cell.centroid;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
<div class="line"> </div>
<div class="line">        MatSetValue(A, imap, imap ,  cf, ADD_VALUES);</div>
<div class="line">        MatSetValue(A, imap, jnmap, -cf, ADD_VALUES);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = xp + 2.0*(face.centroid - xp);</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
<div class="line"> </div>
<div class="line">        MatSetValue(A, imap, imap , cf, ADD_VALUES);</div>
<div class="line">      }</div>
<div class="line">      ++f;</div>
<div class="line">    }<span class="comment">//for face</span></div>
<div class="line"> </div>
<div class="line">    VecSetValue(b, imap, 1.0*V, ADD_VALUES);</div>
<div class="line">  }<span class="comment">//for cell i</span></div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  MatAssemblyBegin(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">  MatAssemblyEnd(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">  VecAssemblyBegin(b);</div>
<div class="line">  VecAssemblyEnd(b);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Done global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Krylov Solver</span></div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Solving: &quot;</span>;</div>
<div class="line">  <span class="keyword">auto</span> petsc_solver =</div>
<div class="line">    <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a>(</div>
<div class="line">      A,               <span class="comment">//Matrix</span></div>
<div class="line">      <span class="stringliteral">&quot;FVDiffSolver&quot;</span>,  <span class="comment">//Solver name</span></div>
<div class="line">      KSPCG,           <span class="comment">//Solver type</span></div>
<div class="line">      PCGAMG,          <span class="comment">//Preconditioner type</span></div>
<div class="line">      1.0e-6,          <span class="comment">//Relative residual tolerance</span></div>
<div class="line">      1000);            <span class="comment">//Max iterations</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Solve</span></div>
<div class="line">  KSPSolve(petsc_solver.ksp,b,x);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Done solving&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Extract PETSc vector</span></div>
<div class="line">  std::vector&lt;double&gt; field(num_local_dofs, 0.0);</div>
<div class="line">  sdm.LocalizePETScVector(x,field,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Clean up</span></div>
<div class="line">  KSPDestroy(&amp;petsc_solver.ksp);</div>
<div class="line"> </div>
<div class="line">  VecDestroy(&amp;x);</div>
<div class="line">  VecDestroy(&amp;b);</div>
<div class="line">  MatDestroy(&amp;A);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a>.<a class="code hl_function" href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">Log</a>() &lt;&lt; <span class="stringliteral">&quot;Done cleanup&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Field Function</span></div>
<div class="line">  <span class="keyword">auto</span> ff = std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;Phi&quot;</span>,</div>
<div class="line">    sdm_ptr,</div>
<div class="line">    <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a>)</div>
<div class="line">  );</div>
<div class="line"> </div>
<div class="line">  ff-&gt;UpdateFieldVector(field);</div>
<div class="line"> </div>
<div class="line">  ff-&gt;ExportToVTK(<span class="stringliteral">&quot;CodeTut2_FV&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make ghosted vectors</span></div>
<div class="line">  std::vector&lt;int64_t&gt; ghost_ids = sdm.GetGhostDOFIndices(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_class" href="../../d1/db0/classchi__math_1_1_vector_ghost_communicator.html">chi_math::VectorGhostCommunicator</a> vgc(num_local_dofs,</div>
<div class="line">                                        num_globl_dofs,</div>
<div class="line">                                        ghost_ids,</div>
<div class="line">                                        MPI_COMM_WORLD);</div>
<div class="line">  std::vector&lt;double&gt; field_wg = vgc.MakeGhostedVector(field);</div>
<div class="line"> </div>
<div class="line">  vgc.CommunicateGhostEntries(field_wg);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Setup gradient unknown structure</span></div>
<div class="line">  <a class="code hl_class" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a> grad_uk_man(</div>
<div class="line">    {<a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da28d37be09a3d36f452147d018301ee87">chi_math::UnknownType::VECTOR_3</a>)});</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_grad_dofs = sdm.GetNumLocalDOFs(grad_uk_man);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; grad_phi(num_grad_dofs, 0.0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> int64_t imap = sdm.MapDOFLocal(cell, 0);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>  phi_P = field_wg[imap];</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xp = cell.centroid;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> grad_phi_P = <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ae9d5df571cd219e6731bcd6d74c85af4">chi_mesh::Vector3</a>(0,0,0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> f=0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; face : cell.faces)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xf = face.centroid;</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>  Af = cell_mapping.FaceArea(f) * face.normal;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> phi_N = 0.0;</div>
<div class="line">      <span class="keyword">auto</span> xn = xp + 2*(xf-xp);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (face.has_neighbor)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line">        <span class="keyword">const</span> int64_t nmap = sdm.MapDOFLocal(adj_cell, 0);</div>
<div class="line">        phi_N = field_wg[nmap];</div>
<div class="line"> </div>
<div class="line">        xn = adj_cell.centroid;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      grad_phi_P += Af * ((xn-xf).Norm()*phi_P + (xf-xp).Norm()*phi_N)/</div>
<div class="line">                    (xn-xp).Norm();</div>
<div class="line">      ++f;</div>
<div class="line">    }<span class="comment">//for face</span></div>
<div class="line">    grad_phi_P /= cell_mapping.CellVolume();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> int64_t xmap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 0);</div>
<div class="line">    <span class="keyword">const</span> int64_t ymap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 1);</div>
<div class="line">    <span class="keyword">const</span> int64_t zmap = sdm.MapDOFLocal(cell, 0, grad_uk_man, 0, 2);</div>
<div class="line"> </div>
<div class="line">    grad_phi[xmap] = grad_phi_P.x;</div>
<div class="line">    grad_phi[ymap] = grad_phi_P.y;</div>
<div class="line">    grad_phi[zmap] = grad_phi_P.z;</div>
<div class="line">  }<span class="comment">//for cell</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Field Function</span></div>
<div class="line">  <span class="keyword">auto</span> ff_grad = std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;GradPhi&quot;</span>,</div>
<div class="line">    sdm_ptr,</div>
<div class="line">    <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da28d37be09a3d36f452147d018301ee87">chi_math::UnknownType::VECTOR_3</a>)</div>
<div class="line">  );</div>
<div class="line"> </div>
<div class="line">  ff_grad-&gt;UpdateFieldVector(grad_phi);</div>
<div class="line"> </div>
<div class="line">  ff_grad-&gt;ExportToVTK(<span class="stringliteral">&quot;CodeTut2_FV_grad&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="../../d4/d35/classchi.html#a88720f743f80818b08e68716233d9051">chi::Finalize</a>();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="achi__log_8h_html"><div class="ttname"><a href="../../dc/d75/chi__log_8h.html">chi_log.h</a></div></div>
<div class="ttc" id="achi__meshcontinuum_8h_html"><div class="ttname"><a href="../../d0/db3/chi__meshcontinuum_8h.html">chi_meshcontinuum.h</a></div></div>
<div class="ttc" id="achi__meshhandler_8h_html"><div class="ttname"><a href="../../df/d98/chi__meshhandler_8h.html">chi_meshhandler.h</a></div></div>
<div class="ttc" id="achi__runtime_8h_html"><div class="ttname"><a href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a></div></div>
<div class="ttc" id="achi__tech__main_8cc_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dca/chi__tech__main_8cc_source.html#l00010">chi_tech_main.cc:10</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_spatial_discretization___f_v_html_a5bbe68d748cdc52e05dfcfe37f74d622"><div class="ttname"><a href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html#a5bbe68d748cdc52e05dfcfe37f74d622">chi_math::SpatialDiscretization_FV::New</a></div><div class="ttdeci">static std::shared_ptr&lt; SpatialDiscretization_FV &gt; New(chi_mesh::MeshContinuumPtr &amp;in_grid, CoordinateSystemType in_cs_type=CoordinateSystemType::CARTESIAN)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d50/fv_8h_source.html#l00030">fv.h:30</a></div></div>
<div class="ttc" id="aclasschi__mesh_1_1_mesh_handler_html_aa87887c1a76634cb07134b5faa1e3587"><div class="ttname"><a href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">chi_mesh::MeshHandler::GetGrid</a></div><div class="ttdeci">chi_mesh::MeshContinuumPtr &amp; GetGrid() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d65/chi__meshhandler_8cc_source.html#l00012">chi_meshhandler.cc:12</a></div></div>
<div class="ttc" id="aclasschi__objects_1_1_chi_log_html_abed9782beaeca9b7e5f08c1faa8f28a1"><div class="ttname"><a href="../../d8/d42/classchi__objects_1_1_chi_log.html#abed9782beaeca9b7e5f08c1faa8f28a1">chi_objects::ChiLog::Log</a></div><div class="ttdeci">LogStream Log(LOG_LVL level=LOG_0)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d1c/chi__log_8cc_source.html#l00027">chi_log.cc:27</a></div></div>
<div class="ttc" id="aclasschi_html_a2dedda8a44a89f39b4038becaa9f304a"><div class="ttname"><a href="../../d4/d35/classchi.html#a2dedda8a44a89f39b4038becaa9f304a">chi::log</a></div><div class="ttdeci">static chi_objects::ChiLog &amp; log</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/db2/chi__runtime_8h_source.html#l00070">chi_runtime.h:70</a></div></div>
<div class="ttc" id="aclasschi_html_a4e6b239c3512a82a18bb114f84bf22e8"><div class="ttname"><a href="../../d4/d35/classchi.html#a4e6b239c3512a82a18bb114f84bf22e8">chi::Initialize</a></div><div class="ttdeci">static int Initialize(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd3/chi__runtime_8cc_source.html#l00136">chi_runtime.cc:136</a></div></div>
<div class="ttc" id="aclasschi_html_a88720f743f80818b08e68716233d9051"><div class="ttname"><a href="../../d4/d35/classchi.html#a88720f743f80818b08e68716233d9051">chi::Finalize</a></div><div class="ttdeci">static void Finalize()</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd3/chi__runtime_8cc_source.html#l00179">chi_runtime.cc:179</a></div></div>
<div class="ttc" id="aclasschi_html_ad2e614f7b9733c863908ce0eeb4480f1"><div class="ttname"><a href="../../d4/d35/classchi.html#ad2e614f7b9733c863908ce0eeb4480f1">chi::RunBatch</a></div><div class="ttdeci">static int RunBatch(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dd3/chi__runtime_8cc_source.html#l00244">chi_runtime.cc:244</a></div></div>
<div class="ttc" id="afv_8h_html"><div class="ttname"><a href="../../de/d50/fv_8h.html">fv.h</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_a1baca8287da5a48e6d56ba3da4c39bab"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a></div><div class="ttdeci">void InitMatrixSparsity(Mat &amp;A, const std::vector&lt; int64_t &gt; &amp;nodal_nnz_in_diag, const std::vector&lt; int64_t &gt; &amp;nodal_nnz_off_diag)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d70/petsc__utils__02__create_mat_8cc_source.html#l00084">petsc_utils_02_createMat.cc:84</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ab59d60d5f5daa3929e3669acdcce1b39"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a></div><div class="ttdeci">PETScSolverSetup CreateCommonKrylovSolverSetup(Mat ref_matrix, const std::string &amp;in_solver_name=&quot;KSPSolver&quot;, const std::string &amp;in_solver_type=KSPGMRES, const std::string &amp;in_preconditioner_type=PCNONE, double in_relative_residual_tolerance=1.0e-6, int64_t in_maximum_iterations=100)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/da1/petsc__utils__03__create_k_s_p_8cc_source.html#l00035">petsc_utils_03_createKSP.cc:35</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ad3c389879eeafb68d9b7540887b883cd"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a></div><div class="ttdeci">Mat CreateSquareMatrix(int64_t local_size, int64_t global_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d70/petsc__utils__02__create_mat_8cc_source.html#l00025">petsc_utils_02_createMat.cc:25</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ae2ebedf1cd0712f3d6e0b2047c389949"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a></div><div class="ttdeci">Vec CreateVector(int64_t local_size, int64_t global_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/petsc__utils__01__create_vec_8cc_source.html#l00019">petsc_utils_01_createVec.cc:20</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ab6754b3179f7dbf965932210273fead7"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">chi_math::SDMPtr</a></div><div class="ttdeci">std::shared_ptr&lt; SpatialDiscretization &gt; SDMPtr</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/df1/cfem__diffusion__solver_8h_source.html#l00025">cfem_diffusion_solver.h:24</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a></div><div class="ttdeci">@ SCALAR</div></div>
<div class="ttc" id="anamespacechi__mesh_html_addcd6899961d4c527b02c33708a7941f"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a></div><div class="ttdeci">MeshHandler &amp; GetCurrentHandler()</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d4b/chi__mesh__meshhandler__utils_8cc_source.html#l00013">chi_mesh_meshhandler_utils.cc:13</a></div></div>
<div class="ttc" id="apetsc__utils_8h_html"><div class="ttname"><a href="../../da/d0e/petsc__utils_8h.html">petsc_utils.h</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Chi-Tech</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
