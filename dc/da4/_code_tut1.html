<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Coding Tutorial 1 - Poisson&#39;s problem with Finite Volume</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/da4/_code_tut1.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Coding Tutorial 1 - Poisson's problem with Finite Volume </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Table of contents</h2>
<ul>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec1">1 Poisson's equation</a><ul>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec1_1">1.1 Our specific problem</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec1_2">1.2 The Finite Volume spatial discretization</a></li>
</ul>
</li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec2">2 Setting up the problem</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec3">3 Getting the grid</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec4">4 Initializing the Finite Volume Spatial Discretization</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec5">5 Creating and Initializing PETSc matrices and vectors</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec6">6 Assembling the matrix and right-hand-side</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec7">7 Solving the system with a Krylov Subspace solver</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec8">8 Visualizing the solution</a></li>
<li><a class="el" href="../../dc/da4/_code_tut1.html#CodeTut1Sec9">The complete program</a></li>
</ul>
<h1><a class="anchor" id="CodeTut1Sec1"></a>
1 Poisson's equation</h1>
<p ><a href="https://en.wikipedia.org/wiki/Poisson%27s_equation">The Poisson's equation</a> states the following, for <img class="formulaInl" alt="$ \phi, q \in \mathcal{R} $" src="../../form_116.png" width="54" height="15"/>, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} -\boldsymbol{\nabla} \cdot \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr) = q(\mathbf{x}), \quad \quad \quad (\mathbf{x})\in\mathcal{D} \\ \phi(\mathbf{x}) = 0, \quad \quad \quad \mathbf{x}\in \partial \mathcal{D} \end{eqnarray*}" src="../../form_117.png" width="237" height="41"/>
</p>
<p> where <img class="formulaInl" alt="$ \boldsymbol{\nabla} \cdot \bigr( \bigr) $" src="../../form_118.png" width="30" height="20"/> denotes the divergence-operator and <img class="formulaInl" alt="$ \boldsymbol{\nabla} $" src="../../form_119.png" width="14" height="14"/> denotes the gradient-operator, i.e. <img class="formulaInl" alt="$ \boldsymbol{\nabla} \phi $" src="../../form_120.png" width="23" height="15"/> denotes the gradient of <img class="formulaInl" alt="$ \phi $" src="../../form_19.png" width="9" height="15"/>. The boundary conditions here state that <img class="formulaInl" alt="$ \phi=0 $" src="../../form_121.png" width="36" height="15"/> on the boundary.</p>
<h2><a class="anchor" id="CodeTut1Sec1_1"></a>
1.1 Our specific problem</h2>
<p >For our specific problem we will choose <img class="formulaInl" alt="$ q(\mathbf{x})=1 $" src="../../form_122.png" width="54" height="17"/> and <img class="formulaInl" alt="$ \mathcal{D} $" src="../../form_123.png" width="14" height="12"/> a cartesian domain, either 1D, 2D or 3D, with each dimension always between <img class="formulaInl" alt="$ -1,+1 $" src="../../form_124.png" width="44" height="14"/>. We can generate the mesh for this problem using an input file </p><div class="fragment"><div class="line">--############################################### Setup mesh</div>
<div class="line"><a class="code hl_function" href="../../da/d92/group___lua_mesh_handler.html#ga3be36a5ecf5469ad0980dd5aa4097a2a">chiMeshHandlerCreate</a>()</div>
<div class="line"> </div>
<div class="line">mesh={}</div>
<div class="line">N=20</div>
<div class="line">L=2</div>
<div class="line">xmin = -L/2</div>
<div class="line">dx = L/N</div>
<div class="line"><span class="keywordflow">for</span> i=1,(N+1) <span class="keywordflow">do</span></div>
<div class="line">    k=i-1</div>
<div class="line">    mesh[i] = xmin + k*dx</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">--<a class="code hl_function" href="../../d9/db8/group___lua_mesh_macros.html#ga12dcd80ee2ab6104ba6e7142d7885221">chiMeshCreateUnpartitioned3DOrthoMesh</a>(mesh,mesh,mesh)</div>
<div class="line"><a class="code hl_function" href="../../d9/db8/group___lua_mesh_macros.html#ga83d9d3e4a7ae7060391faefe17c1076a">chiMeshCreateUnpartitioned2DOrthoMesh</a>(mesh,mesh)</div>
<div class="line">--<a class="code hl_function" href="../../d9/db8/group___lua_mesh_macros.html#gabcd0e135b1081c3b9eb6661d44fb21d7">chiMeshCreateUnpartitioned1DOrthoMesh</a>(mesh)</div>
<div class="line"><a class="code hl_function" href="../../d4/d3a/group___lua_volume_mesher.html#gad031f7f22f9a1b4d7ea535f04c56ae1f">chiVolumeMesherExecute</a>();</div>
<div class="line"> </div>
<div class="line">--############################################### <a class="code hl_function" href="../../dc/d58/namespacechi__math.html#a75948cb3d263fe5216470bae075742ea">Set</a> Material IDs</div>
<div class="line"><a class="code hl_function" href="../../d4/d3a/group___lua_volume_mesher.html#ga88fb27136bed385ee1ec665d8d2e9e63">chiVolumeMesherSetMatIDToAll</a>(0)</div>
<div class="ttc" id="agroup___lua_mesh_handler_html_ga3be36a5ecf5469ad0980dd5aa4097a2a"><div class="ttname"><a href="../../da/d92/group___lua_mesh_handler.html#ga3be36a5ecf5469ad0980dd5aa4097a2a">chi_lua::chiMeshHandlerCreate</a></div><div class="ttdeci">Handle chiMeshHandlerCreate()</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d47/lua__functions_8c_source.html#l01096">lua_functions.c:1096</a></div></div>
<div class="ttc" id="agroup___lua_mesh_macros_html_ga12dcd80ee2ab6104ba6e7142d7885221"><div class="ttname"><a href="../../d9/db8/group___lua_mesh_macros.html#ga12dcd80ee2ab6104ba6e7142d7885221">chi_lua::chiMeshCreateUnpartitioned3DOrthoMesh</a></div><div class="ttdeci">Two chiMeshCreateUnpartitioned3DOrthoMesh(array_float x_nodes, array_float y_nodes, array_float z_nodes)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d47/lua__functions_8c_source.html#l02261">lua_functions.c:2261</a></div></div>
<div class="ttc" id="agroup___lua_mesh_macros_html_ga83d9d3e4a7ae7060391faefe17c1076a"><div class="ttname"><a href="../../d9/db8/group___lua_mesh_macros.html#ga83d9d3e4a7ae7060391faefe17c1076a">chi_lua::chiMeshCreateUnpartitioned2DOrthoMesh</a></div><div class="ttdeci">Two chiMeshCreateUnpartitioned2DOrthoMesh(array_float x_nodes, array_float y_nodes)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d47/lua__functions_8c_source.html#l02231">lua_functions.c:2231</a></div></div>
<div class="ttc" id="agroup___lua_mesh_macros_html_gabcd0e135b1081c3b9eb6661d44fb21d7"><div class="ttname"><a href="../../d9/db8/group___lua_mesh_macros.html#gabcd0e135b1081c3b9eb6661d44fb21d7">chi_lua::chiMeshCreateUnpartitioned1DOrthoMesh</a></div><div class="ttdeci">Two chiMeshCreateUnpartitioned1DOrthoMesh(array_float x_nodes)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d47/lua__functions_8c_source.html#l02205">lua_functions.c:2205</a></div></div>
<div class="ttc" id="agroup___lua_volume_mesher_html_ga88fb27136bed385ee1ec665d8d2e9e63"><div class="ttname"><a href="../../d4/d3a/group___lua_volume_mesher.html#ga88fb27136bed385ee1ec665d8d2e9e63">chi_lua::chiVolumeMesherSetMatIDToAll</a></div><div class="ttdeci">void chiVolumeMesherSetMatIDToAll(int material_id)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d47/lua__functions_8c_source.html#l01816">lua_functions.c:1816</a></div></div>
<div class="ttc" id="agroup___lua_volume_mesher_html_gad031f7f22f9a1b4d7ea535f04c56ae1f"><div class="ttname"><a href="../../d4/d3a/group___lua_volume_mesher.html#gad031f7f22f9a1b4d7ea535f04c56ae1f">chi_lua::chiVolumeMesherExecute</a></div><div class="ttdeci">void chiVolumeMesherExecute()</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d47/lua__functions_8c_source.html#l01822">lua_functions.c:1822</a></div></div>
<div class="ttc" id="anamespacechi__math_html_a75948cb3d263fe5216470bae075742ea"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#a75948cb3d263fe5216470bae075742ea">chi_math::Set</a></div><div class="ttdeci">void Set(VecDbl &amp;x, const double &amp;val)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d89/chi__math__03__vector__operations_8cc_source.html#l00023">chi_math_03_vector_operations.cc:23</a></div></div>
</div><!-- fragment --><p> This code can be used to generate any of the following meshes, </p><div class="image">
<img src="../../OrthoMesh_1D_2D_3D.png" alt="" width="1200px"/>
<div class="caption">
[From left to right] 1D, 2D, 3D orthogonal mesh</div></div>
<h2><a class="anchor" id="CodeTut1Sec1_2"></a>
1.2 The Finite Volume spatial discretization</h2>
<p >To apply the Finite Volume spatial discretization we integrate Poisson's equation over the volume of the cell </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} -\int_V \boldsymbol{\nabla} \cdot \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr) dV = \int_V q(\mathbf{x}) dV \end{eqnarray*}" src="../../form_125.png" width="219" height="36"/>
</p>
<p> Next we apply the approximation that both <img class="formulaInl" alt="$ \phi $" src="../../form_19.png" width="9" height="15"/> and <img class="formulaInl" alt="$ q $" src="../../form_126.png" width="8" height="11"/> are constant over a cell. Therefore, for cell <img class="formulaInl" alt="$ P $" src="../../form_127.png" width="12" height="12"/>, we have the source term </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \int_V q(\mathbf{x}) dV = q_P V_P. \end{eqnarray*}" src="../../form_128.png" width="128" height="36"/>
</p>
<p> For the left-hand side we first apply Gauss Divergence Theorem, </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \int_V \boldsymbol{\nabla} \cdot \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr) dV = \int_S \mathbf{n} \cdot \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr) dA \end{eqnarray*}" src="../../form_129.png" width="248" height="36"/>
</p>
<p> and for a discrete cell this surface integral can be discretized as the sum over all the faces </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \int_S \mathbf{n} \cdot \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr) dA = \sum_f A_f \mathbf{n}_f \cdot \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr)_f. \end{eqnarray*}" src="../../form_130.png" width="263" height="42"/>
</p>
<p> We now still have to resolve <img class="formulaInl" alt="$ \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr)_f $" src="../../form_131.png" width="63" height="23"/>. To comprehend the approximation we are about to make, consider the figure below. We observe a cell <img class="formulaInl" alt="$ P $" src="../../form_127.png" width="12" height="12"/>, the present cell, and its neighbor, cell <img class="formulaInl" alt="$ N $" src="../../form_132.png" width="14" height="12"/>, at face <img class="formulaInl" alt="$ f $" src="../../form_18.png" width="9" height="15"/>. The cell centroids are <img class="formulaInl" alt="$ \mathbf{x}_P $" src="../../form_133.png" width="20" height="11"/> and <img class="formulaInl" alt="$ \mathbf{x}_N $" src="../../form_134.png" width="21" height="11"/> respectively.</p>
<div class="image">
<img src="../../NeighborXPN.png" alt="" width="250px"/>
</div>
<p >We next form <img class="formulaInl" alt="$ \mathbf{x}_{PN} $" src="../../form_135.png" width="30" height="11"/>, as in the diagram, after which we approximate the gradient of <img class="formulaInl" alt="$ \phi $" src="../../form_19.png" width="9" height="15"/> at face <img class="formulaInl" alt="$ f $" src="../../form_18.png" width="9" height="15"/> as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \bigr(\boldsymbol{\nabla} \phi(\mathbf{x})\bigr)_f = \biggr( \frac{\phi_N - \phi_P}{||\mathbf{x}_{PN}||} \biggr) \ \frac{\mathbf{x}_{PN}}{||\mathbf{x}_{PN}||}. \end{eqnarray*}" src="../../form_136.png" width="222" height="38"/>
</p>
<p> Note that this is essentially a scalar component <img class="formulaInl" alt="$ \frac{df}{ds} = \frac{\phi_N - \phi_P}{||\mathbf{x}_{PN}||}$" src="../../form_137.png" width="80" height="23"/> after which we give it a direction by normalizing <img class="formulaInl" alt="$ \mathbf{x}_{PN} $" src="../../form_135.png" width="30" height="11"/> as <img class="formulaInl" alt="$ \frac{\mathbf{x}_{PN}}{||\mathbf{x}_{PN}||} $" src="../../form_138.png" width="41" height="20"/>.</p>
<p >Our discretized equations now become</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} \sum_f c_f \phi_P - \sum_f c_f \phi_N &amp;= q_P V_P \\ c_f &amp;= \biggr[ \mathbf{A}_f \boldsymbol{\cdot} \frac{\mathbf{x}_{PN}}{||\mathbf{x}_{PN}||^2} \biggr]_f \end{align*}" src="../../form_139.png" width="261" height="81"/>
</p>
<p> where <img class="formulaInl" alt="$ \mathbf{A}_f $" src="../../form_140.png" width="21" height="17"/> is the area-vector of the face, i.e. <img class="formulaInl" alt="$ A_f \mathbf{n}_f $" src="../../form_141.png" width="36" height="17"/> and <img class="formulaInl" alt="$ \phi_P=0 $" src="../../form_142.png" width="47" height="15"/> when face <img class="formulaInl" alt="$ f $" src="../../form_18.png" width="9" height="15"/> is on a boundary (enforcing the Dirichlet boundary condition).</p>
<h1><a class="anchor" id="CodeTut1Sec2"></a>
2 Setting up the problem</h1>
<p >In order to implement the code, we must first follow the steps in <a class="el" href="../../d8/d99/_dev_man_using_lib.html">Using Chi-Tech as a library</a>. Before proceeding, make sure you are fully acquinted with this step.</p>
<p >For this tutorial we will be deviation from the library tutorial by first changing the cmake target and project name. Therefore, we pick a project folder and create the <code>CMakeLists.txt</code> file but we change the following lines. </p><div class="fragment"><div class="line">set(TARGET code_tut1)</div>
<div class="line">project(CodeTut1 CXX)</div>
</div><!-- fragment --><p >So now the entire <code>CMakeLists.txt</code> should look like this </p><div class="fragment"><div class="line">cmake_minimum_required(VERSION 3.12)</div>
<div class="line"> </div>
<div class="line">set(TARGET code_tut1)</div>
<div class="line">project(CodeTut1 CXX)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#------------------------------------------------ DEPENDENCIES</span></div>
<div class="line"><span class="keywordflow">if</span> (NOT DEFINED CHI_TECH_DIR)</div>
<div class="line">    <span class="keywordflow">if</span> (NOT (DEFINED ENV{CHI_TECH_DIR}))</div>
<div class="line">        message(FATAL_ERROR <span class="stringliteral">&quot;***** CHI_TECH_DIR is not set *****&quot;</span>)</div>
<div class="line">    <span class="keywordflow">else</span>()</div>
<div class="line">        set(CHI_TECH_DIR <span class="stringliteral">&quot;$ENV{CHI_TECH_DIR}&quot;</span>)</div>
<div class="line">    endif()</div>
<div class="line">endif()</div>
<div class="line">message(STATUS &quot;CHI_TECH_DIR set to ${CHI_TECH_DIR}<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">include(&quot;</span>${CHI_TECH_DIR}/resources/Macros/Downstream.cmake<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY &quot;</span>${PROJECT_SOURCE_DIR}/lib<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral">set(CMAKE_LIBRARY_OUTPUT_DIRECTORY &quot;</span>${PROJECT_SOURCE_DIR}/lib<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral">set(CMAKE_RUNTIME_OUTPUT_DIRECTORY &quot;</span>${PROJECT_SOURCE_DIR}/bin<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">file (GLOB_RECURSE SOURCES &quot;</span>*.cc<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral">add_executable(${TARGET} &quot;</span>${SOURCES}<span class="stringliteral">&quot;)</span></div>
<div class="line"><span class="stringliteral">target_link_libraries(${TARGET} ${CHI_LIBS})</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">file(WRITE ${PROJECT_SOURCE_DIR}/Makefile &quot;</span>subsystem:\n<span class="stringliteral">&quot; &quot;</span>\t$(MAKE) -C chi_build \n\n<span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">        &quot;</span>clean:\n\t$(MAKE) -C chi_build clean\n<span class="stringliteral">&quot;)</span></div>
</div><!-- fragment --><p >Next we create the source file which we will call <code>code_tut1.cc</code>, and for now we will keep its contents the same as the library tutorial. Therefore <code>code_tut1.cc</code> should look like this </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">  chi::Initialize(argc,argv);</div>
<div class="line">  chi::RunBatch(argc, argv);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Hello World!&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//We will add code here</span></div>
<div class="line"> </div>
<div class="line">  chi::Finalize();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="achi__log_8h_html"><div class="ttname"><a href="../../dc/d75/chi__log_8h.html">chi_log.h</a></div></div>
<div class="ttc" id="achi__runtime_8h_html"><div class="ttname"><a href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a></div></div>
<div class="ttc" id="achi__tech__main_8cc_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dca/chi__tech__main_8cc_source.html#l00010">chi_tech_main.cc:10</a></div></div>
</div><!-- fragment --><p >To compile this program we first have to set the <code>CHI_TECH_DIR</code> environment variable. This might be different for everyone but should generally look like this </p><div class="fragment"><div class="line">export CHI_TECH_DIR=/Users/drjanisawesome/codes/ChiTech/<a class="code hl_namespace" href="../../dc/d67/namespacechi.html">chi</a>-tech/</div>
<div class="ttc" id="anamespacechi_html"><div class="ttname"><a href="../../dc/d67/namespacechi.html">chi</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d3/db2/chi__runtime_8h_source.html#l00052">chi_runtime.h:53</a></div></div>
</div><!-- fragment --><p> Note: the directory we want to specify here must contain <code>bin/</code> (in otherwords) it shouldn't be <code>bin/</code> itself).</p>
<p >Next we create a directory for running <code>cmake</code>. Inside your project folder, create a folder called <code>chi_build</code> and <code>cd</code> into it. </p><div class="fragment"><div class="line">mkdir chi_build</div>
<div class="line">cd chi_build</div>
</div><!-- fragment --><p >Then run <code>cmake</code> pointing to the folder that contains the <code>CMakeLists.txt</code> file, which in this case is the parent folder of the one we are in. </p><div class="fragment"><div class="line">cmake ../</div>
</div><!-- fragment --><p >After this you should be able to make the project. </p><div class="fragment"><div class="line">make</div>
</div><!-- fragment --><p> after which you should see the following </p><pre class="fragment">[ 50%] Building CXX object CMakeFiles/code_tut1.dir/code_tut1.cc.o
[100%] Linking CXX executable ../bin/code_tut1
[100%] Built target code_tut1
</pre><p >As a test you can try to execute the project with no arguments which should look like this </p><pre class="fragment">../bin/code_tut1
[0]  2022-11-14 13:02:43 Running ChiTech in batch-mode with 1 processes.
[0]  ChiTech version 1.0.2
[0]  ChiTech number of arguments supplied: 0
[0]
[0]  Usage: exe inputfile [options values]
[0]
[0]       -v                         Level of verbosity. Default 0. Can be either 0, 1 or 2.
[0]       a=b                        Executes argument as a lua string. i.e. x=2 or y=[["string"]]
[0]       -allow_petsc_error_handler Allow petsc error handler.
[0]
[0]
[0]
[0]  Final program time 00:00:00
[0]  2022-11-14 13:02:43 ChiTech finished execution of
[0]  Hello World!
</pre><h1><a class="anchor" id="CodeTut1Sec3"></a>
3 Getting the grid</h1>
<p >First we remove the lines </p><div class="fragment"><div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Hello World!&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">//We will add code here</span></div>
</div><!-- fragment --><p >Next we include the headers for access to the <code><a class="el" href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html">chi_mesh::MeshHandler</a></code> and the grid, aka <code><a class="el" href="../../d3/d1c/classchi__mesh_1_1_mesh_continuum.html">chi_mesh::MeshContinuum</a></code> </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d98/chi__meshhandler_8h.html">mesh/MeshHandler/chi_meshhandler.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d0/db3/chi__meshcontinuum_8h.html">mesh/MeshContinuum/chi_meshcontinuum.h</a>&quot;</span></div>
<div class="ttc" id="achi__meshcontinuum_8h_html"><div class="ttname"><a href="../../d0/db3/chi__meshcontinuum_8h.html">chi_meshcontinuum.h</a></div></div>
<div class="ttc" id="achi__meshhandler_8h_html"><div class="ttname"><a href="../../df/d98/chi__meshhandler_8h.html">chi_meshhandler.h</a></div></div>
</div><!-- fragment --><p >Next we add the following lines of code: </p><div class="fragment"><div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Coding Tutorial 1&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">//============================================= Get grid</span></div>
<div class="line"><span class="keyword">auto</span> grid_ptr = <a class="code hl_function" href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a>().<a class="code hl_function" href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">GetGrid</a>();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; grid = *grid_ptr;</div>
<div class="line"> </div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Global num cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="ttc" id="aclasschi__mesh_1_1_mesh_handler_html_aa87887c1a76634cb07134b5faa1e3587"><div class="ttname"><a href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">chi_mesh::MeshHandler::GetGrid</a></div><div class="ttdeci">chi_mesh::MeshContinuumPtr &amp; GetGrid() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d65/chi__meshhandler_8cc_source.html#l00012">chi_meshhandler.cc:12</a></div></div>
<div class="ttc" id="anamespacechi__mesh_html_addcd6899961d4c527b02c33708a7941f"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a></div><div class="ttdeci">MeshHandler &amp; GetCurrentHandler()</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d4b/chi__mesh__meshhandler__utils_8cc_source.html#l00013">chi_mesh_meshhandler_utils.cc:13</a></div></div>
</div><!-- fragment --><p> This is the default way of obtaining a grid loaded into the ChiTech state at any moment, normally via an input file.</p>
<p >When you compile and run this code it ought to fail by throwing an exception that looks like this </p><pre class="fragment">terminate called after throwing an instance of 'std::logic_error'
  what():  chi_mesh::GetCurrentHandler: No handlers on stack
Abort trap: 6
</pre><p> This means the code was not loaded with a mesh-handler and therefore no grid is defined. To fix this we first create a <code>mesh.lua</code> input file within the <code>chi_build</code> directory. </p><div class="fragment"><div class="line">&gt;mesh.lua</div>
</div><!-- fragment --><p> Use an editor to add the following lines to <code>mesh.lua</code> </p><div class="fragment"><div class="line">--############################################### Setup mesh</div>
<div class="line"><a class="code hl_function" href="../../da/d92/group___lua_mesh_handler.html#ga3be36a5ecf5469ad0980dd5aa4097a2a">chiMeshHandlerCreate</a>()</div>
<div class="line"> </div>
<div class="line">mesh={}</div>
<div class="line">N=20</div>
<div class="line">L=2</div>
<div class="line">xmin = -L/2</div>
<div class="line">dx = L/N</div>
<div class="line"><span class="keywordflow">for</span> i=1,(N+1) <span class="keywordflow">do</span></div>
<div class="line">    k=i-1</div>
<div class="line">    mesh[i] = xmin + k*dx</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">--<a class="code hl_function" href="../../d9/db8/group___lua_mesh_macros.html#ga12dcd80ee2ab6104ba6e7142d7885221">chiMeshCreateUnpartitioned3DOrthoMesh</a>(mesh,mesh,mesh)</div>
<div class="line"><a class="code hl_function" href="../../d9/db8/group___lua_mesh_macros.html#ga83d9d3e4a7ae7060391faefe17c1076a">chiMeshCreateUnpartitioned2DOrthoMesh</a>(mesh,mesh)</div>
<div class="line">--<a class="code hl_function" href="../../d9/db8/group___lua_mesh_macros.html#gabcd0e135b1081c3b9eb6661d44fb21d7">chiMeshCreateUnpartitioned1DOrthoMesh</a>(mesh)</div>
<div class="line"><a class="code hl_function" href="../../d4/d3a/group___lua_volume_mesher.html#gad031f7f22f9a1b4d7ea535f04c56ae1f">chiVolumeMesherExecute</a>();</div>
<div class="line"> </div>
<div class="line">--############################################### <a class="code hl_function" href="../../dc/d58/namespacechi__math.html#a75948cb3d263fe5216470bae075742ea">Set</a> Material IDs</div>
<div class="line"><a class="code hl_function" href="../../d4/d3a/group___lua_volume_mesher.html#ga88fb27136bed385ee1ec665d8d2e9e63">chiVolumeMesherSetMatIDToAll</a>(0)</div>
</div><!-- fragment --><p> This is known as ChiTech lua-console input file. It contains lua code.</p>
<p >To run the program with this input file we simply add it to the command line </p><div class="fragment"><div class="line">../bin/code_tut1 mesh.lua</div>
</div><!-- fragment --><p >If everything went well then you should see the following </p><pre class="fragment">[0]  Parsing argument 1 mesh.lua
[0]  2022-11-14 13:14:52 Running ChiTech in batch-mode with 1 processes.
[0]  ChiTech version 1.0.2
[0]  ChiTech number of arguments supplied: 1
[0]  Computing cell-centroids.
[0]  Done computing cell-centroids.
[0]  Checking cell-center-to-face orientations
[0]  Done checking cell-center-to-face orientations
[0]  00:00:00 Establishing cell connectivity.
[0]  00:00:00 Vertex cell subscriptions complete.
[0]  00:00:00 Surpassing cell 40 of 400 (10%)
[0]  00:00:00 Surpassing cell 80 of 400 (20%)
\\ STUFF
\\ STUFF
\\ STUFF
[0]
[0]  Final program time 00:00:00
[0]  2022-11-14 13:14:52 ChiTech finished execution of mesh.lua
[0]  Coding Tutorial 1
[0]  Global num cells: 400
</pre><h1><a class="anchor" id="CodeTut1Sec4"></a>
4 Initializing the Finite Volume Spatial Discretization</h1>
<p >All spatial discretizations in ChiTech are based on a grid. Right now we want <code><a class="el" href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html">chi_math::SpatialDiscretization_FV</a></code> which is the Finite Volume Spatial discretization. It will place only a single node at the centroid of each cell.</p>
<p >To access this discretization we must first include the header for <code><a class="el" href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html">chi_math::SpatialDiscretization_FV</a></code>, </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../de/d50/fv_8h.html">math/SpatialDiscretization/FiniteVolume/fv.h</a>&quot;</span></div>
<div class="ttc" id="afv_8h_html"><div class="ttname"><a href="../../de/d50/fv_8h.html">fv.h</a></div></div>
</div><!-- fragment --><p >Next we add the following lines of code </p><div class="fragment"><div class="line"><span class="comment">//============================================= Make SDM</span></div>
<div class="line"><span class="keyword">typedef</span> std::shared_ptr&lt;chi_math::SpatialDiscretization&gt; <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a>;</div>
<div class="line"><a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a> sdm_ptr = <a class="code hl_function" href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html#aef2abe8e2064b84e29d87a2b2b2f984d">chi_math::SpatialDiscretization_FV::New</a>(grid_ptr);</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; sdm = *sdm_ptr;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; OneDofPerNode = sdm.UNITARY_UNKNOWN_MANAGER;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_dofs = sdm.GetNumLocalDOFs(OneDofPerNode);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> num_globl_dofs = sdm.GetNumGlobalDOFs(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num local DOFs: &quot;</span> &lt;&lt; num_local_dofs;</div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num globl DOFs: &quot;</span> &lt;&lt; num_globl_dofs;</div>
<div class="ttc" id="aclasschi__math_1_1_spatial_discretization___f_v_html_aef2abe8e2064b84e29d87a2b2b2f984d"><div class="ttname"><a href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html#aef2abe8e2064b84e29d87a2b2b2f984d">chi_math::SpatialDiscretization_FV::New</a></div><div class="ttdeci">static std::shared_ptr&lt; SpatialDiscretization_FV &gt; New(const chi_mesh::MeshContinuum &amp;in_grid, CoordinateSystemType in_cs_type=CoordinateSystemType::CARTESIAN)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/fv__00__constrdestr_8cc_source.html#l00021">fv_00_constrdestr.cc:21</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ab6754b3179f7dbf965932210273fead7"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">chi_math::SDMPtr</a></div><div class="ttdeci">std::shared_ptr&lt; SpatialDiscretization &gt; SDMPtr</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/df1/cfem__diffusion__solver_8h_source.html#l00025">cfem_diffusion_solver.h:24</a></div></div>
</div><!-- fragment --><p >What we did here is to first define the shared-pointer of type <code><a class="el" href="../../dd/d1d/classchi__math_1_1_spatial_discretization.html">chi_math::SpatialDiscretization</a></code> to be just <code>SMDPtr</code> which greatly reduced the effort on the next line, where we actually instantiate the spatial discretization. Notice the use of <code><a class="el" href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html#aef2abe8e2064b84e29d87a2b2b2f984d">chi_math::SpatialDiscretization_FV::New</a></code>. All of the ChiTech spatial discretizations can only be created as shared pointers, the need for this will only become obvious when you write your own solvers.</p>
<p >The creation of a spatial discretization involves a lot of steps. The first thing the spatial discretization (SD) will do is to create cell-mappings. These contain all the necessary information for each cell to help build codes, e.g., the number of nodes on a cell, its volume, face areas, etc. The second thing the SD does is to order the nodes in parallel in such a way that we can easily map the nodes either globally or locally.</p>
<p >The basic SD operates on the notion of <code>nodes</code>. A node is a place where a specific component of an <code>unknown</code> is located. Since it knows the underlying node structure it can provide index mappings for different unknown-structures. For example, if we stack velocity-x, velocity-y and velocity-z onto a node the SD only needs to know the structure of the unknowns, traditionally called Degrees-of-Freedom or DOFs, in order to provide index-mapping. To keep things simple, all SDs have a unitary <code><a class="el" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a></code> as a member called <code>UNITARY_UNKNOWN_MANAGER</code>. This unknown manager allows us to map indices assuming only one DOF per node. We obtained a reference to this <code><a class="el" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a></code> object with the line </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; OneDofPerNode = sdm.UNITARY_UNKNOWN_MANAGER;</div>
</div><!-- fragment --><p >With this in-hand we can now query the SD to provide us the number of local- and global DOFs. The local DOFs are those that are stored on the local processor whereas the global DOFs encompass all the DOFs across all processors. The way we ran the code above is only in serial. Therefore when we do this again, with this new code added, we will see the following new output: </p><pre class="fragment">[0]  Num local DOFs: 400
[0]  Num globl DOFs: 400
</pre><p> Since the code runs in serial mode the number of local- and global DOFS are reported to be the same.</p>
<p >To run this code in parallel we change our input, for execution with 3 processors, as </p><div class="fragment"><div class="line">mpiexec -np 3 ../bin/code_tut1 mesh.lua</div>
</div><!-- fragment --><p> which now produces a different output: </p><pre class="fragment">[0]  Num local DOFs: 131
[0]  Num globl DOFs: 400
</pre><p> Notice the global number of DOFs remains the same. Only the number of local nodes has changed.</p>
<h1><a class="anchor" id="CodeTut1Sec5"></a>
5 Creating and Initializing PETSc matrices and vectors</h1>
<p >ChiTech has several <code>macro</code>-type functions for handling PETSc objects. All of these are accessed via the <code><a class="el" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html">chi_math::PETScUtils</a></code> namespace for which we need to include the header </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../da/d0e/petsc__utils_8h.html">math/PETScUtils/petsc_utils.h</a>&quot;</span></div>
<div class="ttc" id="apetsc__utils_8h_html"><div class="ttname"><a href="../../da/d0e/petsc__utils_8h.html">petsc_utils.h</a></div></div>
</div><!-- fragment --><p >Next we add the following code: </p><div class="fragment"><div class="line"><span class="comment">//============================================= Initializes Mats and Vecs</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> n = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_local_dofs);</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> N = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_globl_dofs);</div>
<div class="line">Mat A;</div>
<div class="line">Vec x,b;</div>
<div class="line"> </div>
<div class="line">A = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a>(n,N);</div>
<div class="line">x = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line">b = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;int64_t&gt; nodal_nnz_in_diag;</div>
<div class="line">std::vector&lt;int64_t&gt; nodal_nnz_off_diag;</div>
<div class="line">sdm.BuildSparsityPattern(nodal_nnz_in_diag,nodal_nnz_off_diag,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a>(A,</div>
<div class="line">                                         nodal_nnz_in_diag,</div>
<div class="line">                                         nodal_nnz_off_diag);</div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_a1baca8287da5a48e6d56ba3da4c39bab"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a></div><div class="ttdeci">void InitMatrixSparsity(Mat &amp;A, const std::vector&lt; int64_t &gt; &amp;nodal_nnz_in_diag, const std::vector&lt; int64_t &gt; &amp;nodal_nnz_off_diag)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d70/petsc__utils__02__create_mat_8cc_source.html#l00084">petsc_utils_02_createMat.cc:84</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ad3c389879eeafb68d9b7540887b883cd"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a></div><div class="ttdeci">Mat CreateSquareMatrix(int64_t local_size, int64_t global_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d70/petsc__utils__02__create_mat_8cc_source.html#l00025">petsc_utils_02_createMat.cc:25</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ae2ebedf1cd0712f3d6e0b2047c389949"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a></div><div class="ttdeci">Vec CreateVector(int64_t local_size, int64_t global_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d4d/petsc__utils__01__create_vec_8cc_source.html#l00018">petsc_utils_01_createVec.cc:19</a></div></div>
</div><!-- fragment --><p> Notice that we made <code>int64_t</code> equivalents of <code>num_local_dofs</code> and its global counterpart. This is because PETSc operates on <code>int64_t</code>. The actual creation of <code>A</code>, <code>x</code>, and <code>b</code> is self explanatory noting that each needs a local-size as well as a global size.</p>
<p >The next two pieces of code after the creation of the PETSc entities allow us to accurately and efficiently set the matrix sparsity pattern, in-turn allowing PETSc to assemble the sparse-matrix efficiently. The sparsity pattern is defined per row and is split into entries locally stored ("in" the diagonal block) and entries stored elsewhere ("off" the diagonal block). We can get this information from our ChiTech SDs by using the <code>BuildSparsityPattern</code> routine. This routine populates <code>nodal_nnz_in_diag</code> and <code>nodal_nnz_off_diag</code>, according to an unknown-structure (which in our case is <code>OneDofPerNode</code>).</p>
<p >Finally we use our sparsity information to set the PETSc matrix's sparsity pattern using <code><a class="el" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a></code>.</p>
<h1><a class="anchor" id="CodeTut1Sec6"></a>
6 Assembling the matrix and right-hand-side</h1>
<p >The code to assemble the matrix is as follows. </p><div class="fragment"><div class="line"><span class="comment">//============================================= Assemble the system</span></div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Assembling system: &quot;</span>;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">  <span class="keyword">const</span> int64_t imap = sdm.MapDOF(cell,0);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xp = cell.centroid;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> V = cell_mapping.CellVolume();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">size_t</span> f=0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; face : cell.faces)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> Af = face.normal * cell_mapping.FaceArea(f);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (face.has_neighbor)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line">      <span class="keyword">const</span> int64_t jnmap = sdm.MapDOF(adj_cell,0);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = adj_cell.centroid;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
<div class="line"> </div>
<div class="line">      MatSetValue(A, imap, imap ,  cf, ADD_VALUES);</div>
<div class="line">      MatSetValue(A, imap, jnmap, -cf, ADD_VALUES);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = xp + 2.0*(face.centroid - xp);</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
<div class="line"> </div>
<div class="line">      MatSetValue(A, imap, imap , cf, ADD_VALUES);</div>
<div class="line">    }</div>
<div class="line">    ++f;</div>
<div class="line">  }<span class="comment">//for face</span></div>
<div class="line"> </div>
<div class="line">  VecSetValue(b, imap, 1.0*V, ADD_VALUES);</div>
<div class="line">}<span class="comment">//for cell i</span></div>
<div class="line"> </div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">MatAssemblyBegin(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">MatAssemblyEnd(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">VecAssemblyBegin(b);</div>
<div class="line">VecAssemblyEnd(b);</div>
<div class="line"> </div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Done global assembly&quot;</span>;</div>
</div><!-- fragment --><p> The first item to note is the loop over local cells. ChiTech can only loop over local cells, for more information on this see <a class="el" href="../../dd/d1a/_dev_man_meshes.html#devman_meshes_sec_1">More detail on Mesh data structures</a>.</p>
<p >Once we have a reference to a local-cell we can now obtain the SD's mapping of that cell using </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
</div><!-- fragment --><p> We can also immediately map the cell's <img class="formulaInl" alt="$ \phi_P $" src="../../form_143.png" width="18" height="15"/> global location in the parallel matrix/vector by making a call to <code><a class="el" href="../../dd/d1d/classchi__math_1_1_spatial_discretization.html#a6b8904300ab5bb7624c0521b11828272">chi_math::SpatialDiscretization::MapDOF</a></code>. </p><div class="fragment"><div class="line"><span class="keyword">const</span> int64_t imap = sdm.MapDOF(cell,0);</div>
</div><!-- fragment --><p> The syntax of this function is #1 A cell reference, and #2 the node number which, for Finite Volume, will always be zero.</p>
<p >Finally, before looping over the faces, we grab the cell centroid and volume.</p>
<p >The loop over faces is split into two cases, one for internal faces and one for boundary faces. Both cases need the face area-vector there we construct that first </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; face : cell.faces)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Af = face.normal * cell_mapping.FaceArea(f);</div>
<div class="line">  <span class="comment">//etc.</span></div>
</div><!-- fragment --><p >For internal faces, whether that face is internal, i.e., has a neighboring cell, is indicated by the member <code>has_neighbor</code>. Additionally the neighbor's global-id will be stored in the member <code>neighbor_id</code>. If the face does not have a neighbor then <code>neighbor_id</code> doubles as the boundary-id if boundary-ids are used. All cells that at minimum share a vertex with local cells are classified as <code>Ghost</code>-cells in ChiTech. And since a neighbor can be either a local- or ghost-cell we opt here to get a reference to the neighbor cell using its global-id for which we use <code>grid.cells</code>, instead of <code>grid.local_cells</code> which only uses local-ids. </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
</div><!-- fragment --><p> Once we have a reference to the adjacent cell we can now map the address of its unknown <img class="formulaInl" alt="$ \phi_N $" src="../../form_144.png" width="20" height="15"/> as </p><div class="fragment"><div class="line"><span class="keyword">const</span> int64_t jnmap = sdm.MapDOF(adj_cell,0);</div>
</div><!-- fragment --><p> We then compute </p><p class="formulaDsp">
<img class="formulaDsp" alt="\begin{align*} c_f = \biggr[ \mathbf{A}_f \boldsymbol{\cdot} \frac{\mathbf{x}_{PN}}{||\mathbf{x}_{PN}||^2} \biggr]_f \end{align*}" src="../../form_145.png" width="143" height="41"/>
</p>
<p> with the code </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = adj_cell.centroid;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
</div><!-- fragment --><p> after that we set the matrix entries associated with <img class="formulaInl" alt="$ \phi_P $" src="../../form_143.png" width="18" height="15"/> and <img class="formulaInl" alt="$ \phi_N $" src="../../form_144.png" width="20" height="15"/> using the PETSc commands </p><div class="fragment"><div class="line">MatSetValue(A, imap, imap ,  cf, ADD_VALUES);</div>
<div class="line">MatSetValue(A, imap, jnmap, -cf, ADD_VALUES);</div>
</div><!-- fragment --><p >For boundary faces, we essentially do the same, however, we do not have an adjacent cell or <img class="formulaInl" alt="$ \mathbf{x}_N $" src="../../form_134.png" width="21" height="11"/>. Therefore we extrapolate a virtual boundary cell-centroid using the face-centroid, <img class="formulaInl" alt="$ \mathbf{x}_f $" src="../../form_146.png" width="17" height="12"/>, as </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathbf{x}_N = \mathbf{x}_P + 2 ( \mathbf{x}_f - \mathbf{x}_P ) \]" src="../../form_147.png" width="150" height="17"/>
</p>
<p> and then </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = xp + 2.0*(face.centroid - xp);</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
</div><!-- fragment --><p >Finally, since there is no neighbor cell entry, we only have a diagonal entry </p><div class="fragment"><div class="line">MatSetValue(A, imap, imap , cf, ADD_VALUES);</div>
</div><!-- fragment --><p >After the face loops we then set the right-hand side using </p><div class="fragment"><div class="line">VecSetValue(b, imap, 1.0*V, ADD_VALUES);</div>
</div><!-- fragment --><p> where the <code>1.0</code> represents <img class="formulaInl" alt="$ q(\mathbf{x})=1 $" src="../../form_122.png" width="54" height="17"/>.</p>
<p >We finish parallel assembly with the following calls </p><div class="fragment"><div class="line">MatAssemblyBegin(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">MatAssemblyEnd(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">VecAssemblyBegin(b);</div>
<div class="line">VecAssemblyEnd(b);</div>
</div><!-- fragment --><h1><a class="anchor" id="CodeTut1Sec7"></a>
7 Solving the system with a Krylov Subspace solver</h1>
<p >Most of the following code is self explanatory. </p><div class="fragment"><div class="line"><span class="comment">//============================================= Create Krylov Solver</span></div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Solving: &quot;</span>;</div>
<div class="line"><span class="keyword">auto</span> petsc_solver =</div>
<div class="line">  <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a>(</div>
<div class="line">    A,               <span class="comment">//Matrix</span></div>
<div class="line">    <span class="stringliteral">&quot;FVDiffSolver&quot;</span>,  <span class="comment">//Solver name</span></div>
<div class="line">    KSPCG,           <span class="comment">//Solver type</span></div>
<div class="line">    PCGAMG,          <span class="comment">//Preconditioner type</span></div>
<div class="line">    1.0e-6,          <span class="comment">//Relative residual tolerance</span></div>
<div class="line">    1000);            <span class="comment">//Max iterations</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//============================================= Solve</span></div>
<div class="line">KSPSolve(petsc_solver.ksp,b,x);</div>
<div class="line"> </div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Done solving&quot;</span>;</div>
<div class="ttc" id="anamespacechi__math_1_1_p_e_t_sc_utils_html_ab59d60d5f5daa3929e3669acdcce1b39"><div class="ttname"><a href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a></div><div class="ttdeci">PETScSolverSetup CreateCommonKrylovSolverSetup(Mat ref_matrix, const std::string &amp;in_solver_name=&quot;KSPSolver&quot;, const std::string &amp;in_solver_type=KSPGMRES, const std::string &amp;in_preconditioner_type=PCNONE, double in_relative_residual_tolerance=1.0e-6, int64_t in_maximum_iterations=100)</div><div class="ttdef"><b>Definition:</b> <a href="../../de/da1/petsc__utils__03__create_k_s_p_8cc_source.html#l00035">petsc_utils_03_createKSP.cc:35</a></div></div>
</div><!-- fragment --><p> The solver type here was specified as <code>KSPCG</code> which represents the conjugate-gradient method. The preconditioner <code>PCGAMG</code> represents Geometric and/or Algebraic MultiGrid. The combination of this solver and preconditioner is known to be thee most efficient ways to solve these type of systems.</p>
<p >After this solve-step we want to get an STL representation of the PETSc vector so that we can think about visualizing the solution. We can get a local copy of the PETSc vector using the code </p><div class="fragment"><div class="line"><span class="comment">//============================================= Extract PETSc vector</span></div>
<div class="line">std::vector&lt;double&gt; field(num_local_dofs, 0.0);</div>
<div class="line">sdm.LocalizePETScVector(x,field,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line"><span class="comment">//============================================= Clean up</span></div>
<div class="line">KSPDestroy(&amp;petsc_solver.ksp);</div>
<div class="line"> </div>
<div class="line">VecDestroy(&amp;x);</div>
<div class="line">VecDestroy(&amp;b);</div>
<div class="line">MatDestroy(&amp;A);</div>
<div class="line"> </div>
<div class="line">chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Done cleanup&quot;</span>;</div>
</div><!-- fragment --><p> Here the SD took care of appropriately copying from the PETSc vector.</p>
<p >After this is completed we have no need for any of the PETSc entities and therefore we destroy them.</p>
<h1><a class="anchor" id="CodeTut1Sec8"></a>
8 Visualizing the solution</h1>
<p >ChiTech uses the notion of <code>FieldFunctions</code> and the visualization toolkit, <code>VTK</code>, to visual solutions. In order to gain access to <code><a class="el" href="../../df/de9/classchi__physics_1_1_field_function.html">chi_physics::FieldFunction</a></code> we need to include the header </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;physics/FieldFunction/fieldfunction2.h&quot;</span></div>
</div><!-- fragment --><p >Next we create the field function using the code </p><div class="fragment"><div class="line"><span class="comment">//============================================= Create Field Function</span></div>
<div class="line"><span class="keyword">auto</span> ff = std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">  <span class="stringliteral">&quot;Phi&quot;</span>,</div>
<div class="line">  sdm_ptr,</div>
<div class="line">  <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a>)</div>
<div class="line">);</div>
<div class="ttc" id="aclasschi__math_1_1_unknown_html"><div class="ttname"><a href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3b/unknown__manager_8h_source.html#l00031">unknown_manager.h:32</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a></div><div class="ttdeci">@ SCALAR</div></div>
</div><!-- fragment --><p> Note here that a field function simply needs a name, a SD, and an unknown structure.</p>
<p >After this is created we can update the field function with a field vector </p><div class="fragment"><div class="line">ff-&gt;UpdateFieldVector(field);</div>
</div><!-- fragment --><p >And finally we can export the solution to VTK with </p><div class="fragment"><div class="line">ff-&gt;ExportToVTK(<span class="stringliteral">&quot;CodeTut1_FV&quot;</span>);</div>
</div><!-- fragment --><p> which takes, as an argument, the base-name of the VTK output files. VTK will utilize the parallel nature of the simulation to generate a set of files </p><pre class="fragment">CodeTut1_FV.pvtu
CodeTut1_FV_0.vtu
CodeTut1_FV_1.vtu
CodeTut1_FV_2.vtu
</pre><p> The structure here is that each processor writes a <code>.vtu</code> file. The processor-id is appended to the basename before the <code>.vtu</code> extension is added. These files contain the actual data. An additional proxy-file, used to link all the data together, is written as the base-name with <code>.pvtu</code> appended to it. This <code>.pvtu</code> file can be opened in popular visualization tools such as <code>Visit</code> and <code>Paraview</code> to visualize the solution.</p>
<p >For this tutorial we used Paraview.</p>
<div class="image">
<img src="../../Solution_1D_2D_3D.png" alt="" width="1200px"/>
<div class="caption">
[From left to right] 1D, 2D, 3D solutions with a coarse mesh</div></div>
<p >And on a finer mesh, with the 3D case being 1 million cells: </p><div class="image">
<img src="../../Solution_1D_2D_3D_fine.png" alt="" width="1200px"/>
<div class="caption">
[From left to right] 1D, 2D, 3D solutions with a fine mesh</div></div>
<h1><a class="anchor" id="CodeTut1Sec9"></a>
The complete program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d98/chi__meshhandler_8h.html">mesh/MeshHandler/chi_meshhandler.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d0/db3/chi__meshcontinuum_8h.html">mesh/MeshContinuum/chi_meshcontinuum.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../de/d50/fv_8h.html">math/SpatialDiscretization/FiniteVolume/fv.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../da/d0e/petsc__utils_8h.html">math/PETScUtils/petsc_utils.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;physics/FieldFunction/fieldfunction2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">  chi::Initialize(argc,argv);</div>
<div class="line">  chi::RunBatch(argc, argv);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Coding Tutorial 1&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Get grid</span></div>
<div class="line">  <span class="keyword">auto</span> grid_ptr = <a class="code hl_function" href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a>().<a class="code hl_function" href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">GetGrid</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; grid = *grid_ptr;</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Global num cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make SDM</span></div>
<div class="line">  <span class="keyword">typedef</span> std::shared_ptr&lt;chi_math::SpatialDiscretization&gt; <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a>;</div>
<div class="line">  <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a> sdm_ptr = <a class="code hl_function" href="../../d0/d9a/classchi__math_1_1_spatial_discretization___f_v.html#aef2abe8e2064b84e29d87a2b2b2f984d">chi_math::SpatialDiscretization_FV::New</a>(grid_ptr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; sdm = *sdm_ptr;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; OneDofPerNode = sdm.UNITARY_UNKNOWN_MANAGER;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_dofs = sdm.GetNumLocalDOFs(OneDofPerNode);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_globl_dofs = sdm.GetNumGlobalDOFs(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num local DOFs: &quot;</span> &lt;&lt; num_local_dofs;</div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num globl DOFs: &quot;</span> &lt;&lt; num_globl_dofs;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Initializes Mats and Vecs</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> n = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_local_dofs);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> N = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(num_globl_dofs);</div>
<div class="line">  Mat A;</div>
<div class="line">  Vec x,b;</div>
<div class="line"> </div>
<div class="line">  A = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ad3c389879eeafb68d9b7540887b883cd">chi_math::PETScUtils::CreateSquareMatrix</a>(n,N);</div>
<div class="line">  x = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line">  b = <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ae2ebedf1cd0712f3d6e0b2047c389949">chi_math::PETScUtils::CreateVector</a>(n,N);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;int64_t&gt; nodal_nnz_in_diag;</div>
<div class="line">  std::vector&lt;int64_t&gt; nodal_nnz_off_diag;</div>
<div class="line">  sdm.BuildSparsityPattern(nodal_nnz_in_diag,nodal_nnz_off_diag,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#a1baca8287da5a48e6d56ba3da4c39bab">chi_math::PETScUtils::InitMatrixSparsity</a>(A,</div>
<div class="line">                                           nodal_nnz_in_diag,</div>
<div class="line">                                           nodal_nnz_off_diag);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Assemble the system</span></div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Assembling system: &quot;</span>;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> int64_t imap = sdm.MapDOF(cell,0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xp = cell.centroid;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> V = cell_mapping.CellVolume();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> f=0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; face : cell.faces)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> Af = face.normal * cell_mapping.FaceArea(f);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (face.has_neighbor)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line">        <span class="keyword">const</span> int64_t jnmap = sdm.MapDOF(adj_cell,0);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = adj_cell.centroid;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
<div class="line"> </div>
<div class="line">        MatSetValue(A, imap, imap ,  cf, ADD_VALUES);</div>
<div class="line">        MatSetValue(A, imap, jnmap, -cf, ADD_VALUES);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; xn = xp + 2.0*(face.centroid - xp);</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> xpn = xn - xp;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span> cf = Af.Dot(xpn) / xpn.NormSquare();</div>
<div class="line"> </div>
<div class="line">        MatSetValue(A, imap, imap , cf, ADD_VALUES);</div>
<div class="line">      }</div>
<div class="line">      ++f;</div>
<div class="line">    }<span class="comment">//for face</span></div>
<div class="line"> </div>
<div class="line">    VecSetValue(b, imap, 1.0*V, ADD_VALUES);</div>
<div class="line">  }<span class="comment">//for cell i</span></div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  MatAssemblyBegin(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">  MatAssemblyEnd(A, MAT_FINAL_ASSEMBLY);</div>
<div class="line">  VecAssemblyBegin(b);</div>
<div class="line">  VecAssemblyEnd(b);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Done global assembly&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Krylov Solver</span></div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Solving: &quot;</span>;</div>
<div class="line">  <span class="keyword">auto</span> petsc_solver =</div>
<div class="line">    <a class="code hl_function" href="../../dc/d29/namespacechi__math_1_1_p_e_t_sc_utils.html#ab59d60d5f5daa3929e3669acdcce1b39">chi_math::PETScUtils::CreateCommonKrylovSolverSetup</a>(</div>
<div class="line">      A,               <span class="comment">//Matrix</span></div>
<div class="line">      <span class="stringliteral">&quot;FVDiffSolver&quot;</span>,  <span class="comment">//Solver name</span></div>
<div class="line">      KSPCG,           <span class="comment">//Solver type</span></div>
<div class="line">      PCGAMG,          <span class="comment">//Preconditioner type</span></div>
<div class="line">      1.0e-6,          <span class="comment">//Relative residual tolerance</span></div>
<div class="line">      1000);            <span class="comment">//Max iterations</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Solve</span></div>
<div class="line">  KSPSolve(petsc_solver.ksp,b,x);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Done solving&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Extract PETSc vector</span></div>
<div class="line">  std::vector&lt;double&gt; field(num_local_dofs, 0.0);</div>
<div class="line">  sdm.LocalizePETScVector(x,field,OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Clean up</span></div>
<div class="line">  KSPDestroy(&amp;petsc_solver.ksp);</div>
<div class="line"> </div>
<div class="line">  VecDestroy(&amp;x);</div>
<div class="line">  VecDestroy(&amp;b);</div>
<div class="line">  MatDestroy(&amp;A);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Done cleanup&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Field Function</span></div>
<div class="line">  <span class="keyword">auto</span> ff = std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;Phi&quot;</span>,</div>
<div class="line">    sdm_ptr,</div>
<div class="line">    <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1da8f3d9a4b6a7b7f2c7afa61ca113d0db9">chi_math::UnknownType::SCALAR</a>)</div>
<div class="line">  );</div>
<div class="line"> </div>
<div class="line">  ff-&gt;UpdateFieldVector(field);</div>
<div class="line"> </div>
<div class="line">  ff-&gt;ExportToVTK(<span class="stringliteral">&quot;CodeTut1_FV&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  chi::Finalize();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Chi-Tech</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
