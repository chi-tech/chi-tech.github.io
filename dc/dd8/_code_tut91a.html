<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chi-Tech: Coding Tutorial 91a - Discrete Ordinates with PWLD</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../Logo2_Small.bmp"/></td>
  <td id="projectalign">
   <div id="projectname">Chi-Tech
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/dd8/_code_tut91a.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Coding Tutorial 91a - Discrete Ordinates with PWLD </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Table of contents</h2>
<ul>
<li><a class="el" href="../../dc/dd8/_code_tut91a.html#CodeTut91aSecX">The complete program</a></li>
</ul>
<h1><a class="anchor" id="CodeTut91aSecX"></a>
The complete program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d75/chi__log_8h.html">chi_log.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../df/d98/chi__meshhandler_8h.html">mesh/MeshHandler/chi_meshhandler.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d3/dfa/pwlc_8h.html">math/SpatialDiscretization/FiniteElement/PiecewiseLinear/pwlc.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../da/d0e/petsc__utils_8h.html">math/PETScUtils/petsc_utils.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;physics/FieldFunction/fieldfunction2.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d6d/chi__console_8h.html">console/chi_console.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;chi_lua.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">  chi::Initialize(argc,argv);</div>
<div class="line">  chi::RunBatch(argc, argv);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::string fname = <span class="stringliteral">&quot;Tutorial_07&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (chi::mpi.process_count != 1)</div>
<div class="line">    <span class="keywordflow">throw</span> std::logic_error(fname + <span class="stringliteral">&quot;: Is serial only.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Get grid</span></div>
<div class="line">  <span class="keyword">auto</span> grid_ptr = <a class="code hl_function" href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a>().<a class="code hl_function" href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">GetGrid</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; grid = *grid_ptr;</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Global num cells: &quot;</span> &lt;&lt; grid.GetGlobalNumberOfCells();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make Orthogonal mapping</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> ijk_info = grid.GetIJKInfo();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; ijk_mapping = grid.MakeIJKToGlobalIDMapping();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Nx = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(ijk_info[0]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Ny = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(ijk_info[1]);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Nz = <span class="keyword">static_cast&lt;</span>int64_t<span class="keyword">&gt;</span>(ijk_info[2]);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Dim1 = <a class="code hl_enumvalue" href="../../d0/d81/namespacechi__mesh.html#ad98d4e91589e7fa4e04bd70274068362a73bd95bf58ed2c1cd1ef2f4257fc3975">chi_mesh::DIMENSION_1</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Dim2 = <a class="code hl_enumvalue" href="../../d0/d81/namespacechi__mesh.html#ad98d4e91589e7fa4e04bd70274068362ac5d5534358879a033391a7c43407a246">chi_mesh::DIMENSION_2</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> Dim3 = <a class="code hl_enumvalue" href="../../d0/d81/namespacechi__mesh.html#ad98d4e91589e7fa4e04bd70274068362af15b5a9461f9a446c9117b100d8e11f2">chi_mesh::DIMENSION_3</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span>    dimension = 0;</div>
<div class="line">  <span class="keywordflow">if</span> (grid.Attributes() &amp; Dim1) dimension = 1;</div>
<div class="line">  <span class="keywordflow">if</span> (grid.Attributes() &amp; Dim2) dimension = 2;</div>
<div class="line">  <span class="keywordflow">if</span> (grid.Attributes() &amp; Dim3) dimension = 3;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make SDM</span></div>
<div class="line">  <span class="keyword">typedef</span> std::shared_ptr&lt;chi_math::SpatialDiscretization&gt; <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a>;</div>
<div class="line">  <a class="code hl_typedef" href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">SDMPtr</a> sdm_ptr = <a class="code hl_function" href="../../d3/d53/classchi__math_1_1_spatial_discretization___p_w_l_d.html#a2c47f3d6e3faf4ac1d41f429f4839a0c">chi_math::SpatialDiscretization_PWLD::New</a>(grid_ptr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; sdm = *sdm_ptr;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; OneDofPerNode = sdm.UNITARY_UNKNOWN_MANAGER;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_nodes = sdm.GetNumLocalDOFs(OneDofPerNode);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_globl_nodes = sdm.GetNumGlobalDOFs(OneDofPerNode);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num local nodes: &quot;</span> &lt;&lt; num_local_nodes;</div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num globl nodes: &quot;</span> &lt;&lt; num_globl_nodes;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make an angular quadrature</span></div>
<div class="line">  std::shared_ptr&lt;chi_math::AngularQuadrature&gt; quadrature;</div>
<div class="line">  <span class="keywordflow">if</span> (dimension == 1)</div>
<div class="line">    quadrature = std::make_shared&lt;chi_math::AngularQuadratureProdGL&gt;(8);</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dimension == 2)</div>
<div class="line">  {</div>
<div class="line">    quadrature = std::make_shared&lt;chi_math::AngularQuadratureProdGLC&gt;(8,8);</div>
<div class="line">    quadrature-&gt;OptimizeForPolarSymmetry(4.0*M_PI);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dimension == 3)</div>
<div class="line">    quadrature = std::make_shared&lt;chi_math::AngularQuadratureProdGLC&gt;(8,8);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">throw</span> std::logic_error(fname + <span class="stringliteral">&quot;Error with the dimensionality &quot;</span></div>
<div class="line">                                   <span class="stringliteral">&quot;of the mesh.&quot;</span>);</div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Quadrature created.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Set/Get params</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> scat_order = 1;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_groups = 20;</div>
<div class="line"> </div>
<div class="line">  quadrature-&gt;BuildMomentToDiscreteOperator(scat_order,dimension);</div>
<div class="line">  quadrature-&gt;BuildDiscreteToMomentOperator(scat_order,dimension);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; m2d = quadrature-&gt;GetMomentToDiscreteOperator();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; d2m = quadrature-&gt;GetDiscreteToMomentOperator();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; m_ell_em_map = quadrature-&gt;GetMomentToHarmonicsIndexMap();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_moments = m_ell_em_map.size();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_dirs = quadrature-&gt;omegas.size();</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;End Set/Get params.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Num Moments: &quot;</span> &lt;&lt; num_moments &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make Unknown Managers</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> VecN = <a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1dad7dc5b5f08aa4bc980c2f7e92a9046d4">chi_math::UnknownType::VECTOR_N</a>;</div>
<div class="line">  <span class="keyword">using</span> Unknown = <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Unknown&gt; phi_uks(num_moments, Unknown(VecN, num_groups));</div>
<div class="line">  std::vector&lt;Unknown&gt; psi_uks(num_dirs,    Unknown(VecN, num_groups));</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_class" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a> phi_uk_man(phi_uks);</div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_class" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a> psi_uk_man(psi_uks);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_phi_dofs = sdm.GetNumLocalDOFs(phi_uk_man);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_local_psi_dofs = sdm.GetNumLocalDOFs(psi_uk_man);</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;End ukmanagers.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make XSs</span></div>
<div class="line">  chi_physics::TransportCrossSections xs;</div>
<div class="line">  xs.MakeFromCHIxsFile(<span class="stringliteral">&quot;tests/xs_graphite_pure.cxs&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Initializes vectors</span></div>
<div class="line">  std::vector&lt;double&gt; phi_old(num_local_phi_dofs,0.0);</div>
<div class="line">  std::vector&lt;double&gt; psi_old(num_local_psi_dofs, 0.0);</div>
<div class="line">  <span class="keyword">auto</span> source_moments = phi_old;</div>
<div class="line">  <span class="keyword">auto</span> phi_new        = phi_old;</div>
<div class="line">  <span class="keyword">auto</span> q_source       = phi_old;</div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;End vectors.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make material source term</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cc = cell.centroid;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cc.x &lt; 0.5 and cc.y &lt; 0.5 and cc.z &lt; 0.5 and</div>
<div class="line">        cc.x &gt;-0.5 and cc.y &gt;-0.5 and cc.z &gt;-0.5)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> int64_t dof_map = sdm.MapDOFLocal(cell,i,phi_uk_man,0,0);</div>
<div class="line"> </div>
<div class="line">        q_source[dof_map] = 1.0;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Precompute cell matrices</span></div>
<div class="line">  <span class="keyword">typedef</span> <a class="code hl_struct" href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a> Vec3;</div>
<div class="line">  <span class="keyword">typedef</span> std::vector&lt;Vec3&gt; <a class="code hl_typedef" href="../../d3/d84/namespacechi__math_1_1finite__element.html#a0ba0190f2fbe40827834634ca215f746">VecVec3</a>;</div>
<div class="line">  <span class="keyword">typedef</span> std::vector&lt;VecVec3&gt; <a class="code hl_typedef" href="../../d9/d42/namespacelbs.html#af2fc6b23dce5246308badbf79c2703cd">MatVec3</a>;</div>
<div class="line">  <span class="keyword">typedef</span> std::vector&lt;double&gt; <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a>;</div>
<div class="line">  <span class="keyword">typedef</span> std::vector&lt;VecDbl&gt; <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a>;</div>
<div class="line">  <span class="keyword">typedef</span> std::vector&lt;MatDbl&gt; VecMatDbl;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;MatVec3&gt;   cell_Gmatrices;</div>
<div class="line">  std::vector&lt;MatDbl&gt;    cell_Mmatrices;</div>
<div class="line">  std::vector&lt;VecMatDbl&gt; cell_faceMmatrices;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp;  cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes    = cell_mapping.NumNodes();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>   vol_qp_data  = cell_mapping.MakeVolumeQuadraturePointData();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_typedef" href="../../d9/d42/namespacelbs.html#af2fc6b23dce5246308badbf79c2703cd">MatVec3</a> IntV_shapeI_gradshapeJ(num_nodes, <a class="code hl_typedef" href="../../d3/d84/namespacechi__math_1_1finite__element.html#a0ba0190f2fbe40827834634ca215f746">VecVec3</a>(num_nodes,Vec3(0,0,0)));</div>
<div class="line">    <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a>  IntV_shapeI_shapeJ(num_nodes, <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a>(num_nodes,0.0));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; num_nodes; ++i)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; num_nodes; ++j)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; qp : vol_qp_data.QuadraturePointIndices())</div>
<div class="line">        {</div>
<div class="line">          IntV_shapeI_gradshapeJ[i][j]</div>
<div class="line">            += vol_qp_data.ShapeValue(i, qp) *</div>
<div class="line">               vol_qp_data.ShapeGrad(j, qp) *</div>
<div class="line">               vol_qp_data.JxW(qp);</div>
<div class="line"> </div>
<div class="line">          IntV_shapeI_shapeJ[i][j]</div>
<div class="line">            += vol_qp_data.ShapeValue(i, qp) *</div>
<div class="line">               vol_qp_data.ShapeValue(j, qp) *</div>
<div class="line">               vol_qp_data.JxW(qp);</div>
<div class="line">        }<span class="comment">// for qp</span></div>
<div class="line"> </div>
<div class="line">    cell_Gmatrices.push_back(std::move(IntV_shapeI_gradshapeJ));</div>
<div class="line">    cell_Mmatrices.push_back(std::move(IntV_shapeI_shapeJ));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_faces = cell.faces.size();</div>
<div class="line">    VecMatDbl faces_Mmatrices;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> f=0; f&lt;num_faces; ++f)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> face_qp_data = cell_mapping.MakeFaceQuadraturePointData(f);</div>
<div class="line">      <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a> IntS_shapeI_shapeJ(num_nodes,<a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a>(num_nodes,0.0));</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; num_nodes; ++i)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; num_nodes; ++j)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; qp : face_qp_data.QuadraturePointIndices())</div>
<div class="line">            IntS_shapeI_shapeJ[i][j]</div>
<div class="line">              += face_qp_data.ShapeValue(i, qp) *</div>
<div class="line">                 face_qp_data.ShapeValue(j, qp) *</div>
<div class="line">                 face_qp_data.JxW(qp);</div>
<div class="line"> </div>
<div class="line">      faces_Mmatrices.push_back(std::move(IntS_shapeI_shapeJ));</div>
<div class="line">    }<span class="comment">//for face f</span></div>
<div class="line"> </div>
<div class="line">    cell_faceMmatrices.push_back(std::move(faces_Mmatrices));</div>
<div class="line"> </div>
<div class="line">  }<span class="comment">//for cell</span></div>
<div class="line"> </div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;End cell matrices.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Make Grid internal face mapping</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> cell_adj_mapping = sdm.MakeInternalFaceNodeMappings();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Define sweep chunk</span></div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_class" href="../../d3/dfd/classchi__mesh_1_1sweep__management_1_1_sweep_chunk.html">SweepChunk</a> = [&amp;ijk_mapping, &amp;grid, &amp;sdm,</div>
<div class="line">                     &amp;num_moments,</div>
<div class="line">                     &amp;phi_uk_man, &amp;psi_uk_man,</div>
<div class="line">                     &amp;m2d,&amp;d2m,</div>
<div class="line">                     &amp;phi_new, &amp;source_moments, &amp;psi_old,</div>
<div class="line">                     &amp;cell_Gmatrices, &amp;cell_Mmatrices, &amp;cell_faceMmatrices,</div>
<div class="line">                     &amp;cell_adj_mapping]</div>
<div class="line">    (<span class="keyword">const</span> std::array&lt;int64_t,3&gt;&amp; ijk,</div>
<div class="line">     <span class="keyword">const</span> Vec3&amp; omega,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">size_t</span> d,</div>
<div class="line">     <span class="keyword">const</span> chi_physics::TransportCrossSections&amp; cell_xs)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> cell_global_id = ijk_mapping.MapNDtoLin(ijk[1],ijk[0],ijk[2]);</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell = grid.cells[cell_global_id];</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> cell_local_id = cell.local_id;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_faces = cell.faces.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; zero_vector(num_groups,0.0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; G = cell_Gmatrices[cell_local_id];</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; M = cell_Mmatrices[cell_local_id];</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a> A(num_nodes, <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a>(num_nodes, 0.0));</div>
<div class="line">    <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a> b(num_groups, <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a>(num_nodes, 0.0));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//================================= Gradient matrix</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; num_nodes; ++i)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; num_nodes; ++j)</div>
<div class="line">        A[i][j] = omega.Dot(G[i][j]);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//================================= Surface integrals</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> f=0; f&lt;num_faces; ++f)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; face = cell.faces[f];</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> mu = omega.Dot(face.normal);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (mu &lt; 0.0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; M_surf = cell_faceMmatrices[cell_local_id][f];</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_face_nodes = cell_mapping.NumFaceNodes(f);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> fi=0; fi&lt;num_face_nodes; ++fi)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">int</span> i = cell_mapping.MapFaceNode(f,fi);</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> fj=0; fj&lt;num_face_nodes; ++fj)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> j = cell_mapping.MapFaceNode(f,fj);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span>* upwind_psi = zero_vector.data();</div>
<div class="line">            <span class="keywordflow">if</span> (face.has_neighbor)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keyword">auto</span>&amp; adj_cell = grid.cells[face.neighbor_id];</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">int</span> aj = cell_adj_mapping[cell.local_id][f][fj];</div>
<div class="line">              <span class="keyword">const</span> int64_t ajmap = sdm.MapDOFLocal(adj_cell,aj,psi_uk_man,d,0);</div>
<div class="line">              upwind_psi = &amp;psi_old[ajmap];</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> mu_Nij = -mu * M_surf[i][j];</div>
<div class="line">            A[i][j] += mu_Nij;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> g=0; g&lt;num_groups; ++g)</div>
<div class="line">              b[g][i] += upwind_psi[g]*mu_Nij;</div>
<div class="line">          }<span class="comment">//for fj</span></div>
<div class="line">        }<span class="comment">//for fi</span></div>
<div class="line">      }<span class="comment">//if internal incident face</span></div>
<div class="line">    }<span class="comment">//for face</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> g=0; g&lt;num_groups; ++g)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">auto</span> Atemp = A;</div>
<div class="line">      <a class="code hl_typedef" href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a> source(num_nodes, 0.0);</div>
<div class="line">      <span class="comment">//Nodal source moments</span></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> temp_src = 0.0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> m=0; m&lt;num_moments; ++m)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> int64_t dof_map = sdm.MapDOFLocal(cell,i,phi_uk_man,m,g);</div>
<div class="line">          temp_src += m2d[m][d]*source_moments[dof_map];</div>
<div class="line">        }<span class="comment">//for m</span></div>
<div class="line">        source[i] = temp_src;</div>
<div class="line">      }<span class="comment">//for i</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="comment">//Mass Matrix and Source</span></div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> sigma_tg = cell_xs.sigma_t[g];</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_nodes; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> temp = 0.0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; num_nodes; ++j)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> Mij = M[i][j];</div>
<div class="line">          Atemp[i][j] = A[i][j] + Mij*sigma_tg;</div>
<div class="line">          temp += Mij*source[j];</div>
<div class="line">        }<span class="comment">//for j</span></div>
<div class="line">        b[g][i] += temp;</div>
<div class="line">      }<span class="comment">//for i</span></div>
<div class="line"> </div>
<div class="line">      <span class="comment">// ============================= Solve system</span></div>
<div class="line">      <a class="code hl_function" href="../../dc/d58/namespacechi__math.html#ac5008abb8163f2ed4c36a231352d42a8">chi_math::GaussElimination</a>(Atemp, b[g], <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(num_nodes));</div>
<div class="line">    }<span class="comment">//for g</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Accumulate flux-moments</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> m=0; m&lt;num_moments; ++m)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> wn_d2m = d2m[m][d];</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> int64_t dof_map = sdm.MapDOFLocal(cell,i,phi_uk_man,m,0);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> g=0; g&lt;num_groups; ++g)</div>
<div class="line">          phi_new[dof_map + g] += wn_d2m * b[g][i];</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Save angular fluxes</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> int64_t dof_map = sdm.MapDOFLocal(cell,i,psi_uk_man,d,0);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> g=0; g&lt;num_groups; ++g)</div>
<div class="line">        psi_old[dof_map + g] = b[g][i];</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Define sweep for all dirs</span></div>
<div class="line">  <span class="keyword">auto</span> Sweep = [&amp;num_dirs,&amp;quadrature,Nx,Ny,Nz,&amp;<a class="code hl_typedef" href="../../d9/df7/lbs_d_o__01__main__initialize_8cc.html#adfad77f405a91e0c24b4bed78523652d">SweepChunk</a>,&amp;xs]()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> d=0; d&lt;num_dirs; ++d)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> &amp;omega = quadrature-&gt;omegas[d];</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> &amp;weight = quadrature-&gt;weights[d];</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;int64_t&gt; iorder, jorder, korder;</div>
<div class="line">      <span class="keywordflow">if</span> (omega.x &gt; 0.0) iorder = chi_math::Range&lt;int64_t&gt;(0, Nx);</div>
<div class="line">      <span class="keywordflow">else</span>               iorder = chi_math::Range&lt;int64_t&gt;(Nx - 1, -1, -1);</div>
<div class="line">      <span class="keywordflow">if</span> (omega.y &gt; 0.0) jorder = chi_math::Range&lt;int64_t&gt;(0, Ny);</div>
<div class="line">      <span class="keywordflow">else</span>               jorder = chi_math::Range&lt;int64_t&gt;(Ny - 1, -1, -1);</div>
<div class="line">      <span class="keywordflow">if</span> (omega.z &gt; 0.0) korder = chi_math::Range&lt;int64_t&gt;(0, Nz);</div>
<div class="line">      <span class="keywordflow">else</span>               korder = chi_math::Range&lt;int64_t&gt;(Nz - 1, -1, -1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">auto</span> i: iorder)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> j: jorder)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">auto</span> k: korder)</div>
<div class="line">            <a class="code hl_typedef" href="../../d9/df7/lbs_d_o__01__main__initialize_8cc.html#adfad77f405a91e0c24b4bed78523652d">SweepChunk</a>({i,j,k}, omega, d, xs);</div>
<div class="line">    }<span class="comment">//for d</span></div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Define SetSource routine</span></div>
<div class="line">  <span class="keyword">auto</span> SetSource = [&amp;source_moments, &amp;phi_old, &amp;q_source, &amp;grid, &amp;sdm,</div>
<div class="line">                    &amp;m_ell_em_map, &amp;xs, num_moments,</div>
<div class="line">                    &amp;phi_uk_man]()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; S = xs.transfer_matrices;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> m=0; m&lt;num_moments; ++m)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> int64_t dof_map = sdm.MapDOFLocal(cell,i,phi_uk_man,m,0);</div>
<div class="line">          <span class="keyword">const</span> <span class="keyword">auto</span> ell = m_ell_em_map[m].ell;</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> g=0; g&lt;num_groups; ++g)</div>
<div class="line">          {</div>
<div class="line">            <span class="comment">//Fixed source</span></div>
<div class="line">            source_moments[dof_map + g] = q_source[dof_map + g];</div>
<div class="line"> </div>
<div class="line">            <span class="comment">//Inscattering</span></div>
<div class="line">            <span class="keywordflow">if</span> (ell &lt; S.size())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordtype">double</span> inscat_g = 0.0;</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [row_g, gprime, sigma_sm] : S[ell].Row(g))</div>
<div class="line">                inscat_g += sigma_sm * phi_old[dof_map + gprime];</div>
<div class="line"> </div>
<div class="line">              source_moments[dof_map + g] += inscat_g;</div>
<div class="line">            }</div>
<div class="line">          }<span class="comment">//for g</span></div>
<div class="line">        }<span class="comment">//for m</span></div>
<div class="line">      }<span class="comment">//for node i</span></div>
<div class="line">    }<span class="comment">//for cell</span></div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Define L-infinite-norm</span></div>
<div class="line">  <span class="keyword">auto</span> ComputeRelativePWChange = [&amp;grid,&amp;sdm,</div>
<div class="line">                                  &amp;num_moments,</div>
<div class="line">                                  &amp;phi_uk_man]</div>
<div class="line">    (<span class="keyword">const</span> std::vector&lt;double&gt;&amp; in_phi_new,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt;&amp; in_phi_old)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">double</span> pw_change = 0.0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell : grid.local_cells)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span>&amp; cell_mapping = sdm.GetCellMapping(cell);</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_nodes = cell_mapping.NumNodes();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;num_nodes; ++i)</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">//Get scalar moments</span></div>
<div class="line">        <span class="keyword">const</span> int64_t m0_map = sdm.MapDOFLocal(cell,i,phi_uk_man,0,0);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span>* phi_new_m0 = &amp;in_phi_new[m0_map];</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span>* phi_old_m0 = &amp;in_phi_old[m0_map];</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> m=0; m&lt;num_moments; ++m)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> int64_t m_map = sdm.MapDOFLocal(cell,i,phi_uk_man,m,0);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>* phi_new_m = &amp;in_phi_new[m_map];</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>* phi_old_m = &amp;in_phi_old[m_map];</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> g=0; g&lt;num_groups; ++g)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> abs_phi_new_g_m0 = std::fabs(phi_new_m0[g]);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> abs_phi_old_g_m0 = std::fabs(phi_old_m0[g]);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> max_denominator = std::max(abs_phi_new_g_m0,</div>
<div class="line">                                                    abs_phi_old_g_m0);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> delta_phi = std::fabs(phi_new_m[g] - phi_old_m[g]);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (max_denominator &gt;= std::numeric_limits&lt;double&gt;::min())</div>
<div class="line">              pw_change = std::max(delta_phi/max_denominator,pw_change);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              pw_change = std::max(delta_phi,pw_change);</div>
<div class="line">          }<span class="comment">//for g</span></div>
<div class="line">        }<span class="comment">//for m</span></div>
<div class="line">      }<span class="comment">//for i</span></div>
<div class="line">    }<span class="comment">//for cell</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> pw_change;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Classic Richardson iteration</span></div>
<div class="line">  chi::log.Log() &lt;&lt; <span class="stringliteral">&quot;Starting iterations&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iter=0; iter&lt;200; ++iter)</div>
<div class="line">  {</div>
<div class="line">    phi_new.assign(phi_new.size(), 0.0);</div>
<div class="line">    <span class="comment">//Build rhs</span></div>
<div class="line">    SetSource();</div>
<div class="line">    Sweep();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> rel_change = ComputeRelativePWChange(phi_new, phi_old);</div>
<div class="line"> </div>
<div class="line">    std::stringstream outstr;</div>
<div class="line">    outstr &lt;&lt; <span class="stringliteral">&quot;Iteration &quot;</span> &lt;&lt; std::setw(5) &lt;&lt; iter &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">char</span> buffer[100];</div>
<div class="line">      sprintf(buffer, <span class="stringliteral">&quot;%11.3e\n&quot;</span>, rel_change);</div>
<div class="line">      outstr &lt;&lt; buffer;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    chi::log.Log() &lt;&lt; outstr.str();</div>
<div class="line"> </div>
<div class="line">    phi_old = phi_new;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rel_change &lt; 1.0e-6 and iter &gt; 0)</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }<span class="comment">//for iteration</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Create Field Functions</span></div>
<div class="line">  std::vector&lt;std::shared_ptr&lt;chi_physics::FieldFunction&gt;&gt; ff_list;</div>
<div class="line"> </div>
<div class="line">  ff_list.push_back(std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;Phi&quot;</span>,                                           <span class="comment">//Text name</span></div>
<div class="line">    sdm_ptr,                                         <span class="comment">//Spatial Discr.</span></div>
<div class="line">    <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1dad7dc5b5f08aa4bc980c2f7e92a9046d4">chi_math::UnknownType::VECTOR_N</a>,num_groups) <span class="comment">//Unknown</span></div>
<div class="line">  ));</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;std::string&gt; dim_strings = {<span class="stringliteral">&quot;x&quot;</span>,<span class="stringliteral">&quot;y&quot;</span>,<span class="stringliteral">&quot;z&quot;</span>};</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> std::string&amp; dim : dim_strings)</div>
<div class="line">    ff_list.push_back(std::make_shared&lt;chi_physics::FieldFunction&gt;(</div>
<div class="line">      <span class="stringliteral">&quot;J-&quot;</span>+dim,                                        <span class="comment">//Text name</span></div>
<div class="line">      sdm_ptr,                                         <span class="comment">//Spatial Discr.</span></div>
<div class="line">      <a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1dad7dc5b5f08aa4bc980c2f7e92a9046d4">chi_math::UnknownType::VECTOR_N</a>,num_groups) <span class="comment">//Unknown</span></div>
<div class="line">    ));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Localize zeroth moment</span></div>
<div class="line">  <span class="comment">//This routine extracts a single moment vector</span></div>
<div class="line">  <span class="comment">//from the vector that contains multiple moments</span></div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_class" href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a> m0_uk_man(</div>
<div class="line">    {<a class="code hl_class" href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a>(<a class="code hl_enumvalue" href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1dad7dc5b5f08aa4bc980c2f7e92a9046d4">chi_math::UnknownType::VECTOR_N</a>,num_groups)});</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_m0_dofs = sdm.GetNumLocalDOFs(m0_uk_man);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; m0_phi(num_m0_dofs, 0.0);</div>
<div class="line">  std::vector&lt;double&gt; mx_phi(num_m0_dofs, 0.0); <span class="comment">//Y(1,1)  - X-component</span></div>
<div class="line">  std::vector&lt;double&gt; my_phi(num_m0_dofs, 0.0); <span class="comment">//Y(1,-1) - Y-component</span></div>
<div class="line">  std::vector&lt;double&gt; mz_phi(num_m0_dofs, 0.0); <span class="comment">//Y(1,0)  - Z-component</span></div>
<div class="line"> </div>
<div class="line">  sdm.CopyVectorWithUnknownScope(phi_old,     <span class="comment">//from vector</span></div>
<div class="line">                                 m0_phi,      <span class="comment">//to vector</span></div>
<div class="line">                                 phi_uk_man,  <span class="comment">//from dof-structure</span></div>
<div class="line">                                 0,           <span class="comment">//from unknown-id</span></div>
<div class="line">                                 m0_uk_man,   <span class="comment">//to dof-structure</span></div>
<div class="line">                                 0);          <span class="comment">//to unknown-id</span></div>
<div class="line"> </div>
<div class="line">  ff_list[0]-&gt;UpdateFieldVector(m0_phi);</div>
<div class="line"> </div>
<div class="line">  std::array&lt;unsigned int,3&gt; j_map = {0,0,0};</div>
<div class="line">  <span class="keywordflow">if</span> (dimension == 1 and num_moments &gt;= 2) j_map = {0,0,1};</div>
<div class="line">  <span class="keywordflow">if</span> (dimension == 2 and num_moments &gt;= 3) j_map = {2,1,0};</div>
<div class="line">  <span class="keywordflow">if</span> (dimension == 3 and num_moments &gt;= 4) j_map = {3,1,2};</div>
<div class="line"> </div>
<div class="line">  sdm.CopyVectorWithUnknownScope(</div>
<div class="line">    phi_old, mx_phi, phi_uk_man, j_map[0], m0_uk_man, 0);</div>
<div class="line">  sdm.CopyVectorWithUnknownScope(</div>
<div class="line">    phi_old, my_phi, phi_uk_man, j_map[1], m0_uk_man, 0);</div>
<div class="line">  sdm.CopyVectorWithUnknownScope(</div>
<div class="line">    phi_old, mz_phi, phi_uk_man, j_map[2], m0_uk_man, 0);</div>
<div class="line"> </div>
<div class="line">  ff_list[1]-&gt;UpdateFieldVector(mx_phi);</div>
<div class="line">  ff_list[2]-&gt;UpdateFieldVector(my_phi);</div>
<div class="line">  ff_list[3]-&gt;UpdateFieldVector(mz_phi);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">//============================================= Update field function</span></div>
<div class="line">  chi_physics::FieldFunction::FFList const_ff_list;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; ff_ptr : ff_list)</div>
<div class="line">    const_ff_list.push_back(ff_ptr);</div>
<div class="line">  chi_physics::FieldFunction::ExportMultipleToVTK(<span class="stringliteral">&quot;SimTest_91a_PWLD&quot;</span>,</div>
<div class="line">                                                   const_ff_list);</div>
<div class="line"> </div>
<div class="line">  chi::Finalize();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="achi__console_8h_html"><div class="ttname"><a href="../../d2/d6d/chi__console_8h.html">chi_console.h</a></div></div>
<div class="ttc" id="achi__log_8h_html"><div class="ttname"><a href="../../dc/d75/chi__log_8h.html">chi_log.h</a></div></div>
<div class="ttc" id="achi__math_8h_html_a80801c4491f8f4ff54ed012d63d0d48b"><div class="ttname"><a href="../../d2/d08/chi__math_8h.html#a80801c4491f8f4ff54ed012d63d0d48b">MatDbl</a></div><div class="ttdeci">std::vector&lt; VecDbl &gt; MatDbl</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d08/chi__math_8h_source.html#l00013">chi_math.h:13</a></div></div>
<div class="ttc" id="achi__math_8h_html_acbe69520b2db91355c5ed8d97a218b94"><div class="ttname"><a href="../../d2/d08/chi__math_8h.html#acbe69520b2db91355c5ed8d97a218b94">VecDbl</a></div><div class="ttdeci">std::vector&lt; double &gt; VecDbl</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d08/chi__math_8h_source.html#l00012">chi_math.h:12</a></div></div>
<div class="ttc" id="achi__meshhandler_8h_html"><div class="ttname"><a href="../../df/d98/chi__meshhandler_8h.html">chi_meshhandler.h</a></div></div>
<div class="ttc" id="achi__runtime_8h_html"><div class="ttname"><a href="../../d3/db2/chi__runtime_8h.html">chi_runtime.h</a></div></div>
<div class="ttc" id="achi__tech__main_8cc_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="../../d4/dca/chi__tech__main_8cc.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="../../d4/dca/chi__tech__main_8cc_source.html#l00010">chi_tech_main.cc:10</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_spatial_discretization___p_w_l_d_html_a2c47f3d6e3faf4ac1d41f429f4839a0c"><div class="ttname"><a href="../../d3/d53/classchi__math_1_1_spatial_discretization___p_w_l_d.html#a2c47f3d6e3faf4ac1d41f429f4839a0c">chi_math::SpatialDiscretization_PWLD::New</a></div><div class="ttdeci">static std::shared_ptr&lt; SpatialDiscretization_PWLD &gt; New(const chi_mesh::MeshContinuum &amp;in_grid, finite_element::SetupFlags setup_flags=finite_element::NO_FLAGS_SET, QuadratureOrder qorder=QuadratureOrder::SECOND, CoordinateSystemType in_cs_type=CoordinateSystemType::CARTESIAN)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dad/pwl__00__constrdestr_8cc_source.html#l00086">pwl_00_constrdestr.cc:86</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_unknown_html"><div class="ttname"><a href="../../d8/df3/classchi__math_1_1_unknown.html">chi_math::Unknown</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3b/unknown__manager_8h_source.html#l00031">unknown_manager.h:32</a></div></div>
<div class="ttc" id="aclasschi__math_1_1_unknown_manager_html"><div class="ttname"><a href="../../d9/da7/classchi__math_1_1_unknown_manager.html">chi_math::UnknownManager</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d3b/unknown__manager_8h_source.html#l00122">unknown_manager.h:123</a></div></div>
<div class="ttc" id="aclasschi__mesh_1_1_mesh_handler_html_aa87887c1a76634cb07134b5faa1e3587"><div class="ttname"><a href="../../d2/d10/classchi__mesh_1_1_mesh_handler.html#aa87887c1a76634cb07134b5faa1e3587">chi_mesh::MeshHandler::GetGrid</a></div><div class="ttdeci">chi_mesh::MeshContinuumPtr &amp; GetGrid() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d65/chi__meshhandler_8cc_source.html#l00012">chi_meshhandler.cc:12</a></div></div>
<div class="ttc" id="aclasschi__mesh_1_1sweep__management_1_1_sweep_chunk_html"><div class="ttname"><a href="../../d3/dfd/classchi__mesh_1_1sweep__management_1_1_sweep_chunk.html">chi_mesh::sweep_management::SweepChunk</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc1/sweepchunk__base_8h_source.html#l00010">sweepchunk_base.h:11</a></div></div>
<div class="ttc" id="albs_d_o__01__main__initialize_8cc_html_adfad77f405a91e0c24b4bed78523652d"><div class="ttname"><a href="../../d9/df7/lbs_d_o__01__main__initialize_8cc.html#adfad77f405a91e0c24b4bed78523652d">SweepChunk</a></div><div class="ttdeci">chi_mesh::sweep_management::SweepChunk SweepChunk</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/df7/lbs_d_o__01__main__initialize_8cc_source.html#l00010">lbsDO_01_main_initialize.cc:10</a></div></div>
<div class="ttc" id="anamespacechi__math_1_1finite__element_html_a0ba0190f2fbe40827834634ca215f746"><div class="ttname"><a href="../../d3/d84/namespacechi__math_1_1finite__element.html#a0ba0190f2fbe40827834634ca215f746">chi_math::finite_element::VecVec3</a></div><div class="ttdeci">std::vector&lt; chi_mesh::Vector3 &gt; VecVec3</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d00/finite__element_8h_source.html#l00008">finite_element.h:8</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ab6754b3179f7dbf965932210273fead7"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ab6754b3179f7dbf965932210273fead7">chi_math::SDMPtr</a></div><div class="ttdeci">std::shared_ptr&lt; SpatialDiscretization &gt; SDMPtr</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d72/fieldfunction__gridbased_8h_source.html#l00020">fieldfunction_gridbased.h:19</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ac5008abb8163f2ed4c36a231352d42a8"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ac5008abb8163f2ed4c36a231352d42a8">chi_math::GaussElimination</a></div><div class="ttdeci">void GaussElimination(MatDbl &amp;A, VecDbl &amp;b, int n)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d6a/chi__math__02__matrix__operations_8cc_source.html#l00286">chi_math_02_matrix_operations.cc:286</a></div></div>
<div class="ttc" id="anamespacechi__math_html_ad4724873fa5ae74b39c4657aa4f53d1dad7dc5b5f08aa4bc980c2f7e92a9046d4"><div class="ttname"><a href="../../dc/d58/namespacechi__math.html#ad4724873fa5ae74b39c4657aa4f53d1dad7dc5b5f08aa4bc980c2f7e92a9046d4">chi_math::UnknownType::VECTOR_N</a></div><div class="ttdeci">@ VECTOR_N</div></div>
<div class="ttc" id="anamespacechi__mesh_html_ad98d4e91589e7fa4e04bd70274068362a73bd95bf58ed2c1cd1ef2f4257fc3975"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#ad98d4e91589e7fa4e04bd70274068362a73bd95bf58ed2c1cd1ef2f4257fc3975">chi_mesh::DIMENSION_1</a></div><div class="ttdeci">@ DIMENSION_1</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dcb/chi__mesh_8h_source.html#l00072">chi_mesh.h:72</a></div></div>
<div class="ttc" id="anamespacechi__mesh_html_ad98d4e91589e7fa4e04bd70274068362ac5d5534358879a033391a7c43407a246"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#ad98d4e91589e7fa4e04bd70274068362ac5d5534358879a033391a7c43407a246">chi_mesh::DIMENSION_2</a></div><div class="ttdeci">@ DIMENSION_2</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dcb/chi__mesh_8h_source.html#l00073">chi_mesh.h:73</a></div></div>
<div class="ttc" id="anamespacechi__mesh_html_ad98d4e91589e7fa4e04bd70274068362af15b5a9461f9a446c9117b100d8e11f2"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#ad98d4e91589e7fa4e04bd70274068362af15b5a9461f9a446c9117b100d8e11f2">chi_mesh::DIMENSION_3</a></div><div class="ttdeci">@ DIMENSION_3</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dcb/chi__mesh_8h_source.html#l00074">chi_mesh.h:74</a></div></div>
<div class="ttc" id="anamespacechi__mesh_html_addcd6899961d4c527b02c33708a7941f"><div class="ttname"><a href="../../d0/d81/namespacechi__mesh.html#addcd6899961d4c527b02c33708a7941f">chi_mesh::GetCurrentHandler</a></div><div class="ttdeci">MeshHandler &amp; GetCurrentHandler()</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d4b/chi__mesh__meshhandler__utils_8cc_source.html#l00013">chi_mesh_meshhandler_utils.cc:13</a></div></div>
<div class="ttc" id="anamespacelbs_html_af2fc6b23dce5246308badbf79c2703cd"><div class="ttname"><a href="../../d9/d42/namespacelbs.html#af2fc6b23dce5246308badbf79c2703cd">lbs::MatVec3</a></div><div class="ttdeci">std::vector&lt; VecVec3 &gt; MatVec3</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/dc3/lbs__structs_8h_source.html#l00021">lbs_structs.h:21</a></div></div>
<div class="ttc" id="apetsc__utils_8h_html"><div class="ttname"><a href="../../da/d0e/petsc__utils_8h.html">petsc_utils.h</a></div></div>
<div class="ttc" id="apwlc_8h_html"><div class="ttname"><a href="../../d3/dfa/pwlc_8h.html">pwlc.h</a></div></div>
<div class="ttc" id="astructchi__mesh_1_1_vector3_html"><div class="ttname"><a href="../../dd/d54/structchi__mesh_1_1_vector3.html">chi_mesh::Vector3</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7f/chi__meshvector_8h_source.html#l00018">chi_meshvector.h:19</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Chi-Tech</a></li><li class="navelem"><a class="el" href="../../d7/db6/_programmer_manual.html">Developer&#39;s manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
